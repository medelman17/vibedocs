---
phase: 03-document-extraction
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - lib/document-extraction/extract-document.ts
  - lib/document-extraction/index.ts
  - lib/document-processing.ts
autonomous: true

must_haves:
  truths:
    - "extractDocument unifies PDF and DOCX extraction with consistent interface"
    - "Encrypted PDFs return clear error message to user"
    - "Documents with <100 chars return OcrRequiredError"
    - "Non-English documents return ValidationError with clear message"
    - "Quality metrics logged for every extraction"
  artifacts:
    - path: "lib/document-extraction/extract-document.ts"
      provides: "Unified extraction entry point"
      exports: ["extractDocument"]
    - path: "lib/document-processing.ts"
      provides: "Backward-compatible extractText using new extractors"
      exports: ["extractText"]
  key_links:
    - from: "lib/document-extraction/extract-document.ts"
      to: "lib/document-extraction/pdf-extractor.ts"
      via: "import"
      pattern: "extractPdf"
    - from: "lib/document-extraction/extract-document.ts"
      to: "lib/document-extraction/docx-extractor.ts"
      via: "import"
      pattern: "extractDocx"
    - from: "lib/document-processing.ts"
      to: "lib/document-extraction"
      via: "import"
      pattern: "from '@/lib/document-extraction'"
---

<objective>
Create unified extraction entry point with validation flow and update existing code for backward compatibility.

Purpose: Provide single extractDocument() function that handles all MIME types, applies validation gates (language, quality), and returns structured ExtractionResult. Update existing extractText() for backward compatibility.

Output:
- Unified extractDocument() function with validation flow
- Updated extractText() in lib/document-processing.ts using new extractors
- Quality logging for observability
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-document-extraction/03-RESEARCH.md
@.planning/phases/03-document-extraction/03-01-PLAN.md

# Existing code to update
@lib/document-processing.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unified extractDocument function</name>
  <files>lib/document-extraction/extract-document.ts</files>
  <action>
Create lib/document-extraction/extract-document.ts:

```typescript
/**
 * @fileoverview Unified document extraction entry point
 *
 * Single function for extracting text from PDF, DOCX, or plain text
 * with validation gates (language, quality) and structured output.
 *
 * @module lib/document-extraction/extract-document
 */

import { ValidationError, OcrRequiredError } from '@/lib/errors'
import { extractPdf } from './pdf-extractor'
import { extractDocx } from './docx-extractor'
import { detectLanguage, validateExtractionQuality } from './validators'
import type { ExtractionResult, ExtractionWarning } from './types'

// ============================================================================
// Types
// ============================================================================

export interface ExtractDocumentOptions {
  /** File size in bytes for quality metrics */
  fileSize?: number
  /** Skip language validation (for testing) */
  skipLanguageCheck?: boolean
  /** Skip OCR routing (return result with requiresOcr flag instead of throwing) */
  skipOcrRouting?: boolean
}

// ============================================================================
// Main Extraction Function
// ============================================================================

/**
 * Extracts text from document buffer with validation.
 *
 * Validation flow:
 * 1. Format detection and raw extraction
 * 2. Quality validation (OCR detection)
 * 3. Language detection (English-only)
 * 4. Return structured result with metrics
 *
 * Per CONTEXT.md:
 * - Block non-English documents with clear message
 * - <100 chars auto-route to OCR (Phase 4)
 * - Log detailed quality metrics for every extraction
 *
 * @throws EncryptedDocumentError - Password-protected PDF
 * @throws CorruptDocumentError - Invalid or corrupt file
 * @throws OcrRequiredError - Document needs OCR processing
 * @throws ValidationError - Non-English document
 */
export async function extractDocument(
  buffer: Buffer,
  mimeType: string,
  options: ExtractDocumentOptions = {}
): Promise<ExtractionResult> {
  const { fileSize = buffer.length, skipLanguageCheck = false, skipOcrRouting = false } = options

  // 1. Extract based on MIME type
  let result: ExtractionResult

  switch (mimeType) {
    case 'application/pdf':
      result = await extractPdf(buffer, fileSize)
      break

    case 'application/vnd.openxmlformats-officedocument.wordprocessingml.document':
      result = await extractDocx(buffer, fileSize)
      break

    case 'text/plain':
      result = extractPlainText(buffer, fileSize)
      break

    default:
      throw new ValidationError(`Unsupported file type: ${mimeType}`)
  }

  // 2. Check for OCR requirement
  if (result.quality.requiresOcr && !skipOcrRouting) {
    // Log for observability before throwing
    logExtractionMetrics(mimeType, result, 'ocr_required')
    throw new OcrRequiredError()
  }

  // 3. Language validation (English-only per CONTEXT.md)
  if (!skipLanguageCheck && result.text.length > 100) {
    const lang = detectLanguage(result.text)

    if (!lang.isEnglish) {
      // Log for observability before throwing
      logExtractionMetrics(mimeType, result, 'non_english')
      throw new ValidationError(
        'This document appears to be in a non-English language. Analysis is optimized for English documents.'
      )
    }

    // Add warning if low confidence in English detection
    if (lang.confidence < 0.7) {
      result.quality.warnings.push({
        type: 'non_english',
        message: `Document may contain non-English text (confidence: ${(lang.confidence * 100).toFixed(0)}%)`,
      })
    }
  }

  // 4. Log metrics for observability
  logExtractionMetrics(mimeType, result, 'success')

  return result
}

// ============================================================================
// Plain Text Extraction
// ============================================================================

/**
 * Extracts text from plain text buffer.
 */
function extractPlainText(buffer: Buffer, fileSize: number): ExtractionResult {
  const text = buffer.toString('utf-8').normalize('NFC')
  const quality = validateExtractionQuality(text, fileSize)

  return {
    text,
    quality,
    pageCount: 1,
    metadata: {},
  }
}

// ============================================================================
// Logging
// ============================================================================

/**
 * Logs extraction metrics for observability.
 * Per CONTEXT.md: Log detailed quality metrics for every extraction.
 */
function logExtractionMetrics(
  mimeType: string,
  result: ExtractionResult,
  outcome: 'success' | 'ocr_required' | 'non_english'
): void {
  const metrics = {
    mimeType,
    outcome,
    charCount: result.quality.charCount,
    wordCount: result.quality.wordCount,
    pageCount: result.pageCount,
    confidence: result.quality.confidence,
    requiresOcr: result.quality.requiresOcr,
    warningCount: result.quality.warnings.length,
    warnings: result.quality.warnings.map(w => w.type),
    hasTitle: !!result.metadata.title,
    hasAuthor: !!result.metadata.author,
  }

  // Use console for now, can be replaced with structured logging
  console.log('[extraction]', JSON.stringify(metrics))
}
```
  </action>
  <verify>
TypeScript compiles: `pnpm tsc --noEmit 2>&1 | head -20`
Function exists: `grep "export async function extractDocument" lib/document-extraction/extract-document.ts`
  </verify>
  <done>Unified extractDocument with validation flow and logging</done>
</task>

<task type="auto">
  <name>Task 2: Update barrel export</name>
  <files>lib/document-extraction/index.ts</files>
  <action>
Update lib/document-extraction/index.ts to add extractDocument:

Add after the existing exports:

```typescript
// Unified extraction
export { extractDocument, type ExtractDocumentOptions } from './extract-document'
```

The full file should now export:
- Types: ExtractionResult, QualityMetrics, ExtractionWarning, DocumentMetadata, DocumentStructure, etc.
- Extractors: extractPdf, extractDocx
- Validators: validateExtractionQuality, detectLanguage
- Structure: detectStructure, parseObviousStructure
- Unified: extractDocument
  </action>
  <verify>
TypeScript compiles: `pnpm tsc --noEmit 2>&1 | head -20`
Export count: `grep -c "^export" lib/document-extraction/index.ts` (should be ~18)
  </verify>
  <done>Barrel export includes extractDocument</done>
</task>

<task type="auto">
  <name>Task 3: Update lib/document-processing.ts for backward compatibility</name>
  <files>lib/document-processing.ts</files>
  <action>
Update lib/document-processing.ts to use new extractors while maintaining backward compatibility.

Replace the extractText function implementation:

```typescript
import { PDFParse } from 'pdf-parse'
import mammoth from 'mammoth'
```

becomes:

```typescript
// Legacy imports removed - now using lib/document-extraction
import { extractPdf, extractDocx } from '@/lib/document-extraction'
```

And update the extractText function:

```typescript
/**
 * Extracts text from a document buffer based on MIME type.
 * Supports PDF, DOCX, and plain text.
 *
 * @deprecated Use extractDocument from lib/document-extraction for richer output
 */
export async function extractText(
  buffer: Buffer,
  mimeType: string
): Promise<ExtractionResult> {
  switch (mimeType) {
    case 'application/pdf': {
      const result = await extractPdf(buffer)
      return { text: result.text, pageCount: result.pageCount }
    }
    case 'application/vnd.openxmlformats-officedocument.wordprocessingml.document': {
      const result = await extractDocx(buffer)
      return { text: result.text, pageCount: result.pageCount }
    }
    case 'text/plain':
    default:
      return { text: buffer.toString('utf-8'), pageCount: 1 }
  }
}
```

Keep the chunkDocument function and other exports unchanged.

The file should:
1. Remove direct pdf-parse and mammoth imports
2. Import extractPdf, extractDocx from new module
3. Keep ExtractionResult interface (it's simpler than the new one)
4. Keep chunkDocument and related functions unchanged
  </action>
  <verify>
TypeScript compiles: `pnpm tsc --noEmit 2>&1 | head -20`
No direct pdf-parse import: `grep -c "from 'pdf-parse'" lib/document-processing.ts` (should be 0)
Uses new extractors: `grep "from '@/lib/document-extraction'" lib/document-processing.ts`
  </verify>
  <done>document-processing.ts uses new extractors, maintains backward compatibility</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. extractDocument handles PDF, DOCX, and plain text
3. OcrRequiredError thrown when text < 100 chars
4. ValidationError thrown for non-English documents
5. Quality metrics logged with structured JSON
6. extractText still works for existing callers
7. Tests pass: `pnpm test -- lib/document-processing`
</verification>

<success_criteria>
- extractDocument validates language and quality
- Encrypted/corrupt files throw appropriate errors
- Documents needing OCR throw OcrRequiredError
- Non-English documents throw ValidationError
- Metrics logged for every extraction
- Backward compatibility maintained
</success_criteria>

<output>
After completion, create `.planning/phases/03-document-extraction/03-03-SUMMARY.md`
</output>
