---
phase: 03-document-extraction
plan: 05
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/(word-addin)/word-addin/taskpane/hooks/useDocumentContent.ts
  - app/(word-addin)/word-addin/taskpane/hooks/mockDocumentContent.ts
  - app/api/word-addin/analyze/route.ts
autonomous: true

must_haves:
  truths:
    - "Word Add-in extracts document with paragraph styles and outline levels"
    - "Word Add-in passes document properties (title, author) to API"
    - "API validates content hash for deduplication"
    - "Content hash checked against existing analyses to avoid re-processing"
    - "Mock content includes realistic NDA structure for testing"
  artifacts:
    - path: "app/(word-addin)/word-addin/taskpane/hooks/useDocumentContent.ts"
      provides: "Enhanced document extraction with metadata"
      exports: ["useDocumentContent", "DocumentContent"]
    - path: "app/api/word-addin/analyze/route.ts"
      provides: "Analysis submission with deduplication"
      exports: ["POST"]
  key_links:
    - from: "app/(word-addin)/word-addin/taskpane/hooks/useDocumentContent.ts"
      to: "Office.js Word API"
      via: "Word.run"
      pattern: "Word\\.run"
    - from: "app/api/word-addin/analyze/route.ts"
      to: "db/schema/documents"
      via: "contentHash query"
      pattern: "contentHash"
---

<objective>
Enhance Word Add-in document extraction with richer metadata and deduplication support.

Purpose: Extract structured content from Word documents via Office.js including paragraph styles and outline levels. Add document property extraction for metadata. Implement content hash deduplication to avoid re-analyzing identical documents.

Output:
- Enhanced useDocumentContent hook with metadata extraction
- Updated API with content hash deduplication check
- Improved mock content with realistic NDA structure
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-document-extraction/03-CONTEXT.md
@.planning/phases/03-document-extraction/03-RESEARCH.md

# Existing code
@app/(word-addin)/word-addin/taskpane/hooks/useDocumentContent.ts
@app/(word-addin)/word-addin/taskpane/hooks/mockDocumentContent.ts
@app/api/word-addin/analyze/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance useDocumentContent hook with metadata</name>
  <files>app/(word-addin)/word-addin/taskpane/hooks/useDocumentContent.ts, app/(word-addin)/word-addin/taskpane/hooks/mockDocumentContent.ts</files>
  <action>
Update the DocumentContent and Paragraph types in mockDocumentContent.ts:

```typescript
export interface Paragraph {
  text: string
  style: string
  isHeading: boolean
  /** Outline level for headings (0 = body text, 1-9 = heading levels) */
  outlineLevel: number
}

export interface DocumentContent {
  fullText: string
  paragraphs: Paragraph[]
  title: string
  /** Document properties from Word */
  properties: {
    author?: string
    creationDate?: Date
    lastModifiedBy?: string
    lastModified?: Date
    /** Word version for debugging */
    wordVersion?: string
  }
}

// Update MOCK_NDA_CONTENT to include outlineLevel and properties
export const MOCK_NDA_CONTENT: DocumentContent = {
  fullText: `NON-DISCLOSURE AGREEMENT

This Non-Disclosure Agreement ("Agreement") is entered into as of January 15, 2026...

ARTICLE I - DEFINITIONS
1.1 "Confidential Information" means...
1.2 "Disclosing Party" means...
1.3 "Receiving Party" means...

ARTICLE II - OBLIGATIONS
2.1 Non-Disclosure. The Receiving Party shall...
2.2 Permitted Use. The Receiving Party may use...
2.3 Exclusions. Confidential Information shall not include...

ARTICLE III - TERM AND TERMINATION
3.1 Term. This Agreement shall remain in effect for...
3.2 Survival. The obligations of confidentiality shall survive...

ARTICLE IV - MISCELLANEOUS
4.1 Governing Law. This Agreement shall be governed by...
4.2 Entire Agreement. This Agreement constitutes...

IN WITNESS WHEREOF, the parties have executed this Agreement as of the date first written above.

ACME Corporation
By: _______________
Name: John Smith
Title: CEO

Beta Industries, Inc.
By: _______________
Name: Jane Doe
Title: General Counsel`,

  paragraphs: [
    { text: "NON-DISCLOSURE AGREEMENT", style: "Title", isHeading: true, outlineLevel: 0 },
    { text: "This Non-Disclosure Agreement...", style: "Normal", isHeading: false, outlineLevel: 0 },
    { text: "ARTICLE I - DEFINITIONS", style: "Heading 1", isHeading: true, outlineLevel: 1 },
    { text: '1.1 "Confidential Information" means...', style: "Normal", isHeading: false, outlineLevel: 0 },
    { text: '1.2 "Disclosing Party" means...', style: "Normal", isHeading: false, outlineLevel: 0 },
    { text: '1.3 "Receiving Party" means...', style: "Normal", isHeading: false, outlineLevel: 0 },
    { text: "ARTICLE II - OBLIGATIONS", style: "Heading 1", isHeading: true, outlineLevel: 1 },
    { text: "2.1 Non-Disclosure. The Receiving Party shall...", style: "Normal", isHeading: false, outlineLevel: 0 },
    { text: "2.2 Permitted Use. The Receiving Party may use...", style: "Normal", isHeading: false, outlineLevel: 0 },
    { text: "2.3 Exclusions. Confidential Information shall not include...", style: "Normal", isHeading: false, outlineLevel: 0 },
    { text: "ARTICLE III - TERM AND TERMINATION", style: "Heading 1", isHeading: true, outlineLevel: 1 },
    { text: "3.1 Term. This Agreement shall remain in effect for...", style: "Normal", isHeading: false, outlineLevel: 0 },
    { text: "3.2 Survival. The obligations of confidentiality shall survive...", style: "Normal", isHeading: false, outlineLevel: 0 },
    { text: "ARTICLE IV - MISCELLANEOUS", style: "Heading 1", isHeading: true, outlineLevel: 1 },
    { text: "4.1 Governing Law. This Agreement shall be governed by...", style: "Normal", isHeading: false, outlineLevel: 0 },
    { text: "4.2 Entire Agreement. This Agreement constitutes...", style: "Normal", isHeading: false, outlineLevel: 0 },
    { text: "IN WITNESS WHEREOF...", style: "Normal", isHeading: false, outlineLevel: 0 },
  ],
  title: "Non-Disclosure Agreement",
  properties: {
    author: "Legal Department",
    creationDate: new Date("2026-01-15"),
    lastModifiedBy: "John Smith",
    lastModified: new Date("2026-01-20"),
    wordVersion: "Mock Dev Mode",
  },
}
```

Then update useDocumentContent.ts to extract properties:

```typescript
const extractContent = useCallback(async (): Promise<DocumentContent> => {
  // ... dev mode handling unchanged ...

  try {
    const content = await Word.run(async (context) => {
      const body = context.document.body
      const paragraphs = body.paragraphs
      const properties = context.document.properties

      // Load document properties for metadata
      properties.load("title, author, creationDateTime, lastAuthor, lastSaveTime")
      body.load("text")
      paragraphs.load("items")
      await context.sync()

      // Load each paragraph's details including outlineLevel
      const structuredParagraphs: Paragraph[] = []
      for (const para of paragraphs.items) {
        para.load("text, style, outlineLevel")
      }
      await context.sync()

      for (const para of paragraphs.items) {
        structuredParagraphs.push({
          text: para.text,
          style: para.style || "Normal",
          isHeading: para.style?.startsWith("Heading") ?? false,
          outlineLevel: para.outlineLevel ?? 0,
        })
      }

      return {
        fullText: body.text,
        paragraphs: structuredParagraphs,
        title: properties.title || "Untitled Document",
        properties: {
          author: properties.author || undefined,
          creationDate: properties.creationDateTime || undefined,
          lastModifiedBy: properties.lastAuthor || undefined,
          lastModified: properties.lastSaveTime || undefined,
          wordVersion: Office.context.diagnostics?.version || undefined,
        },
      }
    })

    setIsExtracting(false)
    return content
  } catch (err) {
    // ... error handling unchanged ...
  }
}, [isDevMode])
```
  </action>
  <verify>
TypeScript compiles: `pnpm tsc --noEmit 2>&1 | head -20`
Has outlineLevel: `grep "outlineLevel" app/(word-addin)/word-addin/taskpane/hooks/useDocumentContent.ts`
  </verify>
  <done>Document content hook extracts full paragraph metadata and properties</done>
</task>

<task type="auto">
  <name>Task 2: Add deduplication check to analyze route</name>
  <files>app/api/word-addin/analyze/route.ts</files>
  <action>
Update app/api/word-addin/analyze/route.ts to check for existing analysis with same content hash:

1. Add import for eq from drizzle-orm (if not present):
```typescript
import { eq, and } from "drizzle-orm"
```

2. Update the schema to include properties:
```typescript
const analyzeRequestSchema = z.object({
  content: z.string().min(1, "Document content is required"),
  paragraphs: z.array(paragraphSchema).optional(),
  metadata: z
    .object({
      title: z.string().optional(),
      source: z.literal("word-addin").default("word-addin"),
    })
    .optional(),
  /** Document properties from Word */
  properties: z
    .object({
      author: z.string().optional(),
      creationDate: z.string().optional(), // ISO string
      lastModifiedBy: z.string().optional(),
      lastModified: z.string().optional(), // ISO string
      wordVersion: z.string().optional(),
    })
    .optional(),
})
```

3. After computing contentHash, check for existing analysis:
```typescript
// Compute content hash for duplicate detection
const contentHash = computeContentHash(content)

// Check for existing analysis with same content
const existingDoc = await db.query.documents.findFirst({
  where: and(
    eq(documents.tenantId, tenantId),
    eq(documents.contentHash, contentHash)
  ),
  with: {
    analyses: {
      orderBy: (analyses, { desc }) => [desc(analyses.createdAt)],
      limit: 1,
    },
  },
})

// If document exists with completed analysis, return existing results
if (existingDoc?.analyses?.[0]?.status === "completed") {
  return success({
    analysisId: existingDoc.analyses[0].id,
    documentId: existingDoc.id,
    status: "existing",
    message: "Document was previously analyzed. Returning existing results.",
  })
}

// If document exists but analysis is pending/failed, check if we should re-analyze
if (existingDoc?.analyses?.[0]) {
  const lastAnalysis = existingDoc.analyses[0]
  if (lastAnalysis.status === "pending" || lastAnalysis.status === "processing") {
    return success({
      analysisId: lastAnalysis.id,
      documentId: existingDoc.id,
      status: "in_progress",
      message: "Document analysis is already in progress.",
    })
  }
  // Failed analysis - fall through to create new one
}
```

4. Include properties in document metadata:
```typescript
metadata: {
  source: "word-addin",
  paragraphCount: paragraphs?.length ?? 0,
  paragraphs: paragraphs ?? [],
  wordProperties: properties ?? {},
},
```
  </action>
  <verify>
TypeScript compiles: `pnpm tsc --noEmit 2>&1 | head -20`
Has dedup check: `grep "existingDoc" app/api/word-addin/analyze/route.ts`
Has properties schema: `grep "wordVersion" app/api/word-addin/analyze/route.ts`
  </verify>
  <done>API checks content hash before creating new analysis</done>
</task>

<task type="auto">
  <name>Task 3: Update analyze route to include properties in Inngest event</name>
  <files>app/api/word-addin/analyze/route.ts</files>
  <action>
Update the Inngest event payload to include Word properties:

```typescript
// Trigger Inngest analysis pipeline
await inngest.send({
  name: "nda/analysis.requested",
  data: {
    tenantId,
    userId: authContext.userId,
    documentId: document.id,
    analysisId: analysis.id,
    source: "word-addin" as const,
    content: {
      rawText: content,
      paragraphs: (paragraphs ?? []).map((p) => ({
        text: p.text,
        style: p.style ?? 'Normal',
        isHeading: p.isHeading ?? false,
        outlineLevel: p.outlineLevel ?? 0,
      })),
    },
    metadata: {
      title,
      author: properties?.author,
      wordVersion: properties?.wordVersion,
    },
  },
})
```

Also add outlineLevel to the paragraph schema:
```typescript
const paragraphSchema = z.object({
  text: z.string(),
  style: z.string().optional(),
  isHeading: z.boolean().optional(),
  outlineLevel: z.number().optional(),
})
```
  </action>
  <verify>
TypeScript compiles: `pnpm tsc --noEmit 2>&1 | head -20`
Has outlineLevel in event: `grep "outlineLevel" app/api/word-addin/analyze/route.ts`
  </verify>
  <done>Inngest event includes Word properties and paragraph outline levels</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Document content includes outlineLevel for paragraphs
3. Document properties (author, dates) extracted
4. Content hash deduplication works
5. Existing completed analyses are returned without re-processing
6. In-progress analyses return appropriate status
7. Tests pass: `pnpm test -- app/api/word-addin`
</verification>

<success_criteria>
- Paragraph type includes outlineLevel field
- DocumentContent includes properties object
- API validates content hash against existing documents
- Completed analyses return without re-processing
- In-progress analyses return "in_progress" status
- Word properties passed through to Inngest event
</success_criteria>

<output>
After completion, create `.planning/phases/03-document-extraction/03-05-SUMMARY.md`
</output>
