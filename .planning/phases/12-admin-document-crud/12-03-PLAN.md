---
phase: 12-admin-document-crud
plan: 03
type: execute
wave: 3
depends_on: ["12-02"]
files_modified:
  - app/(main)/(admin)/admin/document-detail.tsx
  - app/(main)/(admin)/admin/delete-dialog.tsx
  - app/(main)/(admin)/admin/admin-page-client.tsx
  - app/(main)/(admin)/admin/page.tsx
  - app/(main)/(admin)/admin/documents-table.tsx
  - components/shell/app-sidebar.tsx
autonomous: false

must_haves:
  truths:
    - "Clicking a document row opens a detail panel with full information"
    - "Detail panel shows list of associated analyses with status and link to analysis view"
    - "Admin can edit document title from the detail panel"
    - "Admin can download original document from the detail panel"
    - "Admin can re-trigger analysis from the detail panel"
    - "Admin can delete individual analyses from the detail panel"
    - "Delete confirmation via modal dialog with document name"
    - "Bulk delete confirmation shows count of selected documents"
    - "Admin link hidden from non-admin users in the sidebar"
    - "Admin link visible to admin/owner users in the sidebar"
  artifacts:
    - path: "app/(main)/(admin)/admin/document-detail.tsx"
      provides: "Sheet panel with document info, actions, and analyses list"
      contains: "Sheet"
    - path: "app/(main)/(admin)/admin/delete-dialog.tsx"
      provides: "Confirmation dialogs for single and bulk delete"
      contains: "AlertDialog"
    - path: "app/(main)/(admin)/admin/admin-page-client.tsx"
      provides: "Client wrapper managing selected row, detail panel, and delete dialog state"
      contains: "use client"
    - path: "components/shell/app-sidebar.tsx"
      provides: "Sidebar with conditional admin link"
      contains: "admin"
  key_links:
    - from: "app/(main)/(admin)/admin/document-detail.tsx"
      to: "app/(main)/(admin)/admin/actions.ts"
      via: "server action calls for title update, delete, trigger analysis"
      pattern: "adminUpdateDocumentTitle|adminDeleteDocument|adminTriggerAnalysis|adminDeleteAnalysis"
    - from: "app/(main)/(admin)/admin/delete-dialog.tsx"
      to: "app/(main)/(admin)/admin/actions.ts"
      via: "adminDeleteDocument and adminBulkDeleteDocuments calls"
      pattern: "adminDeleteDocument|adminBulkDeleteDocuments"
    - from: "app/(main)/(admin)/admin/admin-page-client.tsx"
      to: "app/(main)/(admin)/admin/document-detail.tsx"
      via: "renders DocumentDetail with selectedDocumentId state"
      pattern: "DocumentDetail"
    - from: "components/shell/app-sidebar.tsx"
      to: "/admin route"
      via: "conditional navigation link"
      pattern: "admin"
---

<objective>
Build the document detail panel, delete confirmation dialogs, and add conditional admin link to sidebar.

Purpose: Completes the admin UI with interactive features -- viewing document details, editing metadata, managing analyses, confirming destructive operations, and making the admin page discoverable from the sidebar.

Output: Fully functional admin document management page with detail panel, delete confirmations, and sidebar navigation.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-admin-document-crud/12-CONTEXT.md
@.planning/phases/12-admin-document-crud/12-RESEARCH.md
@.planning/phases/12-admin-document-crud/12-01-SUMMARY.md
@.planning/phases/12-admin-document-crud/12-02-SUMMARY.md

@app/(main)/(admin)/admin/actions.ts
@app/(main)/(admin)/admin/documents-table.tsx
@app/(main)/(admin)/admin/page.tsx
@components/shell/app-sidebar.tsx
@components/ui/sheet.tsx
@components/ui/alert-dialog.tsx
@components/ui/badge.tsx
@components/ui/button.tsx
@components/ui/input.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document detail panel, delete dialogs, and client wrapper</name>
  <files>
    app/(main)/(admin)/admin/document-detail.tsx
    app/(main)/(admin)/admin/delete-dialog.tsx
    app/(main)/(admin)/admin/admin-page-client.tsx
    app/(main)/(admin)/admin/page.tsx
    app/(main)/(admin)/admin/documents-table.tsx
  </files>
  <action>
**Document detail panel** (`app/(main)/(admin)/admin/document-detail.tsx`):

"use client" component using shadcn Sheet (slide-out from right). Per locked decision: "Clicking a document row opens a detail panel with full information."

Props:
```typescript
interface DocumentDetailProps {
  documentId: string | null  // null = closed
  onClose: () => void
  onDocumentDeleted: () => void  // refresh table after delete
}
```

Behavior:
- When `documentId` is non-null, fetch document detail via `adminGetDocumentDetail({ documentId })`
- Use `useEffect` to fetch when documentId changes
- Show loading skeleton while fetching
- Sheet is open when documentId is non-null, closed when null

Layout (per RESEARCH.md detail panel hierarchy):

1. **Sheet Header**: Document title (editable) + status badge
   - Title: Display as text by default. Click to edit (toggle to Input field). Save on blur or Enter key. Cancel on Escape. Calls `adminUpdateDocumentTitle`.

2. **Section: Document Info** (use dl/dt/dd or a simple label-value grid):
   - File name (text, not editable)
   - File type (formatted: "PDF" or "DOCX")
   - File size (formatted: e.g., "2.4 MB")
   - Upload date (formatted with Intl.DateTimeFormat)
   - Content hash (truncated to first 12 chars + "...")

3. **Section: Actions** (row of buttons):
   - **Download**: Button with DownloadIcon. Calls `adminGetDocumentDetail` to get fileUrl, opens in new tab: `window.open(doc.fileUrl, '_blank')`
   - **Re-run Analysis**: Button with RefreshCwIcon. Calls `adminTriggerAnalysis({ documentId })`. Show loading state during call. Show success toast via `sonner`. Disabled if document status is not "ready" or "complete".
   - **Delete Document**: Button variant="destructive" with Trash2Icon. Opens the single-delete confirmation dialog.

4. **Section: Analyses** (with count badge):
   - List of analyses ordered by version (newest first)
   - Each analysis row shows: "v{version}" | status Badge | date | overall risk score (if completed)
   - Each row has a link icon that navigates to `/analysis/{analysisId}` (per locked decision: "link to analysis view")
   - Each row has a delete button (Trash2 icon, small) that opens a confirmation then calls `adminDeleteAnalysis({ analysisId })`
   - Per locked decision: "Admin can delete individual analyses from a document (keeping the document)"

5. **Section: Error Info** (only shown if document status === "failed"):
   - Red alert showing errorMessage

Use `toast` from `sonner` for success/error notifications on actions.

**Delete confirmation dialogs** (`app/(main)/(admin)/admin/delete-dialog.tsx`):

"use client" component with two dialog variants using shadcn AlertDialog. Per locked decision: "Delete confirmation via modal dialog ('Are you sure?' with document name)."

1. **SingleDeleteDialog**:
```typescript
interface SingleDeleteDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  documentTitle: string
  documentId: string
  onConfirm: () => void
}
```
   - AlertDialog title: "Delete Document"
   - AlertDialog description: 'Are you sure you want to delete "{documentTitle}"? This will permanently remove the document and all associated analyses, chunks, and classifications. This action cannot be undone.'
   - Cancel button + destructive Confirm button ("Delete")
   - On confirm: call `adminDeleteDocument({ documentId })`, show toast, call onConfirm callback

2. **BulkDeleteDialog**:
```typescript
interface BulkDeleteDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  documentIds: string[]
  onConfirm: () => void
}
```
   - AlertDialog title: "Delete {N} Documents"
   - AlertDialog description: "Are you sure you want to delete {N} documents? This will permanently remove all selected documents and their associated data. This action cannot be undone."
   - Cancel + destructive Confirm ("Delete {N} Documents")
   - On confirm: call `adminBulkDeleteDocuments({ documentIds })`, show toast with results (deleted count, error count), call onConfirm

Both dialogs show loading spinner on the confirm button while the action is in progress. Disable buttons during loading.

**Client wrapper** (`app/(main)/(admin)/admin/admin-page-client.tsx`):

Create a "use client" wrapper component that receives server-fetched data from page.tsx and manages ALL client-side state: selected document row (for detail panel), detail panel open/close, delete dialog state, and row selection for bulk operations.

```typescript
"use client"

interface AdminPageClientProps {
  documents: AdminDocument[]
  total: number
  page: number
  pageSize: number
  sortBy?: string
  sortOrder?: "asc" | "desc"
}
```

This component:
- Manages `selectedDocumentId` state (string | null) for the detail panel
- Manages `deleteDialogOpen` and `bulkDeleteDialogOpen` state
- Passes `onRowClick` to DocumentsTable that sets selectedDocumentId
- Renders `<Toolbar>` with selectedCount and onBulkDelete
- Renders `<DocumentsTable>` with data and handlers
- Renders `<DocumentDetail>` with selectedDocumentId
- Renders `<SingleDeleteDialog>` and `<BulkDeleteDialog>`
- After any delete, calls `router.refresh()` to re-fetch server data

**Update page.tsx** to remain a pure RSC:
- page.tsx fetches data via `adminGetDocuments()` (server-side)
- Passes fetched data to `<AdminPageClient>` as props
- page.tsx does NOT manage any client state -- all state lives in admin-page-client.tsx

**Update documents-table.tsx** to:
- Expose selected row IDs to parent via an `onSelectionChange` callback prop
- Accept `onRowClick` prop (already in interface from Plan 02)
  </action>
  <verify>
TypeScript compiles: `cd /Users/medelman/GitHub/medelman17/vibedocs && npx tsc --noEmit --pretty 2>&1 | head -50`
  </verify>
  <done>
Document detail panel opens on row click, shows document info/actions/analyses. Delete confirmation dialogs exist for both single and bulk delete with proper warning text. Client wrapper (admin-page-client.tsx) manages all interactive state while page.tsx remains a pure RSC. All admin actions (edit title, download, re-trigger analysis, delete document, delete analysis, bulk delete) are wired and functional.
  </done>
</task>

<task type="auto">
  <name>Task 2: Conditional admin link in sidebar</name>
  <files>
    components/shell/app-sidebar.tsx
  </files>
  <action>
Update `components/shell/app-sidebar.tsx` to add an admin link that is only visible to admin/owner users.

Per locked decisions:
- "Admin link hidden completely from non-admin users (not rendered)"
- "Admin page lives at a separate /admin route"

Add a new prop to `AppSidebarProps`:
```typescript
interface AppSidebarProps {
  // ... existing props
  userRole?: string  // "admin" | "owner" | "member" | "viewer"
}
```

In the sidebar, add an "Admin" section ABOVE the SidebarFooter (after the history content, before the footer). Only render when `userRole === "admin" || userRole === "owner"`:

```tsx
{(userRole === "admin" || userRole === "owner") && (
  <>
    <SidebarSeparator />
    <SidebarGroup>
      <SidebarGroupContent>
        <SidebarMenu>
          <SidebarMenuItem>
            <SidebarMenuButton
              asChild
              tooltip="Admin"
              className="gap-2"
            >
              <a href="/admin">
                <ShieldIcon className="size-4 shrink-0" />
                <span>Admin</span>
              </a>
            </SidebarMenuButton>
          </SidebarMenuItem>
        </SidebarMenu>
      </SidebarGroupContent>
    </SidebarGroup>
  </>
)}
```

Import `ShieldIcon` from `lucide-react`.

Note: The server-side role check is already enforced by the admin layout's `requireRole()`. The sidebar link hiding is purely UX (per locked decision: "Server-side role check enforced, not just client-side hide"). The link is hidden for non-admin users but even if someone navigates directly to /admin, the layout's `requireRole()` will redirect them.

Also need to ensure the parent component that renders `<AppSidebar>` passes the `userRole` prop. Find where AppSidebar is used and pass the role from the session/DAL context.
  </action>
  <verify>
TypeScript compiles: `cd /Users/medelman/GitHub/medelman17/vibedocs && npx tsc --noEmit --pretty 2>&1 | head -50`
Lint passes: `cd /Users/medelman/GitHub/medelman17/vibedocs && pnpm lint 2>&1 | tail -20`
  </verify>
  <done>
Admin link with ShieldIcon appears in sidebar for admin/owner users. Link is completely hidden (not rendered) for non-admin users. Clicking navigates to /admin.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete admin document management page with data table, detail panel, delete dialogs, and sidebar navigation</what-built>
  <how-to-verify>
1. Start the dev server: `pnpm dev`
2. Log in as an admin/owner user
3. Verify the sidebar shows an "Admin" link with a shield icon
4. Click the Admin link -- should navigate to /admin
5. Verify the documents table loads with columns: checkbox, Name, Upload Date, Status, Type, Size
6. Test search: type a document name and verify results filter
7. Test status filter dropdown -- select a status and verify results filter
8. Test pagination: if you have enough documents, verify page navigation works
9. Test page size selector: change to 10 or 50 and verify
10. Click a document row -- verify detail panel slides open from right
11. In detail panel: verify document info displays (file name, type, size, date)
12. In detail panel: try editing the title (click to edit, change text, press Enter)
13. In detail panel: verify analyses list shows with status badges
14. Try deleting a document -- verify confirmation dialog shows with document name
15. Log in as a regular member -- verify the Admin sidebar link is NOT visible
16. Try navigating directly to /admin as a non-admin -- should redirect to dashboard
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` shows no type errors
2. `pnpm lint` passes
3. Admin page at `/admin` renders with full functionality
4. Detail panel opens on row click with document info and analyses
5. Delete dialogs show proper confirmation messages
6. Sidebar shows admin link only for admin/owner roles
7. Non-admin users redirected from /admin
</verification>

<success_criteria>
- Row click opens Sheet detail panel with document info and analyses list
- Title editing works inline in the detail panel
- Download button opens file in new tab
- Re-trigger analysis button creates new analysis version
- Single delete shows confirmation with document name, cascades properly
- Bulk delete shows confirmation with count, handles partial failures
- Individual analysis delete works from detail panel
- Admin link in sidebar visible only to admin/owner roles
- Non-admin users get server-side redirected from /admin
- Human verification confirms visual correctness and interaction flow
</success_criteria>

<output>
After completion, create `.planning/phases/12-admin-document-crud/12-03-SUMMARY.md`
</output>
