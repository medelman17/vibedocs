---
phase: 02-budget-protection
plan: 04
type: execute
wave: 3
depends_on: ["02-01", "02-03"]
files_modified:
  - app/api/admin/usage/route.ts
autonomous: true

must_haves:
  truths:
    - "Admin users can query usage statistics via API"
    - "Non-admin users receive 403 Forbidden"
    - "API returns token and cost aggregates for organization"
  artifacts:
    - path: "app/api/admin/usage/route.ts"
      provides: "Admin usage API endpoint"
      exports: ["GET"]
      min_lines: 50
  key_links:
    - from: "app/api/admin/usage/route.ts"
      to: "db/schema/analyses"
      via: "aggregate queries"
      pattern: "sum.*estimatedTokens|actualTokens"
    - from: "app/api/admin/usage/route.ts"
      to: "lib/auth"
      via: "session verification"
      pattern: "auth\\(\\)"
---

<objective>
Create admin-only API endpoint for querying usage statistics.

Purpose: Enable admins to monitor token usage and costs across their organization.

Output: GET /api/admin/usage endpoint returning aggregate usage data.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-budget-protection/02-01-PLAN.md
@app/api/admin/bootstrap/route.ts
@db/schema/analyses.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin usage API endpoint</name>
  <files>app/api/admin/usage/route.ts</files>
  <action>
Create a new admin API endpoint at `app/api/admin/usage/route.ts`:

```typescript
/**
 * @fileoverview Admin Usage API
 *
 * Admin-only API route to query usage statistics for the organization.
 * Returns aggregate token usage and estimated costs.
 *
 * @route GET /api/admin/usage
 *
 * @example Query params:
 * - startDate: ISO date string (optional)
 * - endDate: ISO date string (optional)
 *
 * @module app/api/admin/usage/route
 */

import { NextResponse } from "next/server"
import { auth } from "@/lib/auth"
import { db } from "@/db"
import { organizationMembers, analyses } from "@/db/schema"
import { eq, and, gte, lte, sql, sum, count } from "drizzle-orm"

/**
 * Get usage statistics for the organization.
 *
 * Requires admin or owner role.
 */
export async function GET(request: Request) {
  // Check authentication
  const session = await auth()

  if (!session?.user?.id) {
    return NextResponse.json(
      { error: "Unauthorized: Authentication required" },
      { status: 401 }
    )
  }

  // Check admin role
  const organizationId = session.activeOrganizationId

  if (!organizationId) {
    return NextResponse.json(
      { error: "Forbidden: No active organization" },
      { status: 403 }
    )
  }

  const membership = await db.query.organizationMembers.findFirst({
    where: and(
      eq(organizationMembers.userId, session.user.id),
      eq(organizationMembers.organizationId, organizationId)
    ),
  })

  if (!membership || !["owner", "admin"].includes(membership.role)) {
    return NextResponse.json(
      { error: "Forbidden: Admin access required" },
      { status: 403 }
    )
  }

  // Parse query params
  const url = new URL(request.url)
  const startDate = url.searchParams.get('startDate')
  const endDate = url.searchParams.get('endDate')

  // Build query conditions
  const conditions = [eq(analyses.tenantId, organizationId)]
  if (startDate) {
    conditions.push(gte(analyses.createdAt, new Date(startDate)))
  }
  if (endDate) {
    conditions.push(lte(analyses.createdAt, new Date(endDate)))
  }

  try {
    // Query aggregate usage
    const [usage] = await db
      .select({
        totalAnalyses: count(),
        completedAnalyses: sql<number>`count(*) filter (where ${analyses.status} = 'completed')`,
        failedAnalyses: sql<number>`count(*) filter (where ${analyses.status} = 'failed')`,
        processingAnalyses: sql<number>`count(*) filter (where ${analyses.status} = 'processing')`,
        totalEstimatedTokens: sum(analyses.estimatedTokens),
        totalActualTokens: sum(analyses.actualTokens),
        totalEstimatedCost: sum(analyses.estimatedCost),
        truncatedDocuments: sql<number>`count(*) filter (where ${analyses.wasTruncated} = true)`,
        avgProcessingTimeMs: sql<number>`avg(${analyses.processingTimeMs})`,
      })
      .from(analyses)
      .where(and(...conditions))

    return NextResponse.json({
      organizationId,
      period: {
        startDate: startDate ?? null,
        endDate: endDate ?? null,
      },
      usage: {
        analyses: {
          total: Number(usage.totalAnalyses ?? 0),
          completed: Number(usage.completedAnalyses ?? 0),
          failed: Number(usage.failedAnalyses ?? 0),
          processing: Number(usage.processingAnalyses ?? 0),
          truncated: Number(usage.truncatedDocuments ?? 0),
        },
        tokens: {
          estimated: Number(usage.totalEstimatedTokens ?? 0),
          actual: Number(usage.totalActualTokens ?? 0),
        },
        cost: {
          estimated: Number(usage.totalEstimatedCost ?? 0),
        },
        performance: {
          avgProcessingTimeMs: usage.avgProcessingTimeMs
            ? Math.round(Number(usage.avgProcessingTimeMs))
            : null,
        },
      },
    })
  } catch (error) {
    console.error("[admin/usage] Error querying usage:", error)
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    )
  }
}
```

Note: This follows the same admin role pattern as `/api/admin/bootstrap`.
  </action>
  <verify>
Check TypeScript compiles:
```bash
pnpm tsc --noEmit app/api/admin/usage/route.ts
```
  </verify>
  <done>
Admin usage API endpoint created at /api/admin/usage. Returns aggregate usage statistics for the organization.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite and lint</name>
  <files>None (verification only)</files>
  <action>
Run the full test suite and linting to ensure no regressions:

1. Run lint:
```bash
pnpm lint
```

2. Run all tests:
```bash
pnpm test
```

3. Build check:
```bash
pnpm build
```

Fix any errors that arise. Common issues:
- Import paths
- Type mismatches
- Missing exports
  </action>
  <verify>
```bash
pnpm lint && pnpm test && pnpm build
```
All commands succeed.
  </verify>
  <done>
Full test suite, lint, and build pass. Phase 02 implementation complete.
  </done>
</task>

</tasks>

<verification>
1. GET /api/admin/usage returns 401 for unauthenticated
2. GET /api/admin/usage returns 403 for non-admin
3. GET /api/admin/usage returns usage data for admin
4. Date filtering works with startDate/endDate params
5. Full test suite passes
</verification>

<success_criteria>
- Admin usage API endpoint exists and enforces admin role
- API returns aggregate token usage and cost data
- Date filtering supported via query params
- Full test suite passes
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-budget-protection/02-04-SUMMARY.md`
</output>
