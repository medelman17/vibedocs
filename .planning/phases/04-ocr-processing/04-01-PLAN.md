---
phase: 04-ocr-processing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/ocr/types.ts
  - lib/ocr/pdf-to-image.ts
  - lib/ocr/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "PDF pages can be converted to images for OCR processing"
    - "OCR types define confidence thresholds and result structures"
  artifacts:
    - path: "lib/ocr/types.ts"
      provides: "OCR type definitions with confidence thresholds"
      exports: ["OcrPageResult", "OcrResult", "OcrQuality", "CONFIDENCE_THRESHOLD", "CRITICAL_THRESHOLD"]
    - path: "lib/ocr/pdf-to-image.ts"
      provides: "PDF page to image conversion"
      exports: ["renderPdfPages"]
    - path: "lib/ocr/index.ts"
      provides: "Barrel export for OCR module"
  key_links:
    - from: "lib/ocr/pdf-to-image.ts"
      to: "pdf-to-img"
      via: "dynamic import"
      pattern: "import\\(.*pdf-to-img.*\\)"
---

<objective>
Create OCR infrastructure with type definitions and PDF-to-image conversion utilities.

Purpose: Establish the foundation for OCR processing - types define quality thresholds and result structures, PDF-to-image provides the first step in the OCR pipeline (scanned PDFs must be converted to images before Tesseract can process them).

Output: `lib/ocr/` module with types and PDF page rendering capability.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-ocr-processing/04-RESEARCH.md

# Existing patterns to follow
@lib/document-extraction/types.ts
@lib/errors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install OCR dependencies</name>
  <files>package.json</files>
  <action>
Install tesseract.js and pdf-to-img:
```bash
pnpm add tesseract.js pdf-to-img
```

Tesseract.js provides WASM-based OCR (Apache 2.0 license).
pdf-to-img converts PDF pages to images using pdfjs-dist internally.

Both are required for the OCR pipeline: PDF -> images -> OCR text.
  </action>
  <verify>`pnpm list tesseract.js pdf-to-img` shows both installed</verify>
  <done>tesseract.js and pdf-to-img in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create OCR type definitions</name>
  <files>lib/ocr/types.ts</files>
  <action>
Create type definitions for OCR processing:

```typescript
/**
 * @fileoverview OCR type definitions
 * @module lib/ocr/types
 */

/** Confidence threshold below which a warning is shown (85%) */
export const CONFIDENCE_THRESHOLD = 85

/** Confidence threshold below which OCR may be unusable (60%) */
export const CRITICAL_THRESHOLD = 60

/** Maximum pages to OCR (memory/time constraint) */
export const MAX_OCR_PAGES = 100

/** OCR result for a single page */
export interface OcrPageResult {
  pageNumber: number
  text: string
  /** Tesseract confidence 0-100 */
  confidence: number
}

/** Aggregated OCR result for entire document */
export interface OcrResult {
  /** Combined text from all pages */
  text: string
  /** Per-page results */
  pages: OcrPageResult[]
  /** Average confidence across all pages */
  averageConfidence: number
  /** Page numbers with confidence below CONFIDENCE_THRESHOLD */
  lowConfidencePages: number[]
}

/** Quality assessment of OCR output */
export interface OcrQuality {
  /** Average confidence 0-100 */
  confidence: number
  /** True if warning should be shown to user */
  isLowQuality: boolean
  /** User-facing warning message (if applicable) */
  warningMessage?: string
  /** Pages with confidence below threshold */
  affectedPages: number[]
}

/** Options for PDF-to-image conversion */
export interface PdfToImageOptions {
  /** Scale factor for rendering (2.0 = 2x resolution, better for OCR) */
  scale?: number
  /** Maximum pages to render (default: MAX_OCR_PAGES) */
  maxPages?: number
}

/** A rendered PDF page as image buffer */
export interface RenderedPage {
  pageNumber: number
  /** Image data as Uint8Array (PNG format) */
  image: Uint8Array
}
```

Key decisions per RESEARCH.md:
- 85% confidence threshold for warnings
- 60% critical threshold (may be unusable)
- 100 page limit for OCR processing
  </action>
  <verify>TypeScript compilation passes: `pnpm exec tsc --noEmit lib/ocr/types.ts`</verify>
  <done>OCR types exported with confidence constants</done>
</task>

<task type="auto">
  <name>Task 3: Create PDF-to-image converter with dynamic import</name>
  <files>lib/ocr/pdf-to-image.ts, lib/ocr/index.ts</files>
  <action>
Create PDF page renderer using pdf-to-img with DYNAMIC IMPORT to avoid barrel export issues (same pattern as pdf-parse per CLAUDE.md):

```typescript
// lib/ocr/pdf-to-image.ts
/**
 * @fileoverview PDF to image conversion for OCR
 * @module lib/ocr/pdf-to-image
 */

import type { PdfToImageOptions, RenderedPage } from './types'
import { MAX_OCR_PAGES } from './types'

/**
 * Render PDF pages as images for OCR processing.
 *
 * Uses dynamic import for pdf-to-img to avoid barrel export issues
 * (same pattern as pdf-parse - see CLAUDE.md "Barrel Exports" section).
 *
 * @param buffer - PDF file as Buffer
 * @param options - Rendering options
 * @returns Async generator yielding rendered pages
 *
 * @example
 * ```ts
 * const pages: RenderedPage[] = []
 * for await (const page of renderPdfPages(buffer)) {
 *   pages.push(page)
 * }
 * ```
 */
export async function* renderPdfPages(
  buffer: Buffer,
  options: PdfToImageOptions = {}
): AsyncGenerator<RenderedPage> {
  const { scale = 2.0, maxPages = MAX_OCR_PAGES } = options

  // Dynamic import to avoid barrel export issues with pdfjs-dist
  const { pdf } = await import('pdf-to-img')

  const document = await pdf(buffer, { scale })

  let pageNumber = 0
  for await (const pageImage of document) {
    pageNumber++

    if (pageNumber > maxPages) {
      console.log('[OCR] Reached max pages limit', { maxPages, totalPages: pageNumber })
      break
    }

    yield {
      pageNumber,
      image: pageImage as Uint8Array,
    }
  }
}
```

Create barrel export (minimal - avoid heavy deps in barrel per CLAUDE.md):

```typescript
// lib/ocr/index.ts
/**
 * @fileoverview OCR module exports
 * @module lib/ocr
 *
 * IMPORTANT: This barrel only exports types and lightweight utilities.
 * Heavy processing functions (ocr-processor, tesseract-worker) should be
 * imported directly to avoid pulling in large dependencies.
 */

// Types are always safe to export
export * from './types'

// PDF-to-image uses dynamic import internally, safe to export
export { renderPdfPages } from './pdf-to-image'
```

Key implementation notes:
- Dynamic import for pdf-to-img (uses pdfjs-dist internally which has browser deps)
- AsyncGenerator pattern for memory efficiency (don't load all pages at once)
- Scale 2.0 for better OCR quality (higher resolution)
- Page limit enforced to prevent memory exhaustion
  </action>
  <verify>`pnpm exec tsc --noEmit lib/ocr/index.ts` passes</verify>
  <done>PDF pages can be rendered as images via async generator</done>
</task>

</tasks>

<verification>
1. Dependencies installed: `pnpm list tesseract.js pdf-to-img`
2. Types compile: `pnpm exec tsc --noEmit lib/ocr/types.ts`
3. Module compiles: `pnpm exec tsc --noEmit lib/ocr/index.ts`
4. Lint passes: `pnpm lint`
</verification>

<success_criteria>
- tesseract.js and pdf-to-img installed
- OCR types defined with confidence thresholds (85%, 60%)
- PDF-to-image conversion uses dynamic import pattern
- Barrel export is minimal (types + lightweight exports only)
</success_criteria>

<output>
After completion, create `.planning/phases/04-ocr-processing/04-01-SUMMARY.md`
</output>
