---
phase: 04-ocr-processing
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - inngest/functions/analyze-nda.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "When OcrRequiredError is caught, nda/ocr.requested event is emitted before pipeline halts"
    - "OCR function receives the event and processes the scanned document"
    - "User can proceed with analysis despite OCR quality warnings"
  artifacts:
    - path: "inngest/functions/analyze-nda.ts"
      provides: "OCR trigger event emission in extraction error handler"
      contains: "nda/ocr.requested"
  key_links:
    - from: "inngest/functions/analyze-nda.ts"
      to: "nda/ocr.requested"
      via: "step.sendEvent"
      pattern: "step\\.sendEvent.*nda/ocr\\.requested"
    - from: "inngest/functions/ocr-document.ts"
      to: "nda/ocr.requested"
      via: "event listener"
      pattern: "event.*nda/ocr\\.requested"
---

<objective>
Wire the missing OCR trigger event in the analysis pipeline.

Purpose: The OCR pipeline is fully implemented but never runs because `analyze-nda.ts` sets status to `pending_ocr` without emitting the `nda/ocr.requested` event. This is the only gap blocking Phase 4 completion.

Output: Modified `analyze-nda.ts` with `step.sendEvent` call that triggers OCR processing for scanned documents.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@inngest/functions/analyze-nda.ts
@inngest/functions/ocr-document.ts
@inngest/types.ts
@.planning/phases/04-ocr-processing/04-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OCR trigger event emission in extraction error handler</name>
  <files>inngest/functions/analyze-nda.ts</files>
  <action>
In the `analyzeNda` function, locate the extraction error handler (lines ~130-161) where `OcrRequiredError` is caught and mapped via `mapExtractionError()`.

Currently the code:
1. Persists `pending_ocr` status in step `persist-extraction-failure`
2. Immediately throws `NonRetriableError`

The fix: After the `persist-extraction-failure` step and BEFORE the `throw new NonRetriableError(...)`, add a conditional `step.sendEvent` when `mapped.routeToOcr` is true.

Replace the block after `persist-extraction-failure` step (from the closing of that step to the throw) with:

```typescript
          // Trigger OCR processing if this is a scanned document
          if (mapped.routeToOcr) {
            await step.sendEvent('trigger-ocr', {
              name: 'nda/ocr.requested',
              data: { documentId, analysisId, tenantId },
            })
          }

          // Halt this pipeline run - OCR function will continue asynchronously
          throw new NonRetriableError(mapped.userMessage)
```

Key details:
- The event name is `nda/ocr.requested` (already defined in `inngest/types.ts`)
- The payload requires `documentId`, `analysisId`, and `tenantId` (all available in scope)
- The `step.sendEvent` MUST come BEFORE the throw statement
- The `step.sendEvent` MUST come AFTER the `persist-extraction-failure` step (status must be persisted first)
- Use step ID `'trigger-ocr'` for the sendEvent call
- The throw still happens - this pipeline instance stops, but the OCR function picks up via the event

Do NOT modify `analyzeNdaAfterOcr` or any other part of the file. Only change the extraction error handler block.
  </action>
  <verify>
Run `pnpm build` to verify TypeScript compilation succeeds.

Then verify the wiring with grep:
```bash
grep -n "nda/ocr.requested" inngest/functions/analyze-nda.ts
```
Should show the new step.sendEvent line.

Also verify the event is sent before the throw:
```bash
grep -n -A5 "trigger-ocr" inngest/functions/analyze-nda.ts
```
Should show `step.sendEvent` with `nda/ocr.requested` followed by the `NonRetriableError` throw.
  </verify>
  <done>
The `nda/ocr.requested` event is emitted when `mapExtractionError` returns `routeToOcr: true`. The event contains `documentId`, `analysisId`, and `tenantId`. The `ocrDocument` Inngest function (already listening for this event) will receive it and process the scanned document. The full OCR pipeline chain is now connected:

1. OcrRequiredError caught -> status set to pending_ocr -> nda/ocr.requested emitted -> NonRetriableError thrown
2. ocrDocument function picks up event -> runs OCR -> emits nda/analysis.ocr-complete
3. analyzeNdaAfterOcr function picks up completion -> continues analysis pipeline
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds (TypeScript compiles)
2. `grep -n "nda/ocr.requested" inngest/functions/analyze-nda.ts` returns a match showing `step.sendEvent`
3. The `step.sendEvent('trigger-ocr', ...)` call appears AFTER `persist-extraction-failure` step and BEFORE `throw new NonRetriableError`
4. The event data includes all three required fields: `documentId`, `analysisId`, `tenantId`
</verification>

<success_criteria>
- The `nda/ocr.requested` event is emitted from `analyze-nda.ts` when a scanned PDF is detected
- The full event chain is wired: analyze-nda -> nda/ocr.requested -> ocr-document -> nda/analysis.ocr-complete -> analyzeNdaAfterOcr
- Build passes without errors
- Phase 4 verification gap is closed
</success_criteria>

<output>
After completion, create `.planning/phases/04-ocr-processing/04-05-SUMMARY.md`
</output>
