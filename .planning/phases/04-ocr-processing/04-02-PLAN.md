---
phase: 04-ocr-processing
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - lib/ocr/tesseract-worker.ts
  - lib/ocr/ocr-processor.ts
  - lib/ocr/quality.ts
autonomous: true

must_haves:
  truths:
    - "Tesseract worker can be created, used, and terminated without memory leaks"
    - "OCR processor extracts text from PDF pages with confidence scores"
    - "Quality assessment identifies low-confidence pages for user warning"
  artifacts:
    - path: "lib/ocr/tesseract-worker.ts"
      provides: "Tesseract worker lifecycle management"
      exports: ["createOcrWorker", "recognizePage"]
    - path: "lib/ocr/ocr-processor.ts"
      provides: "Main OCR entry point"
      exports: ["ocrPdf"]
    - path: "lib/ocr/quality.ts"
      provides: "OCR quality assessment"
      exports: ["assessOcrQuality"]
  key_links:
    - from: "lib/ocr/ocr-processor.ts"
      to: "lib/ocr/tesseract-worker.ts"
      via: "createOcrWorker, recognizePage"
      pattern: "createOcrWorker|recognizePage"
    - from: "lib/ocr/ocr-processor.ts"
      to: "lib/ocr/pdf-to-image.ts"
      via: "renderPdfPages"
      pattern: "renderPdfPages"
---

<objective>
Create the core OCR processing capability with Tesseract worker management and quality assessment.

Purpose: Provide the actual OCR functionality - Tesseract.js extracts text from images, the processor coordinates the full PDF-to-text flow, and quality assessment determines if user warnings are needed.

Output: Complete OCR processing pipeline that can convert scanned PDFs to text with confidence metrics.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-ocr-processing/04-RESEARCH.md
@.planning/phases/04-ocr-processing/04-01-SUMMARY.md

# Types from Plan 01
@lib/ocr/types.ts
@lib/ocr/pdf-to-image.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Tesseract worker management</name>
  <files>lib/ocr/tesseract-worker.ts</files>
  <action>
Create Tesseract worker utilities with proper lifecycle management:

```typescript
// lib/ocr/tesseract-worker.ts
/**
 * @fileoverview Tesseract.js worker management
 * @module lib/ocr/tesseract-worker
 *
 * Provides worker lifecycle utilities for OCR processing.
 * Workers are memory-intensive - always terminate after use.
 */

import type { Worker } from 'tesseract.js'
import type { OcrPageResult } from './types'

/**
 * Create a Tesseract worker for English text recognition.
 *
 * IMPORTANT: Always call worker.terminate() when done to prevent memory leaks.
 * For multi-page documents, reuse a single worker across pages (more efficient
 * than creating one per page).
 *
 * @returns Initialized Tesseract worker
 *
 * @example
 * ```ts
 * const worker = await createOcrWorker()
 * try {
 *   // Process pages...
 * } finally {
 *   await worker.terminate()
 * }
 * ```
 */
export async function createOcrWorker(): Promise<Worker> {
  // Dynamic import to keep tesseract.js out of initial bundle
  const { createWorker } = await import('tesseract.js')

  // Initialize worker with English language
  // Worker downloads language data on first use (~15MB for eng.traineddata)
  const worker = await createWorker('eng')

  return worker
}

/**
 * Recognize text from an image using a Tesseract worker.
 *
 * @param worker - Initialized Tesseract worker
 * @param image - Image data (Uint8Array, Buffer, or similar)
 * @param pageNumber - Page number for result tracking
 * @returns OCR result with text and confidence
 */
export async function recognizePage(
  worker: Worker,
  image: Uint8Array | Buffer,
  pageNumber: number
): Promise<OcrPageResult> {
  const result = await worker.recognize(image)

  return {
    pageNumber,
    text: result.data.text,
    // Tesseract confidence is 0-100
    confidence: result.data.confidence,
  }
}
```

Key implementation notes per RESEARCH.md:
- Single worker reused across pages (more memory efficient than one per page)
- Dynamic import keeps tesseract.js out of initial bundle
- Always terminate worker in finally block to prevent memory leaks
- English only for legal documents (legal OCR is primarily English)
  </action>
  <verify>TypeScript compiles: `pnpm exec tsc --noEmit lib/ocr/tesseract-worker.ts`</verify>
  <done>Tesseract worker can be created, used for recognition, and terminated</done>
</task>

<task type="auto">
  <name>Task 2: Create quality assessment utility</name>
  <files>lib/ocr/quality.ts</files>
  <action>
Create OCR quality assessment following RESEARCH.md patterns:

```typescript
// lib/ocr/quality.ts
/**
 * @fileoverview OCR quality assessment
 * @module lib/ocr/quality
 */

import type { OcrResult, OcrQuality } from './types'
import { CONFIDENCE_THRESHOLD, CRITICAL_THRESHOLD } from './types'

/**
 * Assess OCR quality and determine if user warning is needed.
 *
 * Thresholds (from RESEARCH.md):
 * - >= 85%: Good quality, no warning
 * - 60-84%: Low quality, show warning about potential accuracy issues
 * - < 60%: Critical quality, warn that results may be significantly inaccurate
 *
 * @param result - OCR result with per-page confidence scores
 * @returns Quality assessment with optional warning message
 */
export function assessOcrQuality(result: OcrResult): OcrQuality {
  const { averageConfidence, lowConfidencePages } = result

  // Critical threshold - results may be unusable
  if (averageConfidence < CRITICAL_THRESHOLD) {
    return {
      confidence: averageConfidence,
      isLowQuality: true,
      warningMessage:
        'This document has very low OCR quality. Analysis results may be significantly inaccurate. ' +
        'Consider uploading a clearer scan or the original document if available.',
      affectedPages: lowConfidencePages,
    }
  }

  // Warning threshold - results may have issues
  if (averageConfidence < CONFIDENCE_THRESHOLD) {
    const pagesText = lowConfidencePages.length > 5
      ? `${lowConfidencePages.slice(0, 5).join(', ')} and ${lowConfidencePages.length - 5} more`
      : lowConfidencePages.join(', ')

    return {
      confidence: averageConfidence,
      isLowQuality: true,
      warningMessage:
        `Some parts of this document were difficult to read. ` +
        `Analysis accuracy may be affected on pages ${pagesText}.`,
      affectedPages: lowConfidencePages,
    }
  }

  // Good quality - no warning needed
  return {
    confidence: averageConfidence,
    isLowQuality: false,
    affectedPages: [],
  }
}
```

The warning messages are user-friendly and actionable per RESEARCH.md pitfall #5.
  </action>
  <verify>TypeScript compiles: `pnpm exec tsc --noEmit lib/ocr/quality.ts`</verify>
  <done>Quality assessment returns appropriate warnings based on confidence thresholds</done>
</task>

<task type="auto">
  <name>Task 3: Create main OCR processor</name>
  <files>lib/ocr/ocr-processor.ts</files>
  <action>
Create the main OCR entry point that coordinates PDF-to-image and Tesseract:

```typescript
// lib/ocr/ocr-processor.ts
/**
 * @fileoverview Main OCR processor
 * @module lib/ocr/ocr-processor
 *
 * Coordinates PDF-to-image conversion and Tesseract OCR to extract
 * text from scanned PDFs.
 */

import type { OcrResult, PdfToImageOptions } from './types'
import { CONFIDENCE_THRESHOLD } from './types'
import { renderPdfPages } from './pdf-to-image'
import { createOcrWorker, recognizePage } from './tesseract-worker'

export interface OcrPdfOptions extends PdfToImageOptions {
  /**
   * Callback for progress updates during OCR.
   * Called after each page is processed.
   */
  onProgress?: (processed: number, total: number | null) => void
}

/**
 * Extract text from a scanned PDF using OCR.
 *
 * Process:
 * 1. Render PDF pages as high-resolution images
 * 2. Run Tesseract OCR on each page
 * 3. Aggregate results with confidence metrics
 *
 * Memory considerations (per RESEARCH.md):
 * - Pages processed sequentially to avoid memory exhaustion
 * - Single Tesseract worker reused across all pages
 * - Worker always terminated in finally block
 *
 * @param buffer - PDF file as Buffer
 * @param options - Processing options
 * @returns OCR result with text and confidence metrics
 *
 * @example
 * ```ts
 * const result = await ocrPdf(pdfBuffer, {
 *   onProgress: (done, total) => console.log(`Page ${done}/${total ?? '?'}`)
 * })
 * if (result.averageConfidence < 85) {
 *   console.warn('Low OCR quality')
 * }
 * ```
 */
export async function ocrPdf(
  buffer: Buffer,
  options: OcrPdfOptions = {}
): Promise<OcrResult> {
  const { onProgress, ...pdfOptions } = options

  const worker = await createOcrWorker()

  try {
    const pages: OcrResult['pages'] = []
    let totalConfidence = 0

    // Process pages sequentially to manage memory
    // (parallel processing would load all images into memory at once)
    for await (const renderedPage of renderPdfPages(buffer, pdfOptions)) {
      const pageResult = await recognizePage(
        worker,
        renderedPage.image,
        renderedPage.pageNumber
      )

      pages.push(pageResult)
      totalConfidence += pageResult.confidence

      // Report progress (total unknown until we finish iterating)
      onProgress?.(pages.length, null)
    }

    // Aggregate results
    const averageConfidence = pages.length > 0
      ? totalConfidence / pages.length
      : 0

    const lowConfidencePages = pages
      .filter(p => p.confidence < CONFIDENCE_THRESHOLD)
      .map(p => p.pageNumber)

    const fullText = pages.map(p => p.text).join('\n\n')

    console.log('[OCR] Processing complete', {
      pages: pages.length,
      averageConfidence: averageConfidence.toFixed(1),
      lowConfidencePages: lowConfidencePages.length,
    })

    return {
      text: fullText,
      pages,
      averageConfidence,
      lowConfidencePages,
    }
  } finally {
    // CRITICAL: Always terminate worker to prevent memory leaks
    await worker.terminate()
  }
}
```

Key implementation notes:
- Sequential page processing (not parallel) per RESEARCH.md pitfall #1
- Single worker reused across pages per RESEARCH.md pattern
- Worker ALWAYS terminated in finally block per RESEARCH.md anti-pattern
- Progress callback for UI/Inngest progress tracking
  </action>
  <verify>TypeScript compiles: `pnpm exec tsc --noEmit lib/ocr/ocr-processor.ts`</verify>
  <done>ocrPdf extracts text from scanned PDFs with confidence metrics</done>
</task>

</tasks>

<verification>
1. All OCR modules compile: `pnpm exec tsc --noEmit lib/ocr/*.ts`
2. No lint errors: `pnpm lint`
3. Build succeeds: `pnpm build`
</verification>

<success_criteria>
- Tesseract worker created with English language model
- Worker reused across pages (not one per page)
- Worker always terminated in finally block
- OCR processes pages sequentially (not parallel)
- Quality assessment returns warning for < 85% confidence
- Quality assessment returns critical warning for < 60% confidence
</success_criteria>

<output>
After completion, create `.planning/phases/04-ocr-processing/04-02-SUMMARY.md`
</output>
