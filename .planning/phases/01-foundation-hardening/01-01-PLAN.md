---
phase: 01-foundation-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - agents/validation/gates.ts
  - agents/validation/messages.ts
  - agents/validation/index.ts
autonomous: true

must_haves:
  truths:
    - "Validation gates exist for parser and classifier output"
    - "Error messages are plain language with actionable suggestions"
    - "Validation result includes stage name for UI display"
  artifacts:
    - path: "agents/validation/gates.ts"
      provides: "Validation gate functions"
      exports: ["validateParserOutput", "validateClassifierOutput"]
    - path: "agents/validation/messages.ts"
      provides: "User-friendly error message templates"
      exports: ["VALIDATION_MESSAGES", "formatValidationError"]
    - path: "agents/validation/index.ts"
      provides: "Barrel export for validation module"
      exports: ["validateParserOutput", "validateClassifierOutput", "VALIDATION_MESSAGES", "formatValidationError"]
  key_links:
    - from: "agents/validation/gates.ts"
      to: "agents/validation/messages.ts"
      via: "imports formatValidationError"
      pattern: "import.*formatValidationError.*from.*messages"
---

<objective>
Create validation gate infrastructure for pipeline stages.

Purpose: Validation gates halt the pipeline on critical failures (0 clauses, empty document) with user-friendly error messages. This is infrastructure that Plan 03 will integrate into analyze-nda.ts.

Output:
- `agents/validation/gates.ts` - Validation functions for parser and classifier output
- `agents/validation/messages.ts` - Plain language error messages with suggestions
- `agents/validation/index.ts` - Barrel export
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-hardening/01-CONTEXT.md
@.planning/phases/01-foundation-hardening/01-RESEARCH.md

Source files to reference:
@agents/classifier.ts (ClassifiedClause type, output shape)
@agents/parser.ts (ParsedDocument type, output shape)
@inngest/utils/errors.ts (NonRetriableError pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validation messages module</name>
  <files>agents/validation/messages.ts</files>
  <action>
Create `agents/validation/messages.ts` with:

1. **VALIDATION_MESSAGES constant** - Plain language messages per CONTEXT.md decisions:
   - `ZERO_CLAUSES`: "We couldn't find any clauses in this document." + suggestion about file format
   - `EMPTY_DOCUMENT`: "We couldn't extract any text from this document." + suggestion about encryption
   - `NO_CHUNKS`: "The document couldn't be processed into analyzable sections." + suggestion

2. **ValidationResult interface**:
```typescript
export interface ValidationResult {
  valid: boolean
  error?: {
    code: string           // For logging (ZERO_CLAUSES, EMPTY_DOCUMENT, etc.)
    userMessage: string    // Plain language for UI
    stage: string          // Which stage failed (parsing, clause extraction)
    suggestion?: string    // Actionable guidance
  }
}
```

3. **formatValidationError function**:
```typescript
export function formatValidationError(
  code: keyof typeof VALIDATION_MESSAGES,
  stage: string
): ValidationResult['error']
```

Follow error messaging decisions from CONTEXT.md:
- Plain language tone
- Actionable guidance
- Stage visibility
  </action>
  <verify>
```bash
# File exists and exports expected symbols
grep -q "VALIDATION_MESSAGES" agents/validation/messages.ts
grep -q "ValidationResult" agents/validation/messages.ts
grep -q "formatValidationError" agents/validation/messages.ts
```
  </verify>
  <done>messages.ts exports VALIDATION_MESSAGES, ValidationResult, and formatValidationError</done>
</task>

<task type="auto">
  <name>Task 2: Create validation gates module</name>
  <files>agents/validation/gates.ts</files>
  <action>
Create `agents/validation/gates.ts` with validation functions:

1. **validateParserOutput** - Validates parser agent output:
```typescript
export function validateParserOutput(
  rawText: string,
  chunks: Array<{ id: string; content: string }>
): ValidationResult
```
- Returns `{ valid: false, error: ... }` if rawText is empty/whitespace
- Returns `{ valid: false, error: ... }` if chunks array is empty
- Returns `{ valid: true }` otherwise
- Uses formatValidationError from messages.ts

2. **validateClassifierOutput** - Validates classifier agent output:
```typescript
export function validateClassifierOutput(
  clauses: Array<{ chunkId: string; category: string }>
): ValidationResult
```
- Returns `{ valid: false, error: ... }` if clauses.length === 0
- This is the "0 clauses = always halt" rule from CONTEXT.md
- Returns `{ valid: true }` otherwise

Do NOT add garbled text detection here - per RESEARCH.md recommendation, let downstream stages fail naturally for edge cases. Conservative heuristics can be added later if needed.

Import ValidationResult and formatValidationError from './messages'.
  </action>
  <verify>
```bash
# File exists and exports expected functions
grep -q "validateParserOutput" agents/validation/gates.ts
grep -q "validateClassifierOutput" agents/validation/gates.ts
# Imports from messages
grep -q "from.*messages" agents/validation/gates.ts
```
  </verify>
  <done>gates.ts exports validateParserOutput and validateClassifierOutput using messages.ts</done>
</task>

<task type="auto">
  <name>Task 3: Create barrel export</name>
  <files>agents/validation/index.ts</files>
  <action>
Create `agents/validation/index.ts` as minimal barrel export:

```typescript
/**
 * @fileoverview Validation Gates for NDA Analysis Pipeline
 *
 * Provides validation functions that halt the pipeline on critical failures
 * with user-friendly error messages.
 *
 * @module agents/validation
 */

export { validateParserOutput, validateClassifierOutput } from './gates'
export { VALIDATION_MESSAGES, formatValidationError, type ValidationResult } from './messages'
```

This barrel is safe because it only re-exports lightweight validation code (no heavy dependencies like pdf-parse).
  </action>
  <verify>
```bash
# File exists and re-exports
grep -q "validateParserOutput" agents/validation/index.ts
grep -q "VALIDATION_MESSAGES" agents/validation/index.ts
# TypeScript compiles
cd /Users/medelman/GitHub/medelman17/vibedocs && pnpm exec tsc --noEmit agents/validation/index.ts 2>&1 || true
```
  </verify>
  <done>index.ts provides clean barrel export for validation module</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run `pnpm exec tsc --noEmit` to verify no type errors
2. Verify directory structure: `ls agents/validation/`
3. Verify exports work: `grep -r "validateParserOutput" agents/validation/`
</verification>

<success_criteria>
- agents/validation/ directory exists with gates.ts, messages.ts, index.ts
- All files pass TypeScript type checking
- ValidationResult interface matches RESEARCH.md pattern
- Error messages match CONTEXT.md tone (plain language, actionable)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-hardening/01-01-SUMMARY.md`
</output>
