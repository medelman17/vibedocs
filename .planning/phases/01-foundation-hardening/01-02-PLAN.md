---
phase: 01-foundation-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - agents/classifier.ts
  - agents/risk-scorer.ts
  - agents/gap-analyst.ts
autonomous: true

must_haves:
  truths:
    - "All agents use generateText with Output.object() instead of generateObject"
    - "NoObjectGeneratedError is caught and converted to AnalysisFailedError"
    - "Token usage tracking still works (usage.inputTokens, usage.outputTokens)"
    - "Agent output shapes are unchanged for downstream compatibility"
  artifacts:
    - path: "agents/classifier.ts"
      provides: "Classifier agent with AI SDK 6 pattern"
      contains: "Output.object"
    - path: "agents/risk-scorer.ts"
      provides: "Risk scorer agent with AI SDK 6 pattern"
      contains: "Output.object"
    - path: "agents/gap-analyst.ts"
      provides: "Gap analyst agent with AI SDK 6 pattern"
      contains: "Output.object"
  key_links:
    - from: "agents/classifier.ts"
      to: "ai"
      via: "imports generateText, Output, NoObjectGeneratedError"
      pattern: "import.*generateText.*Output.*from.*ai"
---

<objective>
Migrate all agents from deprecated generateObject to AI SDK 6 pattern.

Purpose: The AI SDK has deprecated generateObject in favor of generateText + Output.object(). This migration ensures we're using the current API and prevents future breaking changes when generateObject is removed.

Output:
- classifier.ts migrated to generateText + Output.object()
- risk-scorer.ts migrated to generateText + Output.object()
- gap-analyst.ts migrated to generateText + Output.object()
- All agents handle NoObjectGeneratedError
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-hardening/01-RESEARCH.md (migration patterns, NoObjectGeneratedError handling)

Source files to modify:
@agents/classifier.ts
@agents/risk-scorer.ts
@agents/gap-analyst.ts
@lib/errors.ts (AnalysisFailedError for wrapped errors)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate classifier agent</name>
  <files>agents/classifier.ts</files>
  <action>
Migrate classifier.ts from generateObject to generateText + Output.object():

1. **Update imports**:
```typescript
// Before:
import { generateObject } from 'ai'

// After:
import { generateText, Output, NoObjectGeneratedError } from 'ai'
```

2. **Update the generateObject call** (around line 86):
```typescript
// Before:
const { object, usage } = await generateObject({
  model: getAgentModel('classifier'),
  system: CLASSIFIER_SYSTEM_PROMPT,
  prompt,
  schema: classificationSchema,
})

// After - wrap in try/catch:
let result
try {
  result = await generateText({
    model: getAgentModel('classifier'),
    system: CLASSIFIER_SYSTEM_PROMPT,
    prompt,
    output: Output.object({ schema: classificationSchema }),
  })
} catch (error) {
  if (NoObjectGeneratedError.isInstance(error)) {
    console.error('[Classifier] Object generation failed', {
      cause: error.cause,
      text: error.text?.slice(0, 500),
      usage: error.usage,
    })
    // Import AnalysisFailedError from @/lib/errors
    throw new AnalysisFailedError(
      'Classification failed to produce valid output',
      [{ field: 'chunk', message: `Model output: ${error.text?.slice(0, 100) ?? 'empty'}` }]
    )
  }
  throw error
}

const { output, usage } = result
```

3. **Update property access**:
- Change `object.category` to `output.category`
- Change `object.secondaryCategories` to `output.secondaryCategories`
- Change `object.confidence` to `output.confidence`
- Change `object.reasoning` to `output.reasoning`

4. **Add import for AnalysisFailedError**:
```typescript
import { AnalysisFailedError } from '@/lib/errors'
```

The output shape and downstream code (clauses.push(...)) stays identical - only the LLM call changes.
  </action>
  <verify>
```bash
# No more generateObject import
! grep -q "import.*generateObject.*from.*ai" agents/classifier.ts
# Has new imports
grep -q "generateText" agents/classifier.ts
grep -q "Output.object" agents/classifier.ts
grep -q "NoObjectGeneratedError" agents/classifier.ts
# TypeScript compiles
cd /Users/medelman/GitHub/medelman17/vibedocs && pnpm exec tsc --noEmit agents/classifier.ts 2>&1 | head -20
```
  </verify>
  <done>classifier.ts uses generateText + Output.object() with NoObjectGeneratedError handling</done>
</task>

<task type="auto">
  <name>Task 2: Migrate risk-scorer agent</name>
  <files>agents/risk-scorer.ts</files>
  <action>
Migrate risk-scorer.ts from generateObject to generateText + Output.object():

1. **Update imports**:
```typescript
// Before:
import { generateObject } from 'ai'

// After:
import { generateText, Output, NoObjectGeneratedError } from 'ai'
import { AnalysisFailedError } from '@/lib/errors'
```

2. **Update the generateObject call** (around line 90):
```typescript
// Before:
const { object, usage } = await generateObject({
  model: getAgentModel('riskScorer'),
  system: RISK_SCORER_SYSTEM_PROMPT,
  prompt,
  schema: riskAssessmentSchema,
})

// After - wrap in try/catch:
let result
try {
  result = await generateText({
    model: getAgentModel('riskScorer'),
    system: RISK_SCORER_SYSTEM_PROMPT,
    prompt,
    output: Output.object({ schema: riskAssessmentSchema }),
  })
} catch (error) {
  if (NoObjectGeneratedError.isInstance(error)) {
    console.error('[RiskScorer] Object generation failed', {
      clauseId: clause.chunkId,
      cause: error.cause,
      text: error.text?.slice(0, 500),
    })
    throw new AnalysisFailedError(
      'Risk scoring failed to produce valid output',
      [{ field: 'clause', message: clause.chunkId }]
    )
  }
  throw error
}

const { output, usage } = result
```

3. **Update property access**:
- Change `object.riskLevel` to `output.riskLevel`
- Change `object.confidence` to `output.confidence`
- Change `object.explanation` to `output.explanation`
- Change `object.evidence` to `output.evidence`
  </action>
  <verify>
```bash
# No more generateObject import
! grep -q "import.*generateObject.*from.*ai" agents/risk-scorer.ts
# Has new imports
grep -q "generateText" agents/risk-scorer.ts
grep -q "Output.object" agents/risk-scorer.ts
# TypeScript compiles
cd /Users/medelman/GitHub/medelman17/vibedocs && pnpm exec tsc --noEmit agents/risk-scorer.ts 2>&1 | head -20
```
  </verify>
  <done>risk-scorer.ts uses generateText + Output.object() with NoObjectGeneratedError handling</done>
</task>

<task type="auto">
  <name>Task 3: Migrate gap-analyst agent</name>
  <files>agents/gap-analyst.ts</files>
  <action>
Migrate gap-analyst.ts from generateObject to generateText + Output.object(). This agent has TWO generateObject calls - both need migration.

1. **Update imports**:
```typescript
// Before:
import { generateObject } from 'ai'

// After:
import { generateText, Output, NoObjectGeneratedError } from 'ai'
import { AnalysisFailedError } from '@/lib/errors'
```

2. **Migrate first generateObject call** (gap analysis, around line 156):
```typescript
// Before:
const { object: gapResult, usage: gapUsage } = await generateObject({
  model: getAgentModel('gapAnalyst'),
  system: GAP_ANALYST_SYSTEM_PROMPT,
  prompt: gapPrompt,
  schema: gapAnalysisSchema,
})

// After:
let gapGenResult
try {
  gapGenResult = await generateText({
    model: getAgentModel('gapAnalyst'),
    system: GAP_ANALYST_SYSTEM_PROMPT,
    prompt: gapPrompt,
    output: Output.object({ schema: gapAnalysisSchema }),
  })
} catch (error) {
  if (NoObjectGeneratedError.isInstance(error)) {
    console.error('[GapAnalyst] Gap analysis generation failed', {
      cause: error.cause,
      text: error.text?.slice(0, 500),
    })
    throw new AnalysisFailedError(
      'Gap analysis failed to produce valid output',
      [{ field: 'gaps', message: 'Model output invalid' }]
    )
  }
  throw error
}
const { output: gapResult, usage: gapUsage } = gapGenResult
```

3. **Migrate second generateObject call** (hypothesis testing loop, around line 178):
```typescript
// Before:
const { object, usage } = await generateObject({
  model: getAgentModel('gapAnalyst'),
  system: GAP_ANALYST_SYSTEM_PROMPT,
  prompt: buildHypothesisPrompt(hypothesis, clauses),
  schema: hypothesisSchema,
})

// After:
let hypResult
try {
  hypResult = await generateText({
    model: getAgentModel('gapAnalyst'),
    system: GAP_ANALYST_SYSTEM_PROMPT,
    prompt: buildHypothesisPrompt(hypothesis, clauses),
    output: Output.object({ schema: hypothesisSchema }),
  })
} catch (error) {
  if (NoObjectGeneratedError.isInstance(error)) {
    console.error('[GapAnalyst] Hypothesis test failed', {
      hypothesisId: hypothesis.id,
      cause: error.cause,
    })
    // Continue with next hypothesis rather than failing entire analysis
    continue
  }
  throw error
}
const { output, usage } = hypResult
```

4. **Update property access**:
- First call: already uses `gapResult.presentCategories`, `gapResult.missingCategories`, `gapResult.weakClauses` - these stay the same since we renamed to `gapResult`
- Second call: `object.status` → `output.status`, `object.supportingClauseId` → `output.supportingClauseId`, `object.explanation` → `output.explanation`
  </action>
  <verify>
```bash
# No more generateObject import
! grep -q "import.*generateObject.*from.*ai" agents/gap-analyst.ts
# Has new imports
grep -q "generateText" agents/gap-analyst.ts
grep -q "Output.object" agents/gap-analyst.ts
# Two Output.object calls (gap analysis + hypothesis)
test $(grep -c "Output.object" agents/gap-analyst.ts) -ge 2
# TypeScript compiles
cd /Users/medelman/GitHub/medelman17/vibedocs && pnpm exec tsc --noEmit agents/gap-analyst.ts 2>&1 | head -20
```
  </verify>
  <done>gap-analyst.ts uses generateText + Output.object() for both LLM calls with error handling</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run `pnpm exec tsc --noEmit` on all agent files
2. Verify no generateObject imports remain: `grep -r "generateObject" agents/*.ts`
3. Verify Output.object is used: `grep -r "Output.object" agents/*.ts`
4. Run existing tests: `pnpm test agents/`
</verification>

<success_criteria>
- Zero generateObject imports in agents/ directory
- All three agents use generateText + Output.object() pattern
- All agents handle NoObjectGeneratedError
- TypeScript compilation passes
- Existing agent tests pass (mocks may need adjustment for new API)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-hardening/01-02-SUMMARY.md`
</output>
