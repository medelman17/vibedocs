---
phase: 06-cuad-classification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - db/schema/analyses.ts
  - agents/types.ts
autonomous: true

must_haves:
  truths:
    - "chunkClassifications table exists with multi-label support"
    - "Zod schemas validate batch classification output with primary + secondary labels"
    - "'Uncategorized' is a valid classification label distinct from 'Unknown'"
  artifacts:
    - path: "db/schema/analyses.ts"
      provides: "chunkClassifications table definition"
      contains: "chunkClassifications"
    - path: "agents/types.ts"
      provides: "multiLabelClassificationSchema and batch classification types"
      contains: "multiLabelClassificationSchema"
  key_links:
    - from: "db/schema/analyses.ts"
      to: "db/schema/documents.ts"
      via: "FK references to documentChunks.id and documents.id"
      pattern: "references.*documentChunks|references.*documents"
---

<objective>
Create the database schema and TypeScript types for Phase 6 multi-label CUAD classification.

Purpose: The new `chunkClassifications` junction table enables storing multiple category labels per chunk (primary + secondary), which the existing `clauseExtractions` table cannot cleanly support. The enhanced Zod schemas define the batch classification output format used by the enhanced classifier agent.

Output: `chunkClassifications` table in `db/schema/analyses.ts`, `multiLabelClassificationSchema` and related types in `agents/types.ts`
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-cuad-classification/06-CONTEXT.md
@.planning/phases/06-cuad-classification/06-RESEARCH.md
@db/schema/analyses.ts
@db/schema/documents.ts
@db/_columns.ts
@agents/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add chunkClassifications table to schema</name>
  <files>db/schema/analyses.ts</files>
  <action>
Add a new `chunkClassifications` table to `db/schema/analyses.ts` (after the `clauseExtractions` table). This table stores multi-label CUAD classifications per chunk.

**Table definition:**
```typescript
export const chunkClassifications = pgTable(
  "chunk_classifications",
  {
    ...primaryId,
    ...tenantId,
    analysisId: uuid("analysis_id").notNull()
      .references(() => analyses.id, { onDelete: "cascade" }),
    chunkId: uuid("chunk_id").notNull()
      .references(() => documentChunks.id, { onDelete: "cascade" }),
    documentId: uuid("document_id").notNull()
      .references(() => documents.id, { onDelete: "cascade" }),
    category: text("category").notNull(),
    confidence: real("confidence").notNull(),
    isPrimary: boolean("is_primary").notNull().default(true),
    rationale: text("rationale"),
    chunkIndex: integer("chunk_index").notNull(),
    startPosition: integer("start_position"),
    endPosition: integer("end_position"),
    ...timestamps,
  },
  (table) => [
    index("idx_chunk_class_analysis").on(table.analysisId),
    index("idx_chunk_class_category").on(table.analysisId, table.category),
    index("idx_chunk_class_chunk").on(table.chunkId),
    index("idx_chunk_class_document_order").on(table.analysisId, table.chunkIndex),
    unique("chunk_class_unique").on(table.analysisId, table.chunkId, table.category),
  ]
)
```

**Key design notes:**
- `isPrimary` distinguishes the highest-confidence label from secondary labels
- `chunkIndex` is denormalized from chunk for efficient document-order queries without join
- Unique constraint on (analysisId, chunkId, category) prevents duplicate labels and enables `ON CONFLICT DO NOTHING` for idempotent inserts
- Cascading deletes from analysis, chunk, and document
- Do NOT modify the existing `clauseExtractions` table (per CONTEXT.md decision)

Ensure `boolean` is imported from `drizzle-orm/pg-core` (check existing imports).
  </action>
  <verify>Run `pnpm build` and check for TypeScript compilation errors in the schema file. The new table should export from `db/schema/analyses.ts`.</verify>
  <done>`chunkClassifications` table defined with all columns, indexes, and unique constraint. Exported alongside `analyses` and `clauseExtractions`.</done>
</task>

<task type="auto">
  <name>Task 2: Add multi-label classification schemas and types</name>
  <files>agents/types.ts</files>
  <action>
Add the following to `agents/types.ts`:

1. **Extended category type** that includes "Uncategorized":
```typescript
/** Extended categories including Uncategorized for chunks matching no CUAD category */
export const EXTENDED_CATEGORIES = [...CUAD_CATEGORIES, 'Uncategorized'] as const
export type ExtendedCategory = (typeof EXTENDED_CATEGORIES)[number]
export const extendedCategorySchema = z.enum(EXTENDED_CATEGORIES)
```

2. **Batch classification output schema** (used by the enhanced classifier agent):
```typescript
/** Single chunk classification result within a batch */
export const chunkClassificationResultSchema = z.object({
  chunkIndex: z.number().describe('Index of the chunk in the batch (0-based)'),
  primary: z.object({
    category: extendedCategorySchema,
    confidence: z.number().min(0).max(1),
    rationale: z.string().max(200).describe('Brief 1-2 sentence explanation'),
  }),
  secondary: z.array(z.object({
    category: cuadCategorySchema,
    confidence: z.number().min(0).max(1),
  })).max(2).default([]),
})

/** Batch classification output from enhanced classifier */
export const multiLabelClassificationSchema = z.object({
  classifications: z.array(chunkClassificationResultSchema),
})

export type ChunkClassificationResult = z.infer<typeof chunkClassificationResultSchema>
export type MultiLabelClassificationOutput = z.infer<typeof multiLabelClassificationSchema>
```

**Important notes:**
- Primary category uses `extendedCategorySchema` (includes "Uncategorized")
- Secondary categories use `cuadCategorySchema` (no "Uncategorized" for secondaries - only CUAD categories)
- Secondary array max 2 items (1 primary + max 2 secondary = 3 total per chunk, per RESEARCH.md recommendation)
- `rationale` max 200 chars, present only on primary classification
- Do NOT modify the existing `classificationSchema` - it's still used by the current classifier until the pipeline is rewired

3. **Classification constants:**
```typescript
/** Classification confidence thresholds */
export const CLASSIFICATION_THRESHOLDS = {
  /** Below this, classify as Uncategorized */
  MINIMUM_FLOOR: 0.3,
  /** Below this, flag for review */
  LOW_CONFIDENCE: 0.7,
} as const
```
  </action>
  <verify>Run `pnpm build` to verify TypeScript compilation. Check that `multiLabelClassificationSchema` validates correctly by inspecting the type inference.</verify>
  <done>New schemas exported: `extendedCategorySchema`, `multiLabelClassificationSchema`, `chunkClassificationResultSchema`, `CLASSIFICATION_THRESHOLDS`. Types exported: `ExtendedCategory`, `ChunkClassificationResult`, `MultiLabelClassificationOutput`.</done>
</task>

</tasks>

<verification>
1. `pnpm build` passes without errors
2. `chunkClassifications` table is exported from `db/schema/analyses.ts`
3. `multiLabelClassificationSchema` is exported from `agents/types.ts`
4. `EXTENDED_CATEGORIES` array includes all 41 CUAD categories plus "Uncategorized" (42 total)
5. Existing `classificationSchema` and `clauseExtractions` table are unchanged
</verification>

<success_criteria>
- New `chunkClassifications` table has FK references to analyses, documentChunks, and documents
- Multi-label schema supports primary (1) + secondary (max 2) classification per chunk
- "Uncategorized" is explicitly available as a category value
- Confidence thresholds constants are exported for use by classifier and UI
- No changes to existing tables or schemas that would break the current pipeline
</success_criteria>

<output>
After completion, create `.planning/phases/06-cuad-classification/06-01-SUMMARY.md`
</output>
