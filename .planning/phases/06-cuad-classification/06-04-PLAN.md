---
phase: 06-cuad-classification
plan: 04
type: execute
wave: 3
depends_on: ["06-01"]
files_modified:
  - db/queries/classifications.ts
  - app/(main)/(dashboard)/analyses/actions.ts
  - components/artifact/analysis-view.tsx
autonomous: true

must_haves:
  truths:
    - "Classifications can be queried grouped by CUAD category"
    - "Classifications can be queried in document order"
    - "UI shows classification view with toggle between category and document views"
    - "Low-confidence classifications (< 0.7) display a review badge"
    - "Uncategorized chunks are explicitly visible in the classification list"
  artifacts:
    - path: "db/queries/classifications.ts"
      provides: "Classification queries by category and document order"
      exports: ["getClassificationsByCategory", "getClassificationsByPosition"]
    - path: "app/(main)/(dashboard)/analyses/actions.ts"
      provides: "Server actions for classification data retrieval"
      exports: ["getAnalysisClassifications"]
    - path: "components/artifact/analysis-view.tsx"
      provides: "Classification view with dual-view toggle and confidence badges"
      contains: "ClassificationView"
  key_links:
    - from: "components/artifact/analysis-view.tsx"
      to: "app/(main)/(dashboard)/analyses/actions.ts"
      via: "getAnalysisClassifications server action"
      pattern: "getAnalysisClassifications"
    - from: "app/(main)/(dashboard)/analyses/actions.ts"
      to: "db/queries/classifications.ts"
      via: "Query functions for classification data"
      pattern: "getClassificationsByCategory|getClassificationsByPosition"
---

<objective>
Add classification queries, server actions, and UI components to display multi-label CUAD classifications with dual-view support (grouped by category and document order).

Purpose: The user needs to see classification results in two views: grouped by CUAD category (showing all instances per category) and in document order (showing classifications as they appear in the document). Low-confidence classifications (< 0.7) need a visual flag for review. Uncategorized chunks must be explicitly visible.

Output: Query functions in `db/queries/classifications.ts`, server action in analyses actions, and enhanced analysis view component with classification toggle
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-cuad-classification/06-CONTEXT.md
@.planning/phases/06-cuad-classification/06-RESEARCH.md
@.planning/phases/06-cuad-classification/06-01-SUMMARY.md
@db/schema/analyses.ts
@db/queries/index.ts
@app/(main)/(dashboard)/analyses/actions.ts
@components/artifact/analysis-view.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create classification query functions and server action</name>
  <files>db/queries/classifications.ts, db/queries/index.ts, app/(main)/(dashboard)/analyses/actions.ts</files>
  <action>
**1. Create `db/queries/classifications.ts`:**

New file with two query functions for the two views required by CONTEXT.md:

```typescript
import { db } from '@/db/client'
import { chunkClassifications } from '@/db/schema/analyses'
import { eq, and, desc, asc } from 'drizzle-orm'

/** Classification row type */
export type ChunkClassificationRow = typeof chunkClassifications.$inferSelect

/** Classifications grouped by CUAD category */
export interface ClassificationsByCategory {
  category: string
  classifications: ChunkClassificationRow[]
}

/**
 * Get classifications grouped by CUAD category for an analysis.
 * Each category lists all matching chunks (not just highest confidence).
 * Ordered by category name, then confidence descending within category.
 */
export async function getClassificationsByCategory(
  analysisId: string,
  tenantId: string
): Promise<ClassificationsByCategory[]> {
  const rows = await db
    .select()
    .from(chunkClassifications)
    .where(
      and(
        eq(chunkClassifications.analysisId, analysisId),
        eq(chunkClassifications.tenantId, tenantId)
      )
    )
    .orderBy(
      asc(chunkClassifications.category),
      desc(chunkClassifications.confidence)
    )

  // Group by category
  const grouped = new Map<string, ChunkClassificationRow[]>()
  for (const row of rows) {
    const existing = grouped.get(row.category) ?? []
    existing.push(row)
    grouped.set(row.category, existing)
  }

  return Array.from(grouped.entries()).map(([category, classifications]) => ({
    category,
    classifications,
  }))
}

/**
 * Get classifications in document order for an analysis.
 * Sorted by chunk index (document position), then primary first within each chunk.
 */
export async function getClassificationsByPosition(
  analysisId: string,
  tenantId: string
): Promise<ChunkClassificationRow[]> {
  return db
    .select()
    .from(chunkClassifications)
    .where(
      and(
        eq(chunkClassifications.analysisId, analysisId),
        eq(chunkClassifications.tenantId, tenantId)
      )
    )
    .orderBy(
      asc(chunkClassifications.chunkIndex),
      desc(chunkClassifications.isPrimary)
    )
}
```

**2. Update `db/queries/index.ts`:**

Add export for the new query module:
```typescript
export * from "./classifications"
```

**3. Add server action to `app/(main)/(dashboard)/analyses/actions.ts`:**

Add a new `getAnalysisClassifications` server action:

```typescript
import { chunkClassifications } from "@/db/schema";
import {
  getClassificationsByCategory,
  getClassificationsByPosition,
  type ChunkClassificationRow,
  type ClassificationsByCategory,
} from "@/db/queries/classifications";
```

Add the type export:
```typescript
export type { ChunkClassificationRow, ClassificationsByCategory };
```

Add the action function:
```typescript
/**
 * Get CUAD classifications for an analysis.
 *
 * Supports two views:
 * - "category": Grouped by CUAD category with all instances
 * - "position": In document order (by chunk index)
 *
 * @param analysisId - UUID of the analysis
 * @param view - View mode: "category" or "position"
 */
export async function getAnalysisClassifications(
  analysisId: string,
  view: "category" | "position" = "category"
): Promise<ApiResponse<ClassificationsByCategory[] | ChunkClassificationRow[]>> {
  if (!z.string().uuid().safeParse(analysisId).success) {
    return err("VALIDATION_ERROR", "Invalid analysis ID");
  }

  const { db, tenantId } = await withTenant();

  // Verify analysis exists and belongs to tenant
  const analysis = await db.query.analyses.findFirst({
    where: and(
      eq(analyses.id, analysisId),
      eq(analyses.tenantId, tenantId)
    ),
    columns: { id: true },
  });

  if (!analysis) {
    return err("NOT_FOUND", "Analysis not found");
  }

  if (view === "category") {
    const result = await getClassificationsByCategory(analysisId, tenantId);
    return ok(result);
  } else {
    const result = await getClassificationsByPosition(analysisId, tenantId);
    return ok(result);
  }
}
```

Note: The `db` import from `withTenant()` is not used directly here since the query functions use their own db connection. The `withTenant()` call is for tenant verification. This is fine - the query functions in `db/queries/classifications.ts` use the shared db client and include tenantId filtering.
  </action>
  <verify>Run `pnpm build` and verify compilation of queries and actions. Check that `getAnalysisClassifications` is exported from the actions module.</verify>
  <done>Classification queries support both category-grouped and document-order views. Server action wraps queries with tenant verification. Types exported for client consumption.</done>
</task>

<task type="auto">
  <name>Task 2: Add classification view with dual-view toggle and confidence badges</name>
  <files>components/artifact/analysis-view.tsx</files>
  <action>
Enhance the analysis view component to display classification results alongside the existing clause/risk view.

**Add imports:**
```typescript
import {
  getAnalysisClassifications,
  type ChunkClassificationRow,
  type ClassificationsByCategory,
} from "@/app/(main)/(dashboard)/analyses/actions"
import { CLASSIFICATION_THRESHOLDS } from "@/agents/types"
```

**Add new components:**

1. **ConfidenceBadge** - Inline badge showing confidence with low-confidence visual flag:
```typescript
function ConfidenceBadge({ confidence }: { confidence: number }) {
  const isLow = confidence < CLASSIFICATION_THRESHOLDS.LOW_CONFIDENCE
  return (
    <Badge
      variant="outline"
      className={cn(
        "gap-1 text-xs",
        isLow && "border-amber-300 bg-amber-50 text-amber-700 dark:border-amber-600 dark:bg-amber-950 dark:text-amber-400"
      )}
    >
      {isLow && <AlertTriangleIcon className="size-3" />}
      {Math.round(confidence * 100)}%
      {isLow && " Review"}
    </Badge>
  )
}
```

2. **ClassificationCard** - Single classification entry:
```typescript
function ClassificationCard({ classification }: { classification: ChunkClassificationRow }) {
  const [open, setOpen] = React.useState(false)
  return (
    <Collapsible open={open} onOpenChange={setOpen}>
      <Card className="min-w-0">
        <CardHeader className="pb-2">
          <div className="flex min-w-0 items-start justify-between gap-2">
            <div className="min-w-0">
              <CardTitle className="min-w-0 truncate text-sm font-medium">
                {classification.category}
              </CardTitle>
              {!classification.isPrimary && (
                <span className="text-xs text-muted-foreground">Secondary</span>
              )}
            </div>
            <ConfidenceBadge confidence={classification.confidence} />
          </div>
          {classification.rationale && (
            <p className="line-clamp-2 text-sm text-muted-foreground">
              {classification.rationale}
            </p>
          )}
        </CardHeader>
        <CardContent className="pt-0">
          <CollapsibleTrigger className="flex w-full items-center gap-1 text-xs text-muted-foreground hover:text-foreground">
            {open ? <ChevronDownIcon className="size-3" /> : <ChevronRightIcon className="size-3" />}
            {open ? "Hide details" : "Show chunk"}
          </CollapsibleTrigger>
          <CollapsibleContent className="pt-3">
            <p className="text-xs text-muted-foreground">
              Chunk {classification.chunkIndex + 1}
              {classification.startPosition != null && ` (pos ${classification.startPosition}-${classification.endPosition})`}
            </p>
          </CollapsibleContent>
        </CardContent>
      </Card>
    </Collapsible>
  )
}
```

3. **CategoryGroupView** - Classifications grouped by category:
```typescript
function CategoryGroupView({ groups }: { groups: ClassificationsByCategory[] }) {
  return (
    <div className="space-y-4">
      {groups.map(group => (
        <div key={group.category}>
          <h4 className="mb-2 flex items-center gap-2 text-sm font-semibold">
            {group.category}
            <Badge variant="secondary" className="text-xs">{group.classifications.length}</Badge>
          </h4>
          <div className="space-y-2 pl-2">
            {group.classifications.map(c => (
              <ClassificationCard key={c.id} classification={c} />
            ))}
          </div>
        </div>
      ))}
    </div>
  )
}
```

4. **DocumentOrderView** - Classifications in document order:
```typescript
function DocumentOrderView({ classifications }: { classifications: ChunkClassificationRow[] }) {
  return (
    <div className="space-y-2">
      {classifications.map(c => (
        <ClassificationCard key={c.id} classification={c} />
      ))}
    </div>
  )
}
```

5. **ClassificationView** - Main view with toggle:
```typescript
function ClassificationView({ analysisId }: { analysisId: string }) {
  const [view, setView] = React.useState<"category" | "position">("category")
  const [categoryData, setCategoryData] = React.useState<ClassificationsByCategory[]>([])
  const [positionData, setPositionData] = React.useState<ChunkClassificationRow[]>([])
  const [loading, setLoading] = React.useState(true)

  React.useEffect(() => {
    setLoading(true)
    getAnalysisClassifications(analysisId, view)
      .then(result => {
        if (result.success) {
          if (view === "category") {
            setCategoryData(result.data as ClassificationsByCategory[])
          } else {
            setPositionData(result.data as ChunkClassificationRow[])
          }
        }
      })
      .finally(() => setLoading(false))
  }, [analysisId, view])

  if (loading) {
    return <div className="flex items-center justify-center p-4"><Loader2Icon className="size-5 animate-spin" /></div>
  }

  return (
    <div className="space-y-3">
      {/* Toggle */}
      <div className="flex gap-1 rounded-md border p-1">
        <button
          className={cn(
            "flex-1 rounded px-3 py-1.5 text-xs font-medium transition-colors",
            view === "category" ? "bg-primary text-primary-foreground" : "hover:bg-muted"
          )}
          onClick={() => setView("category")}
        >
          By Category
        </button>
        <button
          className={cn(
            "flex-1 rounded px-3 py-1.5 text-xs font-medium transition-colors",
            view === "position" ? "bg-primary text-primary-foreground" : "hover:bg-muted"
          )}
          onClick={() => setView("position")}
        >
          Document Order
        </button>
      </div>

      {/* Content */}
      {view === "category" ? (
        <CategoryGroupView groups={categoryData} />
      ) : (
        <DocumentOrderView classifications={positionData} />
      )}
    </div>
  )
}
```

**Integrate into the main `AnalysisView` component:**

In the completed analysis view (after the summary bar), add a tab-like section that shows both the existing clause cards AND the new classification view. Add a simple section header "Classifications" with the ClassificationView rendered below the summary bar, above the existing clause list.

The layout in the completed state should be:
1. Summary bar (existing - risk badges and score)
2. Classifications section with toggle (NEW)
3. Existing clause list (existing)

Add the ClassificationView between the summary bar and the clause list:
```tsx
{/* Classification results */}
<div className="border-b px-4 py-3">
  <h4 className="mb-3 text-sm font-medium text-muted-foreground">CUAD Classifications</h4>
  <ClassificationView analysisId={analysisId} />
</div>
```

This goes BEFORE the existing `<ScrollArea>` with the clause list.

**Important:** The ClassificationView is view-only (per CONTEXT.md decision - no user override in this phase).
  </action>
  <verify>Run `pnpm build` and verify compilation. Check that the component renders without errors by reviewing the import paths and type usage.</verify>
  <done>Analysis view displays classification results with category/document-order toggle. Low-confidence classifications show amber "Review" badge. Uncategorized chunks appear in the list. Both views are functional and read-only.</done>
</task>

</tasks>

<verification>
1. `pnpm build` passes without errors
2. `db/queries/classifications.ts` exports `getClassificationsByCategory` and `getClassificationsByPosition`
3. `db/queries/index.ts` re-exports the new query module
4. `getAnalysisClassifications` server action is exported from analyses actions
5. Classification view renders with toggle between "By Category" and "Document Order"
6. Low-confidence (< 0.7) classifications show amber "Review" badge with AlertTriangleIcon
7. "Uncategorized" entries appear in both views when present
8. Existing clause cards and risk view remain unchanged
</verification>

<success_criteria>
- Document-level clause list supports both category-grouped and document-order views with toggle (CLS-06)
- Low-confidence classifications visually flagged (CLS-05)
- Multi-category clauses show primary and secondary labels (CLS-04)
- Uncategorized chunks explicitly visible (CONTEXT.md decision)
- View-only interaction (no user override per CONTEXT.md)
- No breaking changes to existing analysis view functionality
</success_criteria>

<output>
After completion, create `.planning/phases/06-cuad-classification/06-04-SUMMARY.md`
</output>
