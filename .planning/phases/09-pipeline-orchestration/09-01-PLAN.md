---
phase: 09-pipeline-orchestration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - db/schema/analyses.ts
  - inngest/types.ts
  - inngest/functions/analyze-nda.ts
autonomous: true

must_haves:
  truths:
    - "Analysis status 'cancelled' is a valid DB value distinct from 'failed'"
    - "Progress messages stored in dedicated column, not buried in metadata JSONB"
    - "emitProgress never creates duplicate step IDs even when called multiple times for same stage"
    - "cancelOn configuration stops the pipeline when cancellation event fires"
    - "Both analyzeNda and analyzeNdaAfterOcr functions support cancelOn"
  artifacts:
    - path: "db/schema/analyses.ts"
      provides: "cancelled status value and progressMessage text column"
      contains: "progressMessage"
    - path: "inngest/functions/analyze-nda.ts"
      provides: "cancelOn config, fixed emitProgress with unique step IDs"
      contains: "cancelOn"
  key_links:
    - from: "inngest/functions/analyze-nda.ts"
      to: "inngest/types.ts"
      via: "nda/analysis.cancelled event reference in cancelOn"
      pattern: "nda/analysis.cancelled"
    - from: "inngest/functions/analyze-nda.ts"
      to: "db/schema/analyses.ts"
      via: "progressMessage column in emitProgress DB update"
      pattern: "progressMessage"
---

<objective>
Add cancelled status, progress message column, fix duplicate step IDs, and wire cancelOn to both pipeline functions.

Purpose: Foundation for cancellation and granular progress. The emitProgress bug and missing cancelled status are blockers for all other Phase 9 work.
Output: Schema with cancelled status + progressMessage column, both pipeline functions with cancelOn config, emitProgress with monotonic counter for unique step IDs.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-pipeline-orchestration/09-RESEARCH.md
@inngest/functions/analyze-nda.ts
@db/schema/analyses.ts
@inngest/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema changes and event type updates</name>
  <files>db/schema/analyses.ts, inngest/types.ts, app/(main)/(dashboard)/analyses/actions.ts</files>
  <action>
  1. In `db/schema/analyses.ts`, add a `progressMessage` text column to the `analyses` table:
     ```typescript
     progressMessage: text("progress_message"),
     ```
     Place it right after the existing `progressPercent` column definition.

  2. In `inngest/types.ts`, add `'cancelled'` to the `analysisProgressPayload.stage` enum:
     ```typescript
     stage: z.enum([
       "parsing", "chunking", "ocr_processing", "classifying",
       "scoring", "analyzing_gaps", "complete", "failed", "cancelled",
     ]),
     ```

  3. In `app/(main)/(dashboard)/analyses/actions.ts`:
     - Update `AnalysisStatus` type to include `'cancelled'`:
       ```typescript
       export type AnalysisStatus = "pending" | "pending_ocr" | "processing" | "completed" | "failed" | "cancelled";
       ```
     - Add `'cancelled'` to `paginationSchema.status` enum:
       ```typescript
       status: z.enum(["pending", "pending_ocr", "processing", "completed", "failed", "cancelled"]).optional(),
       ```
     - In `getAnalysisStatus`, add a stage message for `cancelled`:
       ```typescript
       cancelled: "Analysis cancelled",
       ```
     - Update the terminal state check in `getAnalysisStatus` to include `'cancelled'`:
       The status cast should handle `'cancelled'` since the type is updated.
     - In the `useAnalysisProgress` hook consumer, ensure `cancelled` is treated as terminal (same as `completed`/`failed`).

  Note: Schema changes are applied via `pnpm db:push` (handled separately). The status column is a plain `text()` column, not an enum, so no migration is needed -- the new values are valid immediately.
  </action>
  <verify>Run `pnpm lint` to confirm no type errors from the schema and type changes.</verify>
  <done>progressMessage column defined in schema, 'cancelled' status recognized in types and actions, stage messages include 'cancelled'.</done>
</task>

<task type="auto">
  <name>Task 2: Fix emitProgress duplicate step IDs and add cancelOn</name>
  <files>inngest/functions/analyze-nda.ts</files>
  <action>
  Fix the emitProgress helper and add cancelOn to both pipeline functions.

  **Fix emitProgress in analyzeNda:**

  Replace the current `emitProgress` closure with a version that uses a monotonic counter for unique step IDs and persists `progressMessage`:

  ```typescript
  // Monotonic counter for unique progress step IDs
  let progressCounter = 0

  const emitProgress = async (
    stage: ProgressStage,
    progress: number,
    message: string
  ) => {
    const clampedProgress = Math.max(0, Math.min(100, progress))
    const stepSuffix = `${stage}-${progressCounter++}`

    // Persist progress to DB in a durable step
    await step.run(`update-progress-${stepSuffix}`, async () => {
      await ctx.db
        .update(analyses)
        .set({
          progressStage: stage,
          progressPercent: clampedProgress,
          progressMessage: message,
          updatedAt: new Date(),
        })
        .where(eq(analyses.id, analysisId))
    })

    // Also emit event for real-time consumers (future SSE)
    await step.sendEvent(`emit-progress-${stepSuffix}`, {
      name: 'nda/analysis.progress',
      data: {
        documentId,
        analysisId,
        tenantId,
        stage,
        progress: clampedProgress,
        message,
      },
    })
  }
  ```

  **Apply the same fix to analyzeNdaAfterOcr's emitProgress** -- identical pattern with its own `progressCounter` variable initialized at `let progressCounter = 0`.

  **Add cancelOn to analyzeNda:**

  Update the function config:
  ```typescript
  export const analyzeNda = inngest.createFunction(
    {
      id: 'analyze-nda',
      name: 'NDA Analysis Pipeline',
      concurrency: CONCURRENCY.analysis,
      retries: RETRY_CONFIG.default.retries,
      cancelOn: [{
        event: 'nda/analysis.cancelled',
        if: 'async.data.analysisId == event.data.analysisId',
      }],
    },
    // ... rest unchanged
  ```

  Note the CEL syntax: `async` = the cancel event, `event` = the original trigger event. Both have `analysisId` in their data (the original from `analysisRequestedPayload` may not have `analysisId` since it's optional -- but we set it in `triggerAnalysis`). For safety, match on `documentId` instead since it's always present:

  Actually, checking the code: the pipeline creates a deterministic `analysisId` inside the function. The trigger event may have `analysisId` from `triggerAnalysis`. Use the match on whatever is available. Since `analysisCancelledPayload` has `analysisId` and `analysisRequestedPayload` also sends `analysisId` from the action, match on `analysisId`:

  But wait -- `analysisRequestedPayload` has `analysisId` as `.optional()`. If the action always sends it (which `triggerAnalysis` does), the match works. For the post-OCR function, `ocrCompletedPayload` also has `analysisId` (required). So the match is safe for both.

  **Add cancelOn to analyzeNdaAfterOcr:**

  Same pattern:
  ```typescript
  export const analyzeNdaAfterOcr = inngest.createFunction(
    {
      id: 'analyze-nda-after-ocr',
      name: 'NDA Analysis Pipeline (Post-OCR)',
      concurrency: CONCURRENCY.analysis,
      retries: RETRY_CONFIG.default.retries,
      cancelOn: [{
        event: 'nda/analysis.cancelled',
        if: 'async.data.analysisId == event.data.analysisId',
      }],
    },
    // ... rest unchanged
  ```

  For the post-OCR function, the `analysisId` in the trigger event (`nda/analysis.ocr-complete`) is required, so the match expression is reliable.
  </action>
  <verify>Run `pnpm lint` to confirm no errors. Verify step IDs are unique by searching for `update-progress-` and `emit-progress-` patterns -- they should all include the counter suffix now.</verify>
  <done>emitProgress uses monotonic counter (no duplicate step IDs), both analyzeNda and analyzeNdaAfterOcr have cancelOn configuration matching on analysisId, progressMessage persisted to DB in every emitProgress call.</done>
</task>

</tasks>

<verification>
1. `pnpm lint` passes with no new errors
2. Grep for `cancelOn` in analyze-nda.ts returns 2 matches (one per function)
3. Grep for `progressMessage` in analyses.ts confirms column exists
4. No remaining `update-progress-${stage}` patterns (all should be `update-progress-${stepSuffix}`)
</verification>

<success_criteria>
- Schema has progressMessage text column
- Both pipeline functions have cancelOn wired to nda/analysis.cancelled
- emitProgress uses monotonic counter for globally unique step IDs
- AnalysisStatus type includes 'cancelled'
- Types compile clean
</success_criteria>

<output>
After completion, create `.planning/phases/09-pipeline-orchestration/09-01-SUMMARY.md`
</output>
