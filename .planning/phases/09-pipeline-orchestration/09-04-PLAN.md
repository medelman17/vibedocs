---
phase: 09-pipeline-orchestration
plan: 04
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - app/(main)/(dashboard)/analyses/actions.ts
  - hooks/use-analysis-progress.ts
  - components/artifact/analysis-view.tsx
autonomous: true

must_haves:
  truths:
    - "Progress polling returns detailed message like 'Classifying clause 7 of 15...'"
    - "Cancelled analyses show 'Cancelled' state in UI with resume/restart options"
    - "Queue position visible when analysis is pending"
    - "Progress message updates on every poll cycle during processing"
  artifacts:
    - path: "app/(main)/(dashboard)/analyses/actions.ts"
      provides: "getAnalysisStatus returns progressMessage, getQueuePosition action"
      contains: "progressMessage"
    - path: "hooks/use-analysis-progress.ts"
      provides: "Extended hook with message field populated from progressMessage"
      contains: "message"
    - path: "components/artifact/analysis-view.tsx"
      provides: "UI renders cancelled state with resume/restart buttons"
      contains: "cancelled"
  key_links:
    - from: "hooks/use-analysis-progress.ts"
      to: "app/(main)/(dashboard)/analyses/actions.ts"
      via: "Polls getAnalysisStatus which now includes progressMessage"
      pattern: "getAnalysisStatus"
    - from: "components/artifact/analysis-view.tsx"
      to: "hooks/use-analysis-progress.ts"
      via: "Reads message field for detailed progress display"
      pattern: "useAnalysisProgress"
---

<objective>
Extend progress polling to include detailed messages and queue position, update UI for cancelled state with resume option.

Purpose: Users need to see granular progress ("Scoring clause 7 of 15...") and understand when their analysis is queued. Cancelled analyses need clear UX with options to resume or start fresh.
Output: Enhanced polling response with progressMessage, queue position action, analysis view with cancelled state UI.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-pipeline-orchestration/09-RESEARCH.md
@.planning/phases/09-pipeline-orchestration/09-01-PLAN.md
@app/(main)/(dashboard)/analyses/actions.ts
@hooks/use-analysis-progress.ts
@components/artifact/analysis-view.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend getAnalysisStatus with progressMessage and add queue position</name>
  <files>app/(main)/(dashboard)/analyses/actions.ts</files>
  <action>
  **Update AnalysisStatusResponse:**

  Add `message` and `queuePosition` to the response:

  ```typescript
  export interface AnalysisStatusResponse {
    status: AnalysisStatus;
    progress?: {
      step: string;
      percent: number;
      message: string;  // NEW: detailed progress message from DB
    };
    queuePosition?: number;  // NEW: position in queue (only when pending)
  }
  ```

  **Update getAnalysisStatus:**

  1. Add `progressMessage` to the queried columns:
     ```typescript
     columns: {
       status: true,
       progressStage: true,
       progressPercent: true,
       progressMessage: true,
     },
     ```

  2. Populate the `message` field from `progressMessage`:
     ```typescript
     const progress: AnalysisStatusResponse["progress"] = {
       step: analysis.progressStage
         ? stageMessages[analysis.progressStage] || analysis.progressStage
         : analysis.status === "pending"
           ? "Queued for analysis..."
           : analysis.status === "completed"
             ? "Complete"
             : analysis.status === "cancelled"
               ? "Cancelled"
               : "Processing...",
       percent: analysis.status === "completed"
         ? 100
         : analysis.progressPercent ?? 0,
       message: analysis.progressMessage
         ?? (analysis.progressStage ? stageMessages[analysis.progressStage] ?? "" : ""),
     };
     ```

  3. Add queue position for pending analyses. Query count of analyses ahead of this one:
     ```typescript
     let queuePosition: number | undefined;
     if (analysis.status === "pending" || analysis.status === "pending_ocr") {
       const [countResult] = await db
         .select({ count: count() })
         .from(analyses)
         .where(and(
           eq(analyses.tenantId, tenantId),
           inArray(analyses.status, ["pending", "processing", "pending_ocr"]),
         ));
       queuePosition = countResult?.count ?? 0;
     }
     ```

     Add `inArray` to the drizzle-orm imports if not already present.

  4. Return `queuePosition` in the response:
     ```typescript
     return ok({
       status: analysis.status as AnalysisStatus,
       progress,
       queuePosition,
     });
     ```

  **Update stage messages map** to include all stages from the types enum:

  ```typescript
  const stageMessages: Record<string, string> = {
    parsing: "Parsing document...",
    chunking: "Chunking document...",
    ocr_processing: "Processing OCR...",
    classifying: "Classifying clauses...",
    scoring: "Assessing risk levels...",
    analyzing_gaps: "Analyzing gaps...",
    complete: "Analysis complete",
    failed: "Analysis failed",
    cancelled: "Analysis cancelled",
  };
  ```
  </action>
  <verify>Run `pnpm lint`. Verify the status response includes `message` and `queuePosition` fields.</verify>
  <done>getAnalysisStatus returns progressMessage from DB, queue position for pending analyses, and covers all stage types in messages map.</done>
</task>

<task type="auto">
  <name>Task 2: Update progress hook and analysis view for cancelled state</name>
  <files>hooks/use-analysis-progress.ts, components/artifact/analysis-view.tsx</files>
  <action>
  **Update useAnalysisProgress hook:**

  1. Update `AnalysisProgressState` interface to include `message` and `queuePosition`:
     ```typescript
     interface AnalysisProgressState {
       status: AnalysisStatus
       progress: number
       stage: string
       message: string           // Detailed progress message
       queuePosition?: number    // Queue position when pending
       isLoading: boolean
       error: string | null
     }
     ```

  2. Initialize `message: ""` and `queuePosition: undefined` in default state.

  3. Populate `message` and `queuePosition` from polling response:
     ```typescript
     setState({
       status: result.data.status,
       progress: result.data.progress?.percent ?? 0,
       stage: result.data.progress?.step ?? "",
       message: result.data.progress?.message ?? "",
       queuePosition: result.data.queuePosition,
       isLoading: false,
       error: null,
     })
     ```

  4. Import `AnalysisStatus` type if not already (it's imported from the actions).

  **Update analysis-view.tsx for cancelled state:**

  Read the current analysis-view.tsx to understand its structure. Add handling for the cancelled state:

  1. When `status === 'cancelled'`, show a cancelled state UI with:
     - "Analysis Cancelled" heading
     - The progress message showing where it stopped
     - Two action buttons:
       a. "Resume" - calls `resumeAnalysis(analysisId)` to continue from where it stopped
       b. "Start Fresh" - calls `triggerAnalysis(documentId)` to create a new analysis
     - If partial results exist (some stages completed), show them

  2. Display the detailed `message` from useAnalysisProgress during processing states:
     - Replace or supplement the generic stage labels with the detailed message
     - E.g., show "Classifying clause 7 of 15..." instead of just "Classifying clauses..."

  3. When `queuePosition` is present and > 0, show queue position indicator:
     - "Your analysis is queued (position {queuePosition})"

  Use existing component patterns from the codebase (shadcn/ui buttons, card layouts). Import `resumeAnalysis` from the actions module.

  The cancelled state UI should include:
  ```tsx
  {status === 'cancelled' && (
    <div className="flex flex-col items-center gap-4 py-8">
      <div className="text-muted-foreground text-sm">Analysis was cancelled</div>
      <div className="flex gap-2">
        <Button
          variant="outline"
          onClick={() => resumeAnalysis(analysisId)}
        >
          Resume
        </Button>
        <Button
          variant="default"
          onClick={() => triggerAnalysis(documentId)}
        >
          Start Fresh
        </Button>
      </div>
    </div>
  )}
  ```

  Adapt this to the existing component structure and styling patterns in analysis-view.tsx.
  </action>
  <verify>Run `pnpm lint`. Verify the progress hook exposes `message` and `queuePosition`. Check that analysis-view handles 'cancelled' status with resume/restart buttons.</verify>
  <done>Progress hook provides detailed message and queue position, analysis view renders cancelled state with resume/restart options, detailed progress messages shown during processing.</done>
</task>

</tasks>

<verification>
1. `pnpm lint` passes
2. useAnalysisProgress hook has `message` and `queuePosition` in its return type
3. analysis-view.tsx handles `cancelled` status
4. getAnalysisStatus returns `progressMessage` from DB column
5. Queue position calculated for pending analyses
</verification>

<success_criteria>
- Detailed progress messages like "Classifying clause 7 of 15..." visible in UI
- Queue position shown when analysis is pending
- Cancelled state UI with Resume and Start Fresh buttons
- All stage types covered in progress messages
</success_criteria>

<output>
After completion, create `.planning/phases/09-pipeline-orchestration/09-04-SUMMARY.md`
</output>
