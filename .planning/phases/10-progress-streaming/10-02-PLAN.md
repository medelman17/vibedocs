---
phase: 10-progress-streaming
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - inngest/functions/analyze-nda.ts
autonomous: true

must_haves:
  truths:
    - "emitProgress publishes to Inngest Realtime channel in addition to DB persistence"
    - "Realtime publish is throttled to max 1 per second"
    - "Terminal events (complete, failed, cancelled) always publish regardless of throttle"
    - "DB persistence is unchanged (always writes, no throttle)"
    - "Both analyzeNda and analyzeNdaAfterOcr functions use publish()"
  artifacts:
    - path: "inngest/functions/analyze-nda.ts"
      provides: "Pipeline functions with realtime publish in emitProgress"
      contains: "publish"
  key_links:
    - from: "inngest/functions/analyze-nda.ts"
      to: "inngest/channels.ts"
      via: "import analysisChannel"
      pattern: "analysisChannel"
    - from: "inngest/functions/analyze-nda.ts"
      to: "@inngest/realtime"
      via: "publish() from handler destructuring"
      pattern: "publish"
---

<objective>
Update the emitProgress helper in both pipeline functions (analyzeNda and analyzeNdaAfterOcr) to publish progress events via Inngest Realtime in addition to the existing DB persistence.

Purpose: Pipeline progress events flow directly to clients in real-time via Inngest Realtime instead of requiring DB polling.
Output: Updated analyze-nda.ts with realtime publishing and 1/sec throttle.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-progress-streaming/10-RESEARCH.md
@.planning/phases/10-progress-streaming/10-CONTEXT.md
@.planning/phases/10-progress-streaming/10-01-SUMMARY.md

@inngest/functions/analyze-nda.ts
@inngest/channels.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add realtime publish to emitProgress in analyzeNda</name>
  <files>inngest/functions/analyze-nda.ts</files>
  <action>
    1. Add import at top of file:
       ```typescript
       import { analysisChannel } from '@/inngest/channels'
       ```

    2. In the `analyzeNda` function handler, destructure `publish` from the handler params:
       - Change `async ({ event, step })` to `async ({ event, step, publish })`

    3. Add throttle tracking variable at the same scope as `progressCounter`:
       ```typescript
       let lastPublishTime = 0
       ```

    4. Update the `emitProgress` function inside `analyzeNda` to add realtime publish AFTER the existing DB persistence step:
       - Keep the existing `step.run('update-progress-...')` DB write unchanged
       - Remove the existing `step.sendEvent('emit-progress-...')` call (the old "future SSE" hook). This is being replaced by `publish()`.
       - Add throttled publish:
         ```typescript
         // Publish to Inngest Realtime (throttled to max 1/sec per CONTEXT.md decision)
         const now = Date.now()
         const isTerminal = stage === 'complete' || stage === 'failed' || stage === 'cancelled'
         if (isTerminal || now - lastPublishTime >= 1000) {
           await publish(
             analysisChannel(analysisId).progress({
               stage,
               percent: clampedProgress,
               message,
             })
           )
           lastPublishTime = now
         }
         ```

    5. Apply the SAME changes to the `analyzeNdaAfterOcr` function:
       - Destructure `publish` from handler params
       - Add `lastPublishTime` variable
       - Replace `step.sendEvent('emit-progress-...')` with throttled `publish()` in its emitProgress
       - Keep DB persistence unchanged

    IMPORTANT:
    - The `publish()` function is injected by `realtimeMiddleware()` — it comes from the handler destructuring, not an import
    - `publish()` is NOT wrapped in `step.run()` — it's a fire-and-forget side effect (at-most-once delivery is acceptable)
    - The `step.sendEvent('nda/analysis.progress')` calls are REMOVED (replaced by publish). The DB persistence remains as the source of truth.
    - Terminal events (complete, failed, cancelled) ALWAYS publish regardless of throttle
  </action>
  <verify>
    - `pnpm build` succeeds
    - `inngest/functions/analyze-nda.ts` imports `analysisChannel`
    - Both `analyzeNda` and `analyzeNdaAfterOcr` destructure `publish`
    - No remaining `step.sendEvent('emit-progress-...')` calls in emitProgress (the completion event `step.sendEvent('analysis-completed')` should remain)
    - Terminal events bypass throttle check
  </verify>
  <done>
    Both pipeline functions publish progress to Inngest Realtime with 1/sec throttle; DB persistence unchanged; old step.sendEvent progress calls removed
  </done>
</task>

</tasks>

<verification>
- `pnpm build` passes
- `grep -c "step.sendEvent.*emit-progress" inngest/functions/analyze-nda.ts` returns 0 (all removed)
- `grep -c "publish" inngest/functions/analyze-nda.ts` shows publish calls in both functions
- `grep -c "analysisChannel" inngest/functions/analyze-nda.ts` shows channel import used
- The `step.sendEvent('analysis-completed')` call at the end of each function is preserved (it's a separate concern — event-driven downstream actions, not progress streaming)
</verification>

<success_criteria>
Pipeline progress events stream to Inngest Realtime channels in real-time. DB persistence is unchanged. Old sendEvent-based progress emission is removed. Throttle limits publish frequency to 1/sec with terminal event bypass.
</success_criteria>

<output>
After completion, create `.planning/phases/10-progress-streaming/10-02-SUMMARY.md`
</output>
