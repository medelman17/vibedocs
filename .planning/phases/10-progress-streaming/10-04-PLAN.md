---
phase: 10-progress-streaming
plan: 04
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - app/api/word-addin/realtime-token/[id]/route.ts
  - app/api/word-addin/status/[id]/route.ts
  - app/(word-addin)/word-addin/taskpane/hooks/useAnalysisProgress.ts
autonomous: true

must_haves:
  truths:
    - "Word Add-in can get a Realtime subscription token via Bearer auth API route"
    - "Word Add-in task pane displays real-time progress (stage + percent + message)"
    - "Word Add-in reconnects silently on disconnect"
    - "Old SSE-wrapped polling endpoint is replaced with Inngest Realtime"
  artifacts:
    - path: "app/api/word-addin/realtime-token/[id]/route.ts"
      provides: "Token generation API route for Word Add-in Bearer auth"
      exports: ["GET"]
    - path: "app/(word-addin)/word-addin/taskpane/hooks/useAnalysisProgress.ts"
      provides: "Refactored hook using fetch-based Inngest Realtime subscription"
      exports: ["useAnalysisProgress"]
  key_links:
    - from: "app/api/word-addin/realtime-token/[id]/route.ts"
      to: "lib/realtime/tokens.ts"
      via: "generateAnalysisToken"
      pattern: "generateAnalysisToken"
    - from: "app/api/word-addin/realtime-token/[id]/route.ts"
      to: "lib/word-addin-auth.ts"
      via: "verifyAddInAuth for Bearer token validation"
      pattern: "verifyAddInAuth"
    - from: "app/(word-addin)/word-addin/taskpane/hooks/useAnalysisProgress.ts"
      to: "app/api/word-addin/realtime-token/[id]/route.ts"
      via: "fetch to get subscription token"
      pattern: "realtime-token"
---

<objective>
Create a dedicated API route for Word Add-in Realtime token acquisition (Bearer auth) and refactor the Word Add-in progress hook to use Inngest Realtime instead of the old SSE-wrapped DB polling.

Purpose: Word Add-in receives real-time progress updates. The old polling-based SSE endpoint is replaced.
Output: Token API route + refactored Word Add-in hook + deprecated old SSE endpoint.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-progress-streaming/10-RESEARCH.md
@.planning/phases/10-progress-streaming/10-CONTEXT.md
@.planning/phases/10-progress-streaming/10-01-SUMMARY.md

@app/api/word-addin/status/[id]/route.ts
@app/(word-addin)/word-addin/taskpane/hooks/useAnalysisProgress.ts
@lib/word-addin-auth.ts
@lib/realtime/tokens.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Word Add-in Realtime token API route</name>
  <files>app/api/word-addin/realtime-token/[id]/route.ts</files>
  <action>
    Create a new API route at `app/api/word-addin/realtime-token/[id]/route.ts`.

    This route generates Inngest Realtime subscription tokens for the Word Add-in. The Word Add-in uses Bearer token auth (not cookie sessions), so it cannot use server actions.

    Implementation:
    ```typescript
    import { db } from "@/db"
    import { analyses } from "@/db/schema"
    import { eq, and } from "drizzle-orm"
    import { verifyAddInAuth } from "@/lib/word-addin-auth"
    import { generateAnalysisToken } from "@/lib/realtime/tokens"
    import { ForbiddenError, NotFoundError, toAppError } from "@/lib/errors"
    import { error } from "@/lib/api-utils"

    export async function GET(
      request: Request,
      { params }: { params: Promise<{ id: string }> }
    ) {
      const { id: analysisId } = await params
      try {
        const authContext = await verifyAddInAuth(request)
        const tenantId = authContext.tenant.tenantId
        if (!tenantId) throw new ForbiddenError("No organization selected")

        // Verify analysis belongs to tenant
        const analysis = await db.query.analyses.findFirst({
          where: and(
            eq(analyses.id, analysisId),
            eq(analyses.tenantId, tenantId)
          ),
          columns: { id: true },
        })
        if (!analysis) throw new NotFoundError("Analysis not found")

        const token = await generateAnalysisToken(analysisId)
        return Response.json({ token })
      } catch (err) {
        return error(toAppError(err))
      }
    }
    ```

    Key points:
    - Uses `verifyAddInAuth` (Bearer token validation) — same pattern as existing Word Add-in API routes
    - Validates tenant ownership before generating token
    - Returns JSON `{ token }` — the token object from `getSubscriptionToken`
    - Error handling uses existing `error()` + `toAppError()` pattern
  </action>
  <verify>
    - `pnpm build` succeeds
    - File exists at `app/api/word-addin/realtime-token/[id]/route.ts`
    - Route uses `verifyAddInAuth` for Bearer auth
    - Route returns JSON with token
  </verify>
  <done>
    Word Add-in can fetch Inngest Realtime subscription tokens via Bearer auth
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor Word Add-in progress hook and deprecate old SSE endpoint</name>
  <files>
    app/(word-addin)/word-addin/taskpane/hooks/useAnalysisProgress.ts
    app/api/word-addin/status/[id]/route.ts
  </files>
  <action>
    **Part A: Refactor Word Add-in useAnalysisProgress hook**

    Rewrite `app/(word-addin)/word-addin/taskpane/hooks/useAnalysisProgress.ts` to use Inngest Realtime instead of the fetch-based SSE reader.

    The Word Add-in taskpane is a React app running in an Office.js WebView. The `useInngestSubscription` hook should work here (it uses standard fetch/WebSocket APIs). If it doesn't work in Office.js WebView, the RESEARCH.md notes using the non-React `subscribe()` API as fallback — but try the hook first.

    Implementation approach:
    1. Replace the manual fetch + ReadableStream SSE reader with `useInngestSubscription`
    2. The token refresher fetches from the new API route:
       ```typescript
       async function fetchToken() {
         const response = await fetch(`/api/word-addin/realtime-token/${analysisId}`, {
           headers: { Authorization: `Bearer ${token}` },
         })
         if (!response.ok) throw new Error(`HTTP ${response.status}`)
         const { token: realtimeToken } = await response.json()
         return realtimeToken
       }
       ```
    3. Map `latestData?.data` fields to the existing `ProgressState` interface:
       - `stage` -> `stage` (cast to `AnalysisStage`)
       - `percent` -> `percent`
       - `message` -> `message`
    4. Keep the `UseAnalysisProgressReturn` interface unchanged: `{ progress, isConnected, error, disconnect }`
    5. Auto-disconnect on terminal states (completed, failed, cancelled)
    6. The `disconnect()` function should be a no-op or close the subscription

    Keep the existing type imports (`ProgressState`, `AnalysisStage` from `@/types/word-addin`).

    **Part B: Deprecate old SSE endpoint**

    Update `app/api/word-addin/status/[id]/route.ts`:
    - Add a deprecation comment at the top of the file:
      ```typescript
      /**
       * @deprecated Use Inngest Realtime subscription via /api/word-addin/realtime-token/[id] instead.
       * This endpoint uses SSE-wrapped DB polling (2s interval) which is replaced by
       * Inngest Realtime publish/subscribe in Phase 10.
       * Kept temporarily for backward compatibility during transition.
       */
      ```
    - Do NOT delete the endpoint yet — it serves as a fallback during the transition period

    **Reconnection handling (STR-04):** `useInngestSubscription` handles reconnection internally — it re-calls the `refreshToken` function and resubscribes automatically on connection loss. Because Inngest Realtime has at-most-once delivery, events during disconnection may be missed, but this is acceptable for progress display — the next published event will show current state. Per CONTEXT.md, reconnection should be silent (no user notification unless reconnection fails repeatedly).

    Per CONTEXT.md decisions:
    - Word Add-in shows simple progress bar + stage label (not full debug panel)
    - Content controls placed all at once after full analysis completes (not progressive)
    - Silent auto-reconnect on disconnect
  </action>
  <verify>
    - `pnpm build` succeeds
    - Word Add-in hook imports `useInngestSubscription` from `@inngest/realtime/hooks`
    - Hook return type is still `UseAnalysisProgressReturn` (unchanged interface)
    - Old SSE endpoint has deprecation comment
    - New token API route is referenced by the hook's fetch call
  </verify>
  <done>
    Word Add-in receives real-time progress via Inngest Realtime; old SSE endpoint deprecated but preserved as fallback
  </done>
</task>

</tasks>

<verification>
- `pnpm build` passes
- `pnpm lint` passes
- Token API route exists and uses Bearer auth
- Word Add-in hook uses `useInngestSubscription`
- Old SSE endpoint has deprecation comment
- Word Add-in progress display pattern: stage label + percent (per CONTEXT.md decision)
</verification>

<success_criteria>
Word Add-in receives real-time analysis progress via Inngest Realtime. Dedicated token API route handles Bearer auth. Old SSE-wrapped polling endpoint is deprecated with comment. Hook interface is unchanged.
</success_criteria>

<output>
After completion, create `.planning/phases/10-progress-streaming/10-04-SUMMARY.md`
</output>
