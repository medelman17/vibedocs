---
phase: 10-progress-streaming
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - inngest/client.ts
  - inngest/channels.ts
  - lib/realtime/tokens.ts
autonomous: true

must_haves:
  truths:
    - "realtimeMiddleware() is registered on the Inngest client"
    - "analysisChannel is typed with progress topic schema"
    - "fetchAnalysisToken generates scoped subscription tokens"
  artifacts:
    - path: "inngest/client.ts"
      provides: "Inngest client with realtimeMiddleware"
      contains: "realtimeMiddleware"
    - path: "inngest/channels.ts"
      provides: "Typed channel definitions for analysis progress"
      exports: ["analysisChannel"]
    - path: "lib/realtime/tokens.ts"
      provides: "Server-side token generation helper"
      exports: ["fetchAnalysisToken"]
  key_links:
    - from: "inngest/client.ts"
      to: "@inngest/realtime/middleware"
      via: "middleware array"
      pattern: "realtimeMiddleware"
    - from: "inngest/channels.ts"
      to: "@inngest/realtime"
      via: "channel and topic builders"
      pattern: "channel.*addTopic.*topic"
    - from: "lib/realtime/tokens.ts"
      to: "inngest/channels.ts"
      via: "channel reference for token scoping"
      pattern: "analysisChannel"
---

<objective>
Install @inngest/realtime and set up the foundational infrastructure: middleware on the Inngest client, typed channel definitions, and server-side token generation.

Purpose: All subsequent plans (pipeline publishing, web UI hook, Word Add-in hook) depend on this infrastructure being in place.
Output: Three files providing the realtime transport layer foundation.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-progress-streaming/10-RESEARCH.md
@.planning/phases/10-progress-streaming/10-CONTEXT.md

@inngest/client.ts
@inngest/types.ts
@inngest/index.ts
@lib/dal.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @inngest/realtime and add realtimeMiddleware to Inngest client</name>
  <files>inngest/client.ts</files>
  <action>
    1. Install the package:
       ```bash
       pnpm add @inngest/realtime
       ```

    2. Update `inngest/client.ts` to add `realtimeMiddleware()`:
       - Import `realtimeMiddleware` from `@inngest/realtime/middleware`
       - Add `middleware: [realtimeMiddleware()]` to the Inngest constructor options
       - Keep all existing configuration (id, schemas) unchanged
       - Keep the existing `InngestClient` type export

    3. Create `inngest/channels.ts` with typed channel definition:
       - Import `channel` and `topic` from `@inngest/realtime`
       - Import `z` from `zod`
       - Define `analysisChannel` using the function pattern: `channel((analysisId: string) => \`analysis:\${analysisId}\`)`
       - Add a `progress` topic with schema:
         ```typescript
         z.object({
           stage: z.string(),
           percent: z.number().min(0).max(100),
           message: z.string(),
           metadata: z.object({
             chunksProcessed: z.number().optional(),
             totalChunks: z.number().optional(),
           }).optional(),
         })
         ```
       - Export `analysisChannel`

    IMPORTANT: Do NOT add `@inngest/realtime` exports to `inngest/index.ts` barrel. Import channels directly per barrel export convention in CLAUDE.md.
  </action>
  <verify>
    - `pnpm build` succeeds (no type errors)
    - `inngest/channels.ts` exports `analysisChannel`
    - `inngest/client.ts` includes `realtimeMiddleware()` in middleware array
    - `inngest/index.ts` has NO new exports for realtime (barrel export safety)
  </verify>
  <done>
    @inngest/realtime installed, middleware registered, typed channel with progress topic defined
  </done>
</task>

<task type="auto">
  <name>Task 2: Create server-side token generation helper</name>
  <files>lib/realtime/tokens.ts</files>
  <action>
    Create `lib/realtime/tokens.ts` with a reusable token generation function:

    ```typescript
    import { getSubscriptionToken, type Realtime } from "@inngest/realtime"
    import { inngest } from "@/inngest/client"
    import { analysisChannel } from "@/inngest/channels"
    ```

    Define and export:
    1. `AnalysisToken` type: `Realtime.Token<typeof analysisChannel, ["progress"]>`
    2. `generateAnalysisToken(analysisId: string)` async function:
       - Calls `getSubscriptionToken(inngest, { channel: analysisChannel(analysisId), topics: ["progress"] })`
       - Returns the token
       - No auth check here (callers handle auth - server actions use `withTenant()`, API routes use `verifyAddInAuth()`)

    This helper is shared by both the web UI server action (Plan 03) and the Word Add-in API route (Plan 04).

    Note: Import `inngest` from `@/inngest/client` directly (not from `@/inngest` barrel) to avoid pulling in extra exports.
  </action>
  <verify>
    - `pnpm build` succeeds
    - `lib/realtime/tokens.ts` exports `generateAnalysisToken` and `AnalysisToken` type
    - File imports from `@/inngest/client` directly (not barrel)
  </verify>
  <done>
    Token generation helper created, importable by both web and Word Add-in consumers
  </done>
</task>

</tasks>

<verification>
- `pnpm build` passes with no errors
- `inngest/client.ts` has `realtimeMiddleware()` in middleware config
- `inngest/channels.ts` exports typed `analysisChannel` with `progress` topic
- `lib/realtime/tokens.ts` exports `generateAnalysisToken` helper
- No new exports added to `inngest/index.ts` barrel
</verification>

<success_criteria>
Inngest Realtime infrastructure is in place: middleware registered, typed channel defined, token helper ready for consumption by downstream plans.
</success_criteria>

<output>
After completion, create `.planning/phases/10-progress-streaming/10-01-SUMMARY.md`
</output>
