---
phase: 11-document-rendering
plan: 07
type: execute
wave: 4
depends_on: ["11-05"]
files_modified:
  - components/document/document-renderer.tsx
  - components/analysis/risk-tab.tsx
  - components/analysis/classification-tab.tsx
  - hooks/use-clause-selection.ts
autonomous: true

must_haves:
  truths:
    - "Clicking a clause in analysis panel scrolls document to that clause and centers it"
    - "Clicking a clause in document scrolls analysis panel to the clause card and expands it"
    - "Arrow up/down navigates between clauses when highlights are enabled"
    - "Escape clears clause selection"
  artifacts:
    - path: "components/document/document-renderer.tsx"
      provides: "scrollToClause method, keyboard navigation handler"
    - path: "components/analysis/risk-tab.tsx"
      provides: "auto-scroll to active clause card, auto-expand on selection"
    - path: "hooks/use-clause-selection.ts"
      provides: "Navigation helpers (nextClause, prevClause)"
  key_links:
    - from: "components/document/document-renderer.tsx"
      to: "hooks/use-clause-selection.ts"
      via: "watches activeClauseId, scrolls when selectionSource==='analysis'"
      pattern: "selectionSource.*analysis.*scrollToIndex"
    - from: "components/analysis/risk-tab.tsx"
      to: "hooks/use-clause-selection.ts"
      via: "watches activeClauseId, scrolls when selectionSource==='document'"
      pattern: "selectionSource.*document.*scrollIntoView"
---

<objective>
Implement bidirectional scroll navigation between document and analysis panels, plus keyboard navigation between clauses.

Purpose: This is the core interaction model -- click a clause in either panel, the other panel scrolls to match. This enables efficient NDA review where users can jump between document text and analysis details seamlessly.

Output: Scroll synchronization between panels, keyboard clause navigation, and selection clearing behavior.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-document-rendering/11-RESEARCH.md
@.planning/phases/11-document-rendering/11-05-SUMMARY.md

# Components being modified
@components/document/document-renderer.tsx
@components/analysis/risk-tab.tsx
@components/analysis/classification-tab.tsx
@hooks/use-clause-selection.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement document-side scroll and keyboard navigation</name>
  <files>
    components/document/document-renderer.tsx
    hooks/use-clause-selection.ts
  </files>
  <action>
    **Update hooks/use-clause-selection.ts:**
    Add navigation helpers to the store:
    - `clauseIds: string[]` - ordered list of all clause IDs (set once when clauses load)
    - `setClauseIds(ids: string[])` - setter called by the analysis page when data loads
    - `nextClause()` - select the next clause in the list (wraps around)
    - `prevClause()` - select the previous clause in the list (wraps around)
    - These use `activeClauseId` to find current position and step forward/backward

    **Update document-renderer.tsx:**
    Add bidirectional scroll support:

    1. **Scroll TO clause when selected from analysis panel:**
       - Subscribe to `useClauseSelection` store
       - When `activeClauseId` changes AND `selectionSource === 'analysis'`:
         - Find the paragraph index containing this clause (from clauseOverlays)
         - Call `virtualizer.scrollToIndex(paragraphIndex, { align: 'center', behavior: 'smooth' })`
       - Use a useEffect that watches activeClauseId + selectionSource

    2. **Scroll FROM clause when clicking in document:**
       - ClauseHighlight onClick already calls `selectClause(clauseId, 'document')`
       - The analysis panel watches for this (implemented in Task 2)
       - No additional work needed in document-renderer for this direction

    3. **Keyboard navigation:**
       - Add a `useEffect` that listens for keydown events when the document panel is focused
       - ArrowDown (or j): call `nextClause()` from selection store
       - ArrowUp (or k): call `prevClause()` from selection store
       - Escape: call `clearSelection()`
       - Only active when `highlightsEnabled` is true (otherwise arrows scroll normally)
       - Use `tabIndex={0}` on the document container to make it focusable

    4. **Active clause visual state:**
       - When `activeClauseId` matches a ClauseHighlight, apply the "active" styling (stronger opacity + left border)
       - This is already handled by ClauseHighlight's `isActive` prop, but ensure it's wired correctly:
         - Pass `isActive={activeClauseId === clauseId}` to each ClauseHighlight

    IMPORTANT: Do NOT re-render the entire document when activeClauseId changes. Use:
    - A ref for the virtualizer
    - useEffect for the scroll action
    - CSS class toggling via `data-clause-id` selectors for active state (if possible)
    - If CSS toggling isn't practical with react-markdown, use selective re-rendering (only re-render paragraphs that contain the previously-active or newly-active clause)
  </action>
  <verify>pnpm build (type-check passes)</verify>
  <done>Document scrolls to clause when selected from analysis. Keyboard arrows navigate between clauses. Escape clears selection. Active clause highlighted with stronger styling.</done>
</task>

<task type="auto">
  <name>Task 2: Implement analysis-side scroll and auto-expand</name>
  <files>
    components/analysis/risk-tab.tsx
    components/analysis/classification-tab.tsx
  </files>
  <action>
    **Update risk-tab.tsx:**
    Add scroll-to and auto-expand behavior when clause is selected from document:

    1. Subscribe to `useClauseSelection` store
    2. When `activeClauseId` changes AND `selectionSource === 'document'`:
       - Find the ClauseCard for this clauseId in the rendered list
       - Scroll it into view: `document.querySelector(`[data-clause-card="${clauseId}"]`)?.scrollIntoView({ behavior: 'smooth', block: 'center' })`
       - Auto-expand the card: maintain a `expandedCards` set in state, add the activeClauseId to it
    3. Add `data-clause-card={clause.id}` attribute to each ClauseCard wrapper
    4. Show visual ring/highlight on the active clause card:
       - When `clause.id === activeClauseId`: add `ring-2 ring-primary` to the Card
    5. When activeClauseId changes away from a card, do NOT auto-collapse it (user may want to keep reading)

    **Update classification-tab.tsx:**
    Similar scroll-to behavior:
    1. When `activeClauseId` changes AND `selectionSource === 'document'`:
       - Map clause ID to classification entries (clauses may have multiple classifications)
       - Scroll the first matching ClassificationCard into view
       - Add `data-classification-card` attribute
    2. Show visual highlight on the matching classification card

    IMPORTANT: Use `useEffect` for the scroll action, not a synchronous handler. The scroll needs to happen AFTER the DOM has updated with the new active state.
  </action>
  <verify>pnpm build (type-check passes)</verify>
  <done>Analysis panel scrolls to and highlights the active clause card. Clause card auto-expands when selected from document. Classification tab highlights matching classifications.</done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- Click clause in analysis -> document scrolls to clause text, centers it
- Click clause in document -> analysis scrolls to clause card, expands it
- Arrow up/down navigates between clauses (when highlights enabled)
- Escape clears selection
- Active clause has visual highlight in both panels
</verification>

<success_criteria>
- Bidirectional scroll navigation works smoothly in both directions
- Keyboard arrow navigation between clauses when highlights are on
- Escape clears selection
- No full-document re-renders on clause selection changes
- Active clause visually highlighted in both panels
</success_criteria>

<output>
After completion, create `.planning/phases/11-document-rendering/11-07-SUMMARY.md`
</output>
