---
phase: 11-document-rendering
plan: 04
type: execute
wave: 2
depends_on: ["11-02"]
files_modified:
  - components/analysis/analysis-tabs.tsx
  - components/analysis/classification-tab.tsx
  - components/analysis/risk-tab.tsx
  - components/analysis/gaps-tab.tsx
  - components/artifact/analysis-view.tsx
autonomous: true

must_haves:
  truths:
    - "Analysis panel shows tabbed interface: Classifications | Risk | Gaps | Chat"
    - "Each tab loads data independently without re-rendering other tabs"
    - "Clicking a clause card in any tab updates the shared clause selection"
    - "Executive summary and perspective toggle remain visible above tabs"
  artifacts:
    - path: "components/analysis/analysis-tabs.tsx"
      provides: "Tab container with Classifications, Risk, Gaps, Chat tabs"
    - path: "components/analysis/classification-tab.tsx"
      provides: "Classification view extracted from AnalysisView"
    - path: "components/analysis/risk-tab.tsx"
      provides: "Risk assessment view with clause cards, extracted from AnalysisView"
    - path: "components/analysis/gaps-tab.tsx"
      provides: "Gap analysis view extracted from AnalysisView"
    - path: "components/artifact/analysis-view.tsx"
      provides: "Refactored AnalysisView using tab components"
  key_links:
    - from: "components/analysis/risk-tab.tsx"
      to: "hooks/use-clause-selection.ts"
      via: "selectClause on clause card click"
      pattern: "useClauseSelection.*selectClause"
    - from: "components/artifact/analysis-view.tsx"
      to: "components/analysis/analysis-tabs.tsx"
      via: "renders AnalysisTabs inside the analysis panel"
      pattern: "AnalysisTabs"
---

<objective>
Refactor the monolithic AnalysisView (~1400 lines) into a tabbed interface with separate components per tab. Wire clause card click events to the shared clause selection store.

Purpose: The existing AnalysisView renders all analysis data in a single scrollable column. Phase 11 requires it to become a tabbed right panel with bidirectional clause navigation. Breaking it into tabs also prevents monolithic re-renders (Pitfall 5 from RESEARCH.md).

Output: Tab container + 3 tab components (Classifications, Risk, Gaps) extracted from the existing AnalysisView. Chat tab placeholder (populated in Plan 06). AnalysisView refactored to use these tabs.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-document-rendering/11-RESEARCH.md
@.planning/phases/11-document-rendering/11-02-SUMMARY.md

# The file being refactored
@components/artifact/analysis-view.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract tab components from AnalysisView</name>
  <files>
    components/analysis/classification-tab.tsx
    components/analysis/risk-tab.tsx
    components/analysis/gaps-tab.tsx
  </files>
  <action>
    Extract three tab components from the existing AnalysisView. Each tab should be a standalone component that:
    - Accepts `analysisId: string` as prop
    - Manages its own data fetching (via the existing server actions)
    - Has its own loading/empty states
    - Wires clause clicks to `useClauseSelection`

    **classification-tab.tsx:**
    Move the existing `ClassificationView`, `ClassificationCard`, `CategoryGroupView`, `DocumentOrderView`, and `ConfidenceBadge` components here.
    Add: When user clicks a classification card, call `selectClause(classification.id, 'analysis')` from useClauseSelection store.
    Add: Scroll the active classification into view when `activeClauseId` changes from the document panel (selectionSource === 'document').

    **risk-tab.tsx:**
    Move the existing `ClauseCard`, `RiskBadge`, `SourceBadge`, `ExecutiveSummaryCard`, `PerspectiveToggle`, and evidence-related types/components here.
    Props: `analysisId: string`, plus the analysis data (Analysis object, clauses array, riskDistribution).
    Add: When user clicks a clause card, call `selectClause(clause.id, 'analysis')` from useClauseSelection store.
    Add: Visual indicator on the active clause card (ring or highlight border).
    Add: Auto-expand the clause card when it becomes active from document panel selection.
    Keep the existing PerspectiveToggle and re-score polling logic.

    **gaps-tab.tsx:**
    Move the existing `GapsView`, `GapCard`, `GapSeverityBadge`, `GapStatusBadge`, `CopyButton`, coverage summary, and related config here.
    Gaps don't have clause positions so no direct clause selection wiring.
    Keep as-is functionally.

    IMPORTANT: Move the `riskConfig`, `gapSeverityConfig`, `gapStatusConfig`, `sourceConfig` config objects into a shared `components/analysis/config.ts` file so they can be imported by both the tab components and the document renderer (for clause highlight colors). Do NOT create a barrel export index.ts in components/analysis/.

    Keep all existing functionality exactly as-is. This is a pure extraction refactor -- no behavior changes except adding clause selection wiring.
  </action>
  <verify>pnpm build (type-check passes)</verify>
  <done>Three tab components extracted with their full existing functionality. Clause clicks wired to useClauseSelection. Config objects shared via config.ts. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Create AnalysisTabs container and refactor AnalysisView</name>
  <files>
    components/analysis/analysis-tabs.tsx
    components/artifact/analysis-view.tsx
  </files>
  <action>
    **analysis-tabs.tsx:**
    Create a tab container component using shadcn Tabs (or simple custom tabs matching the existing toggle pattern in ClassificationView).

    Props:
    - `analysisId: string`
    - `analysis: Analysis` (passed from parent to avoid re-fetching)
    - `clauses: ClauseExtraction[]`
    - `riskDistribution: Record<RiskLevel, number> | null`
    - `currentPerspective: Perspective`
    - `onRescoreTriggered: () => void`

    Tabs:
    1. Classifications (renders ClassificationTab)
    2. Risk (renders RiskTab)
    3. Gaps (renders GapsTab)
    4. Chat (renders placeholder div with "Chat tab coming soon" text -- populated in Plan 06)

    Active tab controlled by `useClauseSelection().activeTab` so that "Ask about this" can programmatically switch to the Chat tab.

    Tab bar styling: match the existing toggle bar pattern (gap-1 rounded-md border p-1), but horizontal tab buttons.
    Below tab bar: optional toolbar strip for tab-specific controls (filter/sort placeholders).
    Tab content: flex-1 with ScrollArea wrapping each tab's content.

    Show all tabs always (not disabled) -- with empty states during progressive reveal:
    - Classifications: "Classifications will appear as analysis progresses..." + spinner when not yet complete
    - Risk: similar empty state
    - Gaps: similar empty state
    - Chat: placeholder text

    **analysis-view.tsx refactor:**
    Slim down AnalysisView to:
    1. Keep the existing progress/error/cancelled state handlers (ProgressView, ErrorView, CancelledView)
    2. Keep the data fetching logic (analysis + clauses via useEffect)
    3. Keep the re-score polling logic
    4. Replace the inline sections (executive summary, classifications, gaps, clause list) with a single `<AnalysisTabs>` component
    5. Keep the summary bar with RiskBadge and PerspectiveToggle above the tabs
    6. Remove all the extracted component definitions (they now live in components/analysis/)
    7. Import config from components/analysis/config.ts

    The result should be ~200-300 lines (down from ~1400).
  </action>
  <verify>pnpm build (type-check passes)</verify>
  <done>AnalysisTabs renders four tabs with independent loading. AnalysisView reduced to ~200-300 lines using tabs. All existing functionality preserved. Build passes.</done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- AnalysisView renders the same UI as before but via tab components
- Clicking a clause card updates the shared clause selection store
- Tab switching does not re-fetch data for other tabs
- Config objects shared across components without duplication
- No barrel exports in components/analysis/
</verification>

<success_criteria>
- AnalysisView refactored from ~1400 lines to ~200-300 lines
- 3 tab components render their respective analysis data independently
- Clause clicks in risk/classification tabs update shared selection state
- All tabs always visible with appropriate empty states
- Risk config colors shared via config.ts for use by document renderer
</success_criteria>

<output>
After completion, create `.planning/phases/11-document-rendering/11-04-SUMMARY.md`
</output>
