---
phase: 11-document-rendering
plan: 06
type: execute
wave: 4
depends_on: ["11-05"]
files_modified:
  - components/analysis/chat-tab.tsx
  - components/analysis/analysis-tabs.tsx
autonomous: true

must_haves:
  truths:
    - "Chat tab in analysis panel provides conversational AI about the document"
    - "Selecting 'Ask about this' from document pre-fills clause context into chat"
    - "Chat tab works as a non-page embedded component"
  artifacts:
    - path: "components/analysis/chat-tab.tsx"
      provides: "Embedded chat component for the analysis panel Chat tab"
    - path: "components/analysis/analysis-tabs.tsx"
      provides: "Updated to render ChatTab instead of placeholder"
  key_links:
    - from: "components/analysis/chat-tab.tsx"
      to: "hooks/use-clause-selection.ts"
      via: "reads pendingClauseContext for 'Ask about this' flow"
      pattern: "pendingClauseContext"
    - from: "components/analysis/chat-tab.tsx"
      to: "@ai-sdk/react"
      via: "useChat hook for conversational AI"
      pattern: "useChat"
---

<objective>
Create the Chat tab component embedded in the analysis panel, enabling conversational AI about the analyzed document. Wire "Ask about this" flow from clause selection.

Purpose: Per user decision, chat becomes a tab in the analysis panel rather than a separate panel. Users can select text/clauses in the document and ask the AI about them in context.

Output: ChatTab component using useChat hook, embedded in AnalysisTabs. "Ask about this" clause context pre-fill.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-document-rendering/11-RESEARCH.md
@.planning/phases/11-document-rendering/11-05-SUMMARY.md

# Chat implementation reference
@app/(main)/chat/page.tsx
@app/api/chat/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ChatTab component</name>
  <files>
    components/analysis/chat-tab.tsx
  </files>
  <action>
    Create a simplified chat component for embedding in the analysis panel tab. This is a stripped-down version of the chat page optimized for the tab layout.

    Props:
    - `analysisId: string` - links conversation to the analysis
    - `documentTitle: string` - for context in AI messages

    Implementation:
    1. Use `useChat` from `@ai-sdk/react` with `DefaultChatTransport` pointing to `/api/chat`
    2. Pass `analysisId` in the transport body so the chat route can provide document context
    3. Create a minimal chat UI:
       - Message list (ScrollArea, auto-scroll to bottom)
       - Each message: user messages left-aligned, assistant right-aligned (or same as existing chat)
       - Use `MessageResponse` from existing chat components for markdown rendering
       - Compact message styling (smaller text, less padding than full chat)
    4. Input area:
       - Simple textarea with send button (no file upload, no slash commands, no mentions)
       - Enter to send, Shift+Enter for newline
       - Disable while loading
    5. Empty state: "Ask a question about this document..."

    "Ask about this" flow:
    1. Read `pendingClauseContext` from `useClauseSelection` store
    2. When `pendingClauseContext` changes (and is not null):
       - Auto-send a message like: "Explain this clause:\n\n> {clauseText}"
       - Clear `pendingClauseContext` after sending
    3. This triggers when user clicks "Ask about this" in the document clause tooltip

    Conversation management:
    - Create a new conversation per analysis (or reuse existing)
    - Store conversationId in a ref (same pattern as chat page)
    - No sidebar history needed (this is a focused analysis chat)

    Do NOT import the full chat page components (too heavy). Keep this lightweight:
    - Import only MessageResponse (for markdown rendering) from @/components/chat
    - OR use a simpler markdown renderer (streamdown or plain react-markdown)
    - The chat tab is a compact sidebar-style chat, not a full-page chat

    Height: The tab content area must fill available space. Use `flex flex-col h-full` with messages taking `flex-1 min-h-0 overflow-auto` and input fixed at bottom.
  </action>
  <verify>pnpm build (type-check passes)</verify>
  <done>ChatTab component renders embedded chat in analysis panel. useChat hook manages conversation. "Ask about this" auto-sends clause context. Compact UI fits tab layout.</done>
</task>

<task type="auto">
  <name>Task 2: Wire ChatTab into AnalysisTabs</name>
  <files>
    components/analysis/analysis-tabs.tsx
  </files>
  <action>
    Update AnalysisTabs to:
    1. Replace the Chat tab placeholder with `<ChatTab analysisId={analysisId} documentTitle={...} />`
    2. Pass the document title through from the analysis data (or accept as prop)
    3. Only mount ChatTab when the Chat tab is active (lazy render to avoid multiple useChat instances)
    4. When `pendingClauseContext` exists in the clause selection store, auto-switch to the Chat tab

    Add "Ask about this" button to ClauseHighlight tooltip:
    - This requires a small update -- add a button in the clause-highlight tooltip that calls `askAboutClause(clauseId, clauseText)` from the selection store
    - The store's `askAboutClause` action sets `activeTab: 'chat'` and `pendingClauseContext`
    - AnalysisTabs watches `activeTab` and switches accordingly
    - ChatTab picks up `pendingClauseContext` and auto-sends

    Keep ChatTab unmounted when not active to avoid WebSocket/fetch overhead from useChat.
  </action>
  <verify>pnpm build (type-check passes)</verify>
  <done>Chat tab renders ChatTab component. "Ask about this" triggers tab switch and auto-sends clause context. Tab lazy-mounts for performance.</done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- Chat tab renders embedded conversation UI
- "Ask about this" from document clause switches to Chat tab and sends message
- Chat conversation persists within the tab
- Compact UI fits the analysis panel width
</verification>

<success_criteria>
- Chat tab provides document-aware conversational AI
- "Ask about this" flow works end-to-end: clause click -> tab switch -> auto-send
- Chat tab lazy-mounts for performance
- Messages render with markdown formatting
</success_criteria>

<output>
After completion, create `.planning/phases/11-document-rendering/11-06-SUMMARY.md`
</output>
