---
phase: 11-document-rendering
plan: 05
type: execute
wave: 3
depends_on: ["11-03", "11-04"]
files_modified:
  - app/(main)/analysis/[analysisId]/page.tsx
  - app/(main)/analysis/[analysisId]/layout.tsx
  - components/artifact/document-viewer.tsx
  - components/artifact/index.ts
  - app/(main)/chat/page.tsx
autonomous: true

must_haves:
  truths:
    - "/analysis/[analysisId] route renders split-panel document view"
    - "Document panel on left (55%), analysis panel on right (45%)"
    - "Panels are resizable via drag handle"
    - "Uploading a document from chat navigates to the analysis page"
  artifacts:
    - path: "app/(main)/analysis/[analysisId]/page.tsx"
      provides: "Analysis detail page with split-panel layout"
    - path: "app/(main)/analysis/[analysisId]/layout.tsx"
      provides: "Layout for analysis route within (main) group"
    - path: "components/artifact/document-viewer.tsx"
      provides: "Rewritten document viewer using DocumentRenderer"
  key_links:
    - from: "app/(main)/analysis/[analysisId]/page.tsx"
      to: "components/document/document-renderer.tsx"
      via: "renders DocumentRenderer in left panel"
      pattern: "DocumentRenderer"
    - from: "app/(main)/analysis/[analysisId]/page.tsx"
      to: "components/artifact/analysis-view.tsx"
      via: "renders AnalysisView in right panel"
      pattern: "AnalysisView"
    - from: "app/(main)/analysis/[analysisId]/page.tsx"
      to: "components/ui/resizable.tsx"
      via: "ResizablePanelGroup for split layout"
      pattern: "ResizablePanelGroup"
---

<objective>
Create the `/analysis/[analysisId]` route with split-panel layout (document left, analysis right) using ResizablePanelGroup. Rewrite the document viewer to use the real DocumentRenderer. Update the chat page to navigate to this route after upload.

Purpose: This route is the primary analysis interface. Users navigate here after uploading a document or clicking an analysis. The split layout enables side-by-side reading and analysis.

Output: New route with layout, rewritten document viewer, and chat integration to navigate to analysis view.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-document-rendering/11-RESEARCH.md
@.planning/phases/11-document-rendering/11-03-SUMMARY.md
@.planning/phases/11-document-rendering/11-04-SUMMARY.md

# Existing files
@components/artifact/document-viewer.tsx
@components/artifact/index.ts
@components/ui/resizable.tsx
@app/(main)/chat/page.tsx
@app/(main)/chat/chat-layout-client.tsx
@app/(main)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analysis detail route with split-panel layout</name>
  <files>
    app/(main)/analysis/[analysisId]/page.tsx
    app/(main)/analysis/[analysisId]/layout.tsx
  </files>
  <action>
    **layout.tsx:**
    Create a layout for the analysis route. It shares the (main) layout (which provides auth check and the SidebarProvider from chat-layout-client). The analysis layout should:
    - Import the ChatLayoutClient from chat (or the shared layout wrapper) so it has sidebar and header
    - OR simply be a pass-through layout since (main)/layout.tsx already handles auth

    Check what (main)/layout.tsx provides. If it provides the sidebar+auth wrapper, the analysis layout can be minimal (just pass children). If the sidebar is only in chat/layout.tsx, we need to share it.

    Most likely approach: The analysis route is a sibling to chat/ under (main)/, so (main)/layout.tsx provides auth. The analysis page needs its own client layout with sidebar access. Use the same ChatLayoutClient pattern or create a lighter wrapper.

    Actually, looking at the codebase, `chat/layout.tsx` wraps with ChatLayoutClient (sidebar+header). For the analysis route, create a similar layout that reuses the same sidebar structure. Import `ChatLayoutClient` from `app/(main)/chat/chat-layout-client.tsx` (or extract a shared layout component).

    Simplest approach: Move the sidebar/header shell to a shared component and use it in both chat/ and analysis/ layouts. OR have the analysis layout import ChatLayoutClient directly (it just provides sidebar, which works for analysis too).

    Read the existing `app/(main)/chat/layout.tsx` to understand the server-side auth check pattern, then replicate it for the analysis route.

    **page.tsx:**
    Client component that:
    1. Reads `analysisId` from params
    2. Fetches document rendering data via `getDocumentForRendering(analysisId)`
    3. Uses `convertToMarkdown` and `mapClausePositions` to prepare rendering data
    4. Renders a split-panel layout using shadcn `ResizablePanelGroup`:

    ```
    <ResizablePanelGroup direction="horizontal">
      <ResizablePanel defaultSize={55} minSize={35}>
        <DocumentRenderer ... />
      </ResizablePanel>
      <ResizableHandle withHandle />
      <ResizablePanel defaultSize={45} minSize={30}>
        <AnalysisView analysisId={analysisId} />
      </ResizablePanel>
    </ResizablePanelGroup>
    ```

    5. Handle loading state: Show DocumentSkeleton + AnalysisView (which has its own progress state)
    6. Handle error state: Show error message if getDocumentForRendering fails
    7. Auto-collapse sidebar on mount (maximize horizontal space):
       - Import `useShellStore` and call `setSidebarCollapsed(true)` on mount
       - OR use the SidebarProvider's `open` prop
    8. Responsive: On screens < 1024px, stack vertically (document on top, analysis below)

    Height constraints (CRITICAL per MEMORY.md):
    - Root container uses flex with `h-full min-h-0`
    - Each ResizablePanel has `overflow-hidden` and internal scroll
    - Do NOT use `min-h-svh` -- use `h-full` within the SidebarInset container
  </action>
  <verify>pnpm build (type-check passes)</verify>
  <done>/analysis/[analysisId] route renders split-panel layout with DocumentRenderer on left and AnalysisView on right. Resizable panels with 55/45 default split. Sidebar auto-collapses. Responsive stacking on mobile.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite DocumentViewer and update chat page navigation</name>
  <files>
    components/artifact/document-viewer.tsx
    components/artifact/index.ts
    app/(main)/chat/page.tsx
  </files>
  <action>
    **document-viewer.tsx rewrite:**
    Replace the mock document viewer with a real implementation that:
    1. Takes `documentId: string` prop (or `analysisId: string` -- check what's passed from chat page)
    2. Fetches actual document data via `getDocumentForRendering`
    3. Renders using DocumentRenderer (same component as the analysis page)
    4. Shows DocumentSkeleton during loading
    5. Shows error state for not-found documents

    This viewer is used when opening documents in the artifact panel from chat. It's a simpler version (no split panel, just the document).

    **artifact/index.ts:**
    No changes needed -- it already exports DocumentViewer.

    **chat page navigation update (page.tsx):**
    When analysis is triggered from file upload:
    1. After `triggerAnalysis` succeeds, instead of (or in addition to) opening the artifact panel, navigate to `/analysis/${analysisResult.data.id}` using `router.push()`
    2. This makes the document view the PRIMARY analysis interface (per user decision)
    3. Keep the artifact panel logic as a secondary mechanism (for when chat mentions an analysis)
    4. When `showArtifact` tool is called with type "analysis", navigate to `/analysis/${id}` instead of opening inline artifact

    Specifically in `handleFileUpload`:
    - After success, call `router.push(`/analysis/${analysisResult.data.id}`)` instead of just `openArtifact`
    - Remove or keep the openArtifact call (it's fine as secondary -- the navigation takes priority)

    In `onToolCall` for `showArtifact` with type "analysis":
    - Navigate to `/analysis/${input.id}` instead of opening artifact panel
    - Keep artifact panel for "document" and "comparison" types
  </action>
  <verify>pnpm build (type-check passes)</verify>
  <done>DocumentViewer uses real document data. Chat page navigates to /analysis/[id] after upload. showArtifact for analyses navigates to analysis route. Build passes.</done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- /analysis/[analysisId] renders the split-panel layout
- Document left, analysis right, with ResizableHandle
- DocumentViewer shows real document content (not mock data)
- Chat upload navigates to analysis page
- Height constraints correct (no overflow issues)
- Responsive stacking works on mobile
</verification>

<success_criteria>
- Split-panel layout with resizable panels at 55/45 default
- Document panel renders markdown with heading hierarchy
- Analysis panel shows tabbed interface
- Upload from chat navigates to analysis page
- Sidebar auto-collapses in document view
</success_criteria>

<output>
After completion, create `.planning/phases/11-document-rendering/11-05-SUMMARY.md`
</output>
