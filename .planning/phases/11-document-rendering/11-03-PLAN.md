---
phase: 11-document-rendering
plan: 03
type: execute
wave: 2
depends_on: ["11-01", "11-02"]
files_modified:
  - components/document/document-renderer.tsx
  - components/document/clause-highlight.tsx
  - components/document/document-toolbar.tsx
  - components/document/document-search.tsx
  - components/document/document-skeleton.tsx
autonomous: true

must_haves:
  truths:
    - "Document text renders as styled markdown with heading hierarchy preserved"
    - "Clause boundaries highlighted with risk-based colors when highlights enabled"
    - "Tooltip on clause hover shows CUAD category, risk level, confidence"
    - "Document search finds and highlights matches with prev/next navigation"
    - "Long documents render smoothly via virtual scrolling"
  artifacts:
    - path: "components/document/document-renderer.tsx"
      provides: "Main document rendering component with react-markdown and @tanstack/react-virtual"
    - path: "components/document/clause-highlight.tsx"
      provides: "Clause highlight wrapper with tooltip and click handler"
    - path: "components/document/document-toolbar.tsx"
      provides: "Toolbar with search, highlight toggle, export controls"
    - path: "components/document/document-search.tsx"
      provides: "Search bar with match count and prev/next buttons"
    - path: "components/document/document-skeleton.tsx"
      provides: "Skeleton loader during document fetch"
  key_links:
    - from: "components/document/document-renderer.tsx"
      to: "lib/document-rendering/text-to-markdown.ts"
      via: "convertToMarkdown for raw text transformation"
      pattern: "convertToMarkdown"
    - from: "components/document/clause-highlight.tsx"
      to: "hooks/use-clause-selection.ts"
      via: "selectClause on click, highlightsEnabled for visibility"
      pattern: "useClauseSelection"
---

<objective>
Build the document rendering components: markdown renderer with clause overlays, virtual scrolling for performance, toolbar with search, and clause highlight tooltips.

Purpose: This is the core document view -- the left panel where users read the NDA text. It must feel like a paper document (per user decision) with clause highlights that appear on toggle.

Output: Five components in `components/document/` that together render the full document view with search, highlighting, and virtual scrolling.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-document-rendering/11-RESEARCH.md
@.planning/phases/11-document-rendering/11-01-SUMMARY.md
@.planning/phases/11-document-rendering/11-02-SUMMARY.md

# Existing components to reference
@components/artifact/analysis-view.tsx
@components/ui/tooltip.tsx
@components/ui/badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create clause highlight + skeleton + search components</name>
  <files>
    components/document/clause-highlight.tsx
    components/document/document-skeleton.tsx
    components/document/document-search.tsx
  </files>
  <action>
    First install new dependencies:
    ```bash
    pnpm add react-markdown @tanstack/react-virtual
    ```

    **clause-highlight.tsx:**
    Create a wrapper component that wraps clause text spans with highlighting.

    Props:
    - `clauseId: string`
    - `category: string`
    - `riskLevel: string` (standard | cautious | aggressive | unknown)
    - `confidence: number`
    - `isActive: boolean` (is this the selected clause)
    - `isVisible: boolean` (are highlights enabled)
    - `children: React.ReactNode`
    - `onClick: () => void`

    Behavior:
    - When `isVisible=false`: render children without wrapper (transparent)
    - When `isVisible=true`: wrap in `<span>` with risk-based background color at 15% opacity
    - When `isActive=true`: stronger opacity (40%) + 3px left border accent in risk color
    - On hover: show shadcn `Tooltip` with category name, RiskBadge, confidence percentage
    - On click: call onClick handler
    - Use `data-clause-id` attribute for DOM querying (scroll-to targets)

    Risk colors (reuse from analysis-view.tsx riskConfig):
    - standard: oklch(0.90 0.08 175 / 0.15) hover, oklch(0.90 0.08 175 / 0.40) active
    - cautious: oklch(0.90 0.08 65 / 0.15) hover, oklch(0.90 0.08 65 / 0.40) active
    - aggressive: oklch(0.90 0.08 25 / 0.15) hover, oklch(0.90 0.08 25 / 0.40) active
    - unknown: oklch(0.92 0.01 280 / 0.15) hover, oklch(0.92 0.01 280 / 0.40) active

    Use existing shadcn Tooltip, TooltipContent, TooltipProvider, TooltipTrigger components.
    Use existing Badge component for confidence display in tooltip.

    **document-skeleton.tsx:**
    Simple skeleton loader for the document view. Use shadcn Skeleton component if available, otherwise create with Tailwind animate-pulse. Show:
    - A header bar skeleton (file name area)
    - A paper-like container with 12-15 text line skeletons of varying widths
    - Match the paper styling (white card, shadow, constrained width)

    **document-search.tsx:**
    Search bar component that uses `useDocumentSearch` hook.

    Props:
    - `text: string` - the document text to search
    - `paragraphOffsets: number[]` - paragraph offset boundaries
    - `onScrollToMatch: (paragraphIndex: number) => void` - callback to scroll virtualizer

    UI:
    - Compact search input with magnifying glass icon
    - Match count display: "3 of 12 matches"
    - Up/Down arrow buttons for prev/next
    - Close button (X) that clears search
    - Keyboard: Enter = next, Shift+Enter = prev, Escape = close
    - Animated expand from toolbar button click

    When activeMatch changes, call `onScrollToMatch(activeMatch.paragraphIndex)` to scroll the virtualizer.
  </action>
  <verify>pnpm build (type-check passes)</verify>
  <done>clause-highlight renders risk-colored spans with tooltip. document-skeleton shows paper-style loading state. document-search provides search bar with match navigation.</done>
</task>

<task type="auto">
  <name>Task 2: Create document renderer with virtual scrolling and toolbar</name>
  <files>
    components/document/document-renderer.tsx
    components/document/document-toolbar.tsx
  </files>
  <action>
    **document-toolbar.tsx:**
    Toolbar strip above the document panel with:
    - Highlight toggle: Switch component (or shadcn Toggle) labeled "Highlights" with clause count badge
    - Search button: opens/closes document-search component
    - Current section indicator: sticky text showing current section name from sectionPath
    - Export/print button (placeholder -- just the button, handler deferred)
    - Uses `useClauseSelection` for highlightsEnabled toggle

    Style: compact border-b bar matching the existing analysis-view summary bar pattern (bg-muted/50, px-4, py-2).

    **document-renderer.tsx:**
    Main document rendering component. This is the core of the document view.

    Props:
    - `rawText: string`
    - `sections: PositionedSection[]` (from DocumentStructure)
    - `clauses: ClauseOverlay[]` (from mapClausePositions)
    - `isLoading: boolean` (show skeleton when true)

    Implementation:

    1. **Conversion step (useMemo):** Call `convertToMarkdown(rawText, sections)` to get markdown + offsetMap. Call `splitIntoParagraphs(markdown)` to get paragraph segments.

    2. **Clause mapping (useMemo):** For each paragraph segment, determine which clauses overlap. Pre-compute a `paragraphClauses: Map<number, ClauseOverlay[]>` mapping paragraph index to its overlapping clauses.

    3. **Virtual scrolling:** Use `@tanstack/react-virtual` `useVirtualizer`:
       - count = paragraphs.length
       - getScrollElement = parentRef.current
       - estimateSize = 80 (generous for paragraphs, enables smooth scroll)
       - overscan = 10

    4. **Paragraph rendering:** Each virtual row renders a single paragraph:
       - If paragraph has no clause overlaps: render via `<Markdown components={...}>` with custom heading/paragraph renderers
       - If paragraph has clause overlaps: pre-split the paragraph text into segments (clause and non-clause portions), render each segment with `<ClauseHighlight>` wrappers for clause segments
       - Custom markdown components: h1 (text-2xl font-bold mt-8 mb-3), h2 (text-xl font-semibold mt-6 mb-2), h3 (text-lg font-medium mt-4 mb-1.5), p (text-base leading-relaxed mb-4)

    5. **Paper styling:** Wrap the virtualizer in a container with:
       - `bg-card rounded-lg border shadow-sm` (adapts to dark mode per research recommendation)
       - `max-w-3xl mx-auto px-8 py-10` for constrained paper-like width
       - `font-sans` for clean modern typography (not serif)
       - Generous line-height (leading-relaxed or leading-7)

    6. **Metadata header:** Above the paper, show a sticky header with:
       - File name (truncated)
       - Upload date
       - Page count (from metadata)
       - Status badge

    7. **Scroll position tracking:** Track which paragraph is currently visible and look up its sectionPath for the toolbar's current section display.

    IMPORTANT PERFORMANCE NOTES:
    - Pre-split markdown into paragraph segments ONCE on data change (useMemo), not on every render
    - Each paragraph gets its own small `<Markdown>` instance (cheap for single paragraphs)
    - Do NOT use measureElement with smooth scroll (per research pitfall 2) -- use estimateSize only
    - Do NOT re-render entire document when clause selection changes -- use CSS class toggling via data-clause-id

    Do NOT create barrel exports for components/document/.
  </action>
  <verify>pnpm build (type-check passes)</verify>
  <done>DocumentRenderer renders virtualized markdown with clause overlays. Paper-style container. Metadata header. Toolbar with highlight toggle and search. Smooth scroll to paragraph via scrollToIndex.</done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- react-markdown and @tanstack/react-virtual installed in package.json
- DocumentRenderer accepts rawText, sections, clauses and renders styled markdown
- ClauseHighlight shows risk-colored spans with tooltip on hover
- Virtual scrolling renders only visible paragraphs
- Search bar finds and navigates between matches
</verification>

<success_criteria>
- Document renders with heading hierarchy preserved (h1-h3 styled differently)
- Paper-style layout (constrained width, shadow, generous spacing)
- Virtual scrolling handles long documents without jank
- Clause highlights toggle on/off with risk-based colors
- Built-in search with match count and prev/next navigation
</success_criteria>

<output>
After completion, create `.planning/phases/11-document-rendering/11-03-SUMMARY.md`
</output>
