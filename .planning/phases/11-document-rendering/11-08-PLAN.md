---
phase: 11-document-rendering
plan: 08
type: execute
wave: 5
depends_on: ["11-06", "11-07"]
files_modified:
  - app/(main)/analysis/[analysisId]/page.tsx
  - components/document/document-renderer.tsx
  - components/analysis/analysis-tabs.tsx
  - proxy.ts
autonomous: false

must_haves:
  truths:
    - "User sees the document text immediately after upload, before analysis finishes"
    - "User can share a link to a specific clause and the recipient sees it highlighted"
    - "User can navigate to /analysis/[id] without being blocked by auth middleware"
    - "User can upload a document, view it, toggle highlights, click clauses, and chat about them in one flow"
    - "User can see token usage and estimated cost for a completed analysis"
  artifacts:
    - path: "app/(main)/analysis/[analysisId]/page.tsx"
      provides: "Progressive reveal integration, URL state management"
    - path: "proxy.ts"
      provides: "Updated auth redirects to allow /analysis/ routes"
  key_links:
    - from: "app/(main)/analysis/[analysisId]/page.tsx"
      to: "hooks/use-analysis-progress.ts"
      via: "progressive reveal based on pipeline stage"
      pattern: "useAnalysisProgress"
    - from: "proxy.ts"
      to: "app/(main)/analysis/"
      via: "auth middleware allows analysis routes for authenticated users"
      pattern: "analysis"
---

<objective>
Add progressive reveal (document appears before analysis completes), URL state for shareable clause links, proxy configuration for the new route, and visual verification of the complete flow.

Purpose: This is the polish and integration plan that ties everything together. Progressive reveal gives users immediate value (they can read the document while analysis runs). URL state enables sharing specific clause findings.

Output: Complete working flow from upload through document rendering with all features integrated.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-document-rendering/11-RESEARCH.md
@.planning/phases/11-document-rendering/11-06-SUMMARY.md
@.planning/phases/11-document-rendering/11-07-SUMMARY.md

# Files being modified
@app/(main)/analysis/[analysisId]/page.tsx
@proxy.ts
@hooks/use-analysis-progress.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement progressive reveal and URL state</name>
  <files>
    app/(main)/analysis/[analysisId]/page.tsx
    components/document/document-renderer.tsx
    components/analysis/analysis-tabs.tsx
    proxy.ts
  </files>
  <action>
    **Progressive reveal in analysis page:**
    Update the analysis page to show content progressively as pipeline stages complete:

    1. Use `useAnalysisProgress(analysisId)` to track pipeline progress
    2. Stages and what they unlock:
       - After parsing (~10%): Document rawText available -> show document panel with text
       - After classifying (~55%): Classifications available -> classifications tab populated
       - After scoring (~80%): Risk assessments available -> risk tab populated, clause highlights available
       - After gap analysis (~100%): Gap analysis available -> gaps tab populated
    3. Document panel:
       - Show skeleton while rawText is unavailable
       - Show document text as soon as rawText is fetched (even before analysis completes)
       - Add clause highlights ONLY after classifications + risk scoring are complete
    4. Analysis panel:
       - Show AnalysisView which already handles progress/processing states
       - Tabs show empty states ("Classifications will appear...") until data is available
       - Each tab re-fetches its data when the relevant pipeline stage completes
    5. Data fetching strategy:
       - Initial fetch: `getDocumentForRendering` returns whatever is available
       - On progress updates: re-fetch only when a stage completes (not on every percent change)
       - Use a `stageRef` to track last-completed stage and only re-fetch on transitions

    **URL state:**
    1. Read URL search params: `?clause=<clauseId>`
    2. On initial load, if `clause` param exists:
       - Set it as the active clause via `useClauseSelection`
       - Enable highlights automatically
       - The scroll-to logic from Plan 07 handles the rest
    3. When clause selection changes:
       - Update URL search params: `router.replace(`/analysis/${analysisId}?clause=${clauseId}`, { scroll: false })`
       - When selection is cleared, remove the clause param
    4. Use `useSearchParams` and `useRouter` from next/navigation

    **proxy.ts update:**
    Check if the proxy/middleware needs an update to allow `/analysis/` routes:
    - Read proxy.ts to see what routes are protected/allowed
    - Add `/analysis` to the allowed authenticated routes if not already covered
    - The (main) route group should already handle auth -- verify this

    **Token usage display (OUT-05):**
    Add a token usage summary to the analysis metadata header or the analysis-tabs toolbar:
    1. The analysis record already stores `tokenUsage` JSONB (total input/output tokens, estimated cost) -- set by the pipeline in Phase 2
    2. Read `analysis.tokenUsage` from the data already returned by `getDocumentForRendering` (or add it to the return if not present)
    3. Display in a compact format in the document metadata header bar:
       - Token count: "{input}↓ {output}↑" with tooltip showing "Input tokens / Output tokens"
       - Estimated cost: "$X.XX" (from `tokenUsage.total.estimatedCost`)
    4. Use the existing pattern from `components/debug/pipeline-debug-panel.tsx` (lines ~116-137) which already renders token usage grids
    5. Only show when analysis is complete (not during progressive reveal)
    6. Style: muted text, small font, right-aligned in the metadata bar

    **Responsive layout:**
    For screens < 1024px (md breakpoint):
    - Switch from horizontal ResizablePanelGroup to vertical stacking
    - Document on top, analysis tabs below
    - Use `useMediaQuery` or CSS `lg:` breakpoint
    - On mobile, consider using the analysis panel as a bottom sheet (existing Sheet pattern from AppBody)
  </action>
  <verify>pnpm build (type-check passes)</verify>
  <done>Progressive reveal shows document text immediately, adds highlights as analysis completes. URL contains clause ID for shareable links. Auth middleware allows /analysis/ routes. Token usage and cost displayed for completed analyses (OUT-05). Responsive layout stacks on mobile.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete document rendering interface with:
    - Split-panel layout (document left, analysis tabs right)
    - Markdown rendering with heading hierarchy
    - Clause highlighting with risk-based colors (toggle on/off)
    - Bidirectional scroll navigation (click in either panel)
    - Built-in text search with match navigation
    - Chat tab with "Ask about this" clause context
    - Progressive reveal during analysis
    - URL state for shareable clause links
    - Keyboard navigation (arrow keys, Escape)
    - Paper-style document rendering
  </what-built>
  <how-to-verify>
    1. Run `pnpm dev` and `pnpm dev:inngest`
    2. Navigate to the chat page and upload a sample NDA
    3. Verify you're redirected to /analysis/[analysisId]
    4. Watch the progressive reveal:
       a. Document text appears after parsing
       b. Clause highlights appear after classification+scoring
       c. Analysis tabs populate as stages complete
    5. Toggle highlights on/off using the toolbar toggle
    6. Click a clause highlight in the document:
       a. Analysis panel should scroll to that clause card
       b. Clause card should auto-expand
    7. Click a clause card in the analysis panel:
       a. Document should smooth-scroll to that clause text
       b. Clause should be highlighted/centered
    8. Use arrow keys to navigate between clauses
    9. Press Escape to clear selection
    10. Try the search bar: search for a word, use prev/next buttons
    11. Click "Ask about this" in a clause tooltip:
        a. Should switch to Chat tab
        b. Should auto-send clause text as context
    12. Copy the URL with ?clause= parameter, paste in new tab:
        a. Should load with that clause highlighted and centered
    13. Resize the panels by dragging the handle
    14. Resize browser to mobile width: verify vertical stacking
    15. After analysis completes, verify token usage display:
        a. Should show input/output token counts in metadata bar
        b. Should show estimated cost (e.g., "$1.10")
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- Full end-to-end flow: upload -> navigate -> render -> highlight -> navigate
- Progressive reveal shows document before analysis completes
- URL state works for shareable clause links
- All bidirectional navigation works
- Search, keyboard nav, and "Ask about this" all functional
</verification>

<success_criteria>
- Document renders immediately after upload with progressive reveal
- All five success criteria from the phase roadmap are met:
  1. Extracted document renders as structured markdown in artifact panel
  2. Heading hierarchy and sections preserved in rendering
  3. User can click clause in list to highlight and scroll to it in document
  4. Selecting clause in document scrolls clause list to match
  5. All analysis results persisted to database with clause positions
- URL contains clause IDs for shareable links
- Responsive layout adapts to mobile
</success_criteria>

<output>
After completion, create `.planning/phases/11-document-rendering/11-08-SUMMARY.md`
</output>
