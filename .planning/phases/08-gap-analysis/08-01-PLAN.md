---
phase: 08-gap-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - agents/types.ts
autonomous: true

must_haves:
  truths:
    - "Enhanced gap types (GapSeverity, GapStatusType, EnhancedGapResult) are defined and exported"
    - "Gap severity constants (critical, important, informational) are available"
    - "Two-tier gap status (missing, incomplete) replaces the old three-value GAP_STATUS"
    - "Enhanced gap result type includes coverage summary, template source, and style match"
  artifacts:
    - path: "agents/types.ts"
      provides: "Gap severity enum, gap status enum, enhanced gap analysis types"
      contains: "GAP_SEVERITY"
  key_links:
    - from: "agents/types.ts"
      to: "agents/gap-analyst.ts"
      via: "Type imports"
      pattern: "GapSeverity|GapStatusType|EnhancedGapResult"
---

<objective>
Define enhanced gap analysis types and schemas in `agents/types.ts` for use by the gap analyst agent, pipeline persistence, and UI.

Purpose: Establish the shared type foundation for two-tier gap detection (Missing vs. Incomplete), three severity tiers (critical/important/informational), coverage summary, and recommended language with template attribution.

Output: Updated `agents/types.ts` with new type exports.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@agents/types.ts
@.planning/phases/08-gap-analysis/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add enhanced gap analysis types and schemas</name>
  <files>agents/types.ts</files>
  <action>
Add the following to `agents/types.ts` in a new section after the existing `GapAnalysis` interface (around line 273):

1. **Replace existing GAP_STATUS** with two new enums:
   - Update `GAP_STATUS` from `['present', 'weak', 'missing']` to `['missing', 'incomplete']` — the old values are only used in the gap analyst agent itself, which Plan 02 will update. Keep the old `GapStatus` type alias for now but add the new one.
   - Add `GAP_SEVERITY = ['critical', 'important', 'informational'] as const` with `GapSeverity` type.

2. **Add enhanced gap analysis types** (after the existing `GapAnalysis` interface):

```typescript
// ============================================================================
// Enhanced Gap Analysis (Phase 8)
// ============================================================================

/** Gap severity levels based on cuadCategories.riskWeight */
export const GAP_SEVERITY = ['critical', 'important', 'informational'] as const
export type GapSeverity = (typeof GAP_SEVERITY)[number]
export const gapSeveritySchema = z.enum(GAP_SEVERITY)

/** Two-tier gap status: Missing (absent) vs Incomplete (weak coverage) */
export const ENHANCED_GAP_STATUS = ['missing', 'incomplete'] as const
export type EnhancedGapStatus = (typeof ENHANCED_GAP_STATUS)[number]
export const enhancedGapStatusSchema = z.enum(ENHANCED_GAP_STATUS)

/** Individual gap identified in the analysis */
export const enhancedGapItemSchema = z.object({
  category: cuadCategorySchema,
  status: enhancedGapStatusSchema,
  severity: gapSeveritySchema,
  explanation: z.string().max(300).describe('Why this gap matters for this NDA'),
  suggestedLanguage: z.string().max(500).describe('Full clause draft (1-3 paragraphs), insertable'),
  templateSource: z.string().max(100).optional().describe('e.g., "Bonterms NDA Section 3.2"'),
  styleMatch: z.string().max(200).optional().describe('How language was adapted to match NDA style'),
})

export type EnhancedGapItem = z.infer<typeof enhancedGapItemSchema>

/** Coverage summary for the gap analysis */
export const coverageSummarySchema = z.object({
  totalCategories: z.number(),
  presentCount: z.number(),
  missingCount: z.number(),
  incompleteCount: z.number(),
  coveragePercent: z.number().min(0).max(100),
})

export type CoverageSummary = z.infer<typeof coverageSummarySchema>

/** Enhanced gap analysis schema for the LLM call */
export const enhancedGapAnalysisSchema = z.object({
  gaps: z.array(enhancedGapItemSchema),
  coverageSummary: coverageSummarySchema,
  presentCategories: z.array(cuadCategorySchema),
  weakClauses: z.array(z.object({
    clauseId: z.string(),
    category: cuadCategorySchema,
    issue: z.string(),
    recommendation: z.string(),
  })),
})

export type EnhancedGapAnalysisOutput = z.infer<typeof enhancedGapAnalysisSchema>

/** Full enhanced gap result stored in analyses.gapAnalysis JSONB */
export interface EnhancedGapResult {
  gaps: EnhancedGapItem[]
  coverageSummary: CoverageSummary
  presentCategories: CuadCategory[]
  weakClauses: Array<{
    clauseId: string
    category: CuadCategory
    issue: string
    recommendation: string
  }>
  hypothesisCoverage: HypothesisCoverage[]
  gapScore: number
}
```

**Important:**
- Do NOT remove the existing `GAP_STATUS`, `GapStatus`, or `GapAnalysis` types — they may still be referenced. The old `GAP_STATUS` has `['present', 'weak', 'missing']`. Leave it as-is; the new types use different names (`ENHANCED_GAP_STATUS`, `EnhancedGapStatus`, `EnhancedGapResult`).
- Do NOT remove the existing `GapAnalysis` interface — the new `EnhancedGapResult` extends it conceptually but is a separate type.
- Use `z.enum()` for the new schemas, consistent with existing patterns (see `riskLevelSchema`, `perspectiveSchema`).
  </action>
  <verify>
Run `pnpm build` and confirm no TypeScript errors in `agents/types.ts`. Verify the new types are exported: `grep -n "GAP_SEVERITY\|EnhancedGapStatus\|EnhancedGapResult\|enhancedGapAnalysisSchema" agents/types.ts`
  </verify>
  <done>
New types `GapSeverity`, `EnhancedGapStatus`, `EnhancedGapItem`, `CoverageSummary`, `EnhancedGapAnalysisOutput`, and `EnhancedGapResult` are defined in `agents/types.ts` and compile without errors. Existing types are preserved.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds with no errors
- `agents/types.ts` exports: GAP_SEVERITY, GapSeverity, ENHANCED_GAP_STATUS, EnhancedGapStatus, enhancedGapItemSchema, EnhancedGapItem, coverageSummarySchema, CoverageSummary, enhancedGapAnalysisSchema, EnhancedGapAnalysisOutput, EnhancedGapResult
- Existing types (GAP_STATUS, GapStatus, GapAnalysis, etc.) still present and unchanged
</verification>

<success_criteria>
Enhanced gap analysis types compile and are available for import by Plan 02 (agent), Plan 03 (pipeline), and Plan 04 (UI).
</success_criteria>

<output>
After completion, create `.planning/phases/08-gap-analysis/08-01-SUMMARY.md`
</output>
