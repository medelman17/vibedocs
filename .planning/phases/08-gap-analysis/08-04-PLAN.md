---
phase: 08-gap-analysis
plan: 04
type: execute
wave: 4
depends_on: ["08-03"]
files_modified:
  - components/artifact/analysis-view.tsx
autonomous: true

must_haves:
  truths:
    - "Analysis view shows a Gap Analysis section with coverage summary and gap cards"
    - "Coverage summary displays present/missing/incomplete counts and coverage percentage"
    - "Each gap card shows category name, status badge (Missing/Incomplete), severity badge, and explanation"
    - "Expanding a gap card reveals recommended language with template source attribution"
    - "Copy-to-clipboard button works for individual gap suggested language"
    - "Copy All Gaps button copies all gap recommended language as formatted text"
    - "Gap data fetched via fetchGapAnalysis server action on mount"
  artifacts:
    - path: "components/artifact/analysis-view.tsx"
      provides: "GapsView component with CoverageSummary, GapCard, severity/status badges, copy functionality"
      contains: "GapsView"
  key_links:
    - from: "components/artifact/analysis-view.tsx"
      to: "app/(main)/(dashboard)/analyses/actions.ts"
      via: "fetchGapAnalysis import and call"
      pattern: "fetchGapAnalysis"
    - from: "components/artifact/analysis-view.tsx"
      to: "agents/types.ts"
      via: "Type imports for gap display"
      pattern: "GapSeverity|EnhancedGapStatus"
---

<objective>
Add a Gap Analysis section to the AnalysisView component with coverage summary, expandable gap cards, severity/status badges, and copy functionality.

Purpose: Users need to see which CUAD categories are missing/incomplete in their NDA, understand why each matters, and get insertable recommended clause language.

Output: Updated `components/artifact/analysis-view.tsx` with GapsView component.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-gap-analysis/08-03-SUMMARY.md
@components/artifact/analysis-view.tsx
@app/(main)/(dashboard)/analyses/actions.ts
@agents/types.ts
@.planning/phases/08-gap-analysis/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GapsView component with coverage summary and gap cards</name>
  <files>components/artifact/analysis-view.tsx</files>
  <action>
Add the GapsView component and supporting components to `components/artifact/analysis-view.tsx`. Follow existing patterns from `ClassificationView` and `ClauseCard`.

**1. Add imports** (at top of file, alongside existing imports):
```typescript
import {
  fetchGapAnalysis,
  type EnhancedGapResult,
} from "@/app/(main)/(dashboard)/analyses/actions"
import { ClipboardCopyIcon, ClipboardCheckIcon, CopyIcon } from "lucide-react"
```
Note: `fetchGapAnalysis` and `EnhancedGapResult` are added alongside the existing imports from actions.ts.

Also import from agents/types if not already imported:
```typescript
import type { GapSeverity, EnhancedGapStatus, EnhancedGapItem, CoverageSummary } from "@/agents/types"
```
Note: `CLASSIFICATION_THRESHOLDS` is already imported from `@/agents/types`.

**2. Add severity and status configuration objects** (after the existing `riskConfig` object, around line 90):

```typescript
// Gap severity configuration (follows riskConfig pattern)
const gapSeverityConfig: Record<GapSeverity, {
  label: string
  bgColor: string
  textColor: string
  borderColor: string
  icon: React.ElementType
}> = {
  critical: {
    label: "Critical",
    bgColor: "oklch(0.90 0.08 25)",
    textColor: "oklch(0.50 0.14 25)",
    borderColor: "oklch(0.85 0.10 25)",
    icon: AlertCircleIcon,
  },
  important: {
    label: "Important",
    bgColor: "oklch(0.90 0.08 65)",
    textColor: "oklch(0.50 0.14 65)",
    borderColor: "oklch(0.85 0.10 65)",
    icon: AlertTriangleIcon,
  },
  informational: {
    label: "Info",
    bgColor: "oklch(0.92 0.01 280)",
    textColor: "oklch(0.45 0.01 280)",
    borderColor: "oklch(0.88 0.02 280)",
    icon: HelpCircleIcon,
  },
}

const gapStatusConfig: Record<EnhancedGapStatus, {
  label: string
  bgColor: string
  textColor: string
  borderColor: string
}> = {
  missing: {
    label: "Missing",
    bgColor: "oklch(0.90 0.08 25)",
    textColor: "oklch(0.50 0.14 25)",
    borderColor: "oklch(0.85 0.10 25)",
  },
  incomplete: {
    label: "Incomplete",
    bgColor: "oklch(0.90 0.08 65)",
    textColor: "oklch(0.50 0.14 65)",
    borderColor: "oklch(0.85 0.10 65)",
  },
}
```

**3. Add helper components** (before the `GapsView` function):

```typescript
function GapSeverityBadge({ severity }: { severity: GapSeverity }) {
  const config = gapSeverityConfig[severity]
  const Icon = config.icon
  return (
    <Badge
      variant="outline"
      className="gap-1 text-xs"
      style={{
        background: config.bgColor,
        color: config.textColor,
        borderColor: config.borderColor,
      }}
    >
      <Icon className="size-3" />
      {config.label}
    </Badge>
  )
}

function GapStatusBadge({ status }: { status: EnhancedGapStatus }) {
  const config = gapStatusConfig[status]
  return (
    <Badge
      variant="outline"
      className="text-xs"
      style={{
        background: config.bgColor,
        color: config.textColor,
        borderColor: config.borderColor,
      }}
    >
      {config.label}
    </Badge>
  )
}

function CopyButton({ text, label = "Copy" }: { text: string; label?: string }) {
  const [copied, setCopied] = React.useState(false)

  const handleCopy = async () => {
    await navigator.clipboard.writeText(text)
    setCopied(true)
    setTimeout(() => setCopied(false), 2000)
  }

  return (
    <button
      onClick={handleCopy}
      className="inline-flex items-center gap-1 rounded-md border px-2 py-1 text-xs text-muted-foreground transition-colors hover:bg-muted"
    >
      {copied ? (
        <>
          <ClipboardCheckIcon className="size-3" />
          Copied
        </>
      ) : (
        <>
          <ClipboardCopyIcon className="size-3" />
          {label}
        </>
      )}
    </button>
  )
}
```

**4. Add `GapCard` component**:

```typescript
function GapCard({ gap }: { gap: EnhancedGapItem }) {
  const [open, setOpen] = React.useState(false)

  return (
    <Collapsible open={open} onOpenChange={setOpen}>
      <Card className="min-w-0">
        <CardHeader className="pb-2">
          <div className="flex min-w-0 items-start justify-between gap-2">
            <div className="min-w-0 flex-1">
              <CollapsibleTrigger asChild>
                <button className="flex items-center gap-1.5 text-left">
                  {open ? (
                    <ChevronDownIcon className="size-4 shrink-0" />
                  ) : (
                    <ChevronRightIcon className="size-4 shrink-0" />
                  )}
                  <CardTitle className="min-w-0 truncate text-sm font-medium">
                    {gap.category}
                  </CardTitle>
                </button>
              </CollapsibleTrigger>
            </div>
            <div className="flex shrink-0 items-center gap-1.5">
              <GapStatusBadge status={gap.status} />
              <GapSeverityBadge severity={gap.severity} />
            </div>
          </div>
          <p className="mt-1 text-sm text-muted-foreground">
            {gap.explanation}
          </p>
        </CardHeader>
        <CollapsibleContent>
          <CardContent className="space-y-3 pt-0">
            {/* Recommended Language */}
            <div className="space-y-2">
              <h5 className="text-xs font-medium text-muted-foreground uppercase tracking-wide">
                Recommended Language
              </h5>
              <blockquote className="border-l-2 pl-3 text-sm whitespace-pre-wrap">
                {gap.suggestedLanguage}
              </blockquote>
              <div className="flex items-center justify-between">
                {gap.templateSource && (
                  <p className="text-xs text-muted-foreground italic">
                    Source: {gap.templateSource}
                  </p>
                )}
                <CopyButton text={gap.suggestedLanguage} label="Copy clause" />
              </div>
              {gap.styleMatch && (
                <p className="text-xs text-muted-foreground">
                  {gap.styleMatch}
                </p>
              )}
            </div>
          </CardContent>
        </CollapsibleContent>
      </Card>
    </Collapsible>
  )
}
```

**5. Add `GapsView` component** (follows `ClassificationView` pattern â€” useEffect fetch on mount):

```typescript
function GapsView({ analysisId }: { analysisId: string }) {
  const [gapData, setGapData] = React.useState<EnhancedGapResult | null>(null)
  const [loading, setLoading] = React.useState(true)

  React.useEffect(() => {
    setLoading(true)
    fetchGapAnalysis(analysisId)
      .then((result) => {
        if (result.success) {
          setGapData(result.data)
        }
      })
      .finally(() => setLoading(false))
  }, [analysisId])

  if (loading) {
    return (
      <div className="flex items-center justify-center p-4">
        <Loader2Icon className="size-5 animate-spin" />
      </div>
    )
  }

  if (!gapData || gapData.gaps.length === 0) {
    return (
      <p className="text-center text-sm text-muted-foreground">
        No gaps identified.
      </p>
    )
  }

  // Sort gaps by severity: critical > important > informational
  const severityOrder: Record<string, number> = { critical: 0, important: 1, informational: 2 }
  const sortedGaps = [...gapData.gaps].sort(
    (a, b) => (severityOrder[a.severity] ?? 3) - (severityOrder[b.severity] ?? 3)
  )

  // Build "Copy All" text
  const allGapsText = sortedGaps
    .map((g) => `## ${g.category} (${g.status} - ${g.severity})\n\n${g.explanation}\n\n### Recommended Language\n\n${g.suggestedLanguage}${g.templateSource ? `\n\nSource: ${g.templateSource}` : ""}`)
    .join("\n\n---\n\n")

  const { coverageSummary } = gapData

  return (
    <div className="space-y-3">
      {/* Coverage Summary */}
      <Card>
        <CardHeader className="pb-2">
          <div className="flex items-center justify-between">
            <CardTitle className="text-sm font-medium">
              Coverage: {coverageSummary.presentCount}/{coverageSummary.totalCategories} categories
            </CardTitle>
            <span className="text-xs text-muted-foreground">
              {coverageSummary.coveragePercent}%
            </span>
          </div>
        </CardHeader>
        <CardContent className="space-y-2">
          <Progress value={coverageSummary.coveragePercent} className="h-2" />
          <div className="flex flex-wrap gap-2">
            {coverageSummary.missingCount > 0 && (
              <Badge variant="outline" className="gap-1 text-xs" style={{ background: "oklch(0.90 0.08 25)", color: "oklch(0.50 0.14 25)", borderColor: "oklch(0.85 0.10 25)" }}>
                {coverageSummary.missingCount} missing
              </Badge>
            )}
            {coverageSummary.incompleteCount > 0 && (
              <Badge variant="outline" className="gap-1 text-xs" style={{ background: "oklch(0.90 0.08 65)", color: "oklch(0.50 0.14 65)", borderColor: "oklch(0.85 0.10 65)" }}>
                {coverageSummary.incompleteCount} incomplete
              </Badge>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Copy All button */}
      <div className="flex justify-end">
        <CopyButton text={allGapsText} label="Copy all gaps" />
      </div>

      {/* Gap Cards */}
      {sortedGaps.map((gap, i) => (
        <GapCard key={`${gap.category}-${i}`} gap={gap} />
      ))}
    </div>
  )
}
```

**6. Wire GapsView into the main `AnalysisView` component** (around line 917-924):

Add a "Gap Analysis" section between the "CUAD Classifications" section and the "Clause list" (Risk Assessments) section:

Find the existing pattern:
```tsx
      {/* Classification results */}
      <div className="border-b px-4 py-3">
        <h4 className="mb-3 text-sm font-medium text-muted-foreground">
          CUAD Classifications
        </h4>
        <ClassificationView analysisId={analysisId} />
      </div>
```

Add AFTER it (before the `{/* Clause list */}` ScrollArea):
```tsx
      {/* Gap Analysis */}
      <div className="border-b px-4 py-3">
        <h4 className="mb-3 text-sm font-medium text-muted-foreground">
          Gap Analysis
        </h4>
        <GapsView analysisId={analysisId} />
      </div>
```
  </action>
  <verify>
`pnpm build` succeeds. `grep -n "GapsView\|GapCard\|CoverageSummary\|fetchGapAnalysis\|GapSeverityBadge\|CopyButton" components/artifact/analysis-view.tsx` confirms all components exist. Verify the `GapsView` section appears in the `AnalysisView` component's JSX.
  </verify>
  <done>
GapsView component renders coverage summary with progress bar and badge counts, sorted gap cards with expandable recommended language and copy buttons, and a Copy All button. GapCard uses Collapsible pattern matching ClauseCard. Gap data fetched via fetchGapAnalysis on mount.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- Analysis view shows three sections in order: CUAD Classifications, Gap Analysis, Risk Assessments
- GapsView fetches data via fetchGapAnalysis on mount
- Coverage summary shows present/total with progress bar
- Gap cards show category, status badge, severity badge, explanation
- Expanding gap card shows recommended language blockquote with copy button and source attribution
- Copy All button copies all gap data as formatted markdown text
- Gap cards sorted by severity (critical first)
</verification>

<success_criteria>
Users can see which CUAD categories are missing/incomplete in their NDA, understand the severity and importance of each gap, and copy recommended clause language (individually or all at once) for insertion into their document.
</success_criteria>

<output>
After completion, create `.planning/phases/08-gap-analysis/08-04-SUMMARY.md`
</output>
