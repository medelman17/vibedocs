---
phase: 08-gap-analysis
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - db/queries/gap-analysis.ts
  - app/(main)/(dashboard)/analyses/actions.ts
  - inngest/functions/analyze-nda.ts
autonomous: true

must_haves:
  truths:
    - "Enhanced gap analysis data is persisted to analyses.gapAnalysis JSONB column"
    - "Server action fetchGapAnalysis returns typed EnhancedGapResult for an analysis"
    - "Pipeline step passes enhanced output to persist-final step"
    - "Gap analysis query file exists and exports getGapAnalysis function"
  artifacts:
    - path: "db/queries/gap-analysis.ts"
      provides: "Gap analysis query function"
      exports: ["getGapAnalysis"]
    - path: "app/(main)/(dashboard)/analyses/actions.ts"
      provides: "fetchGapAnalysis server action"
      exports: ["fetchGapAnalysis"]
    - path: "inngest/functions/analyze-nda.ts"
      provides: "Enhanced gap data stored in persist-final step"
      contains: "gapResult.gapAnalysis"
  key_links:
    - from: "app/(main)/(dashboard)/analyses/actions.ts"
      to: "db/queries/gap-analysis.ts"
      via: "import getGapAnalysis"
      pattern: "getGapAnalysis"
    - from: "inngest/functions/analyze-nda.ts"
      to: "agents/gap-analyst.ts"
      via: "runGapAnalystAgent returns EnhancedGapResult"
      pattern: "gapResult"
---

<objective>
Wire enhanced gap analysis into the pipeline persistence, create a query function, and add a server action for UI consumption.

Purpose: The enhanced gap analyst now produces richer output (EnhancedGapResult). This plan ensures that output is persisted correctly and retrievable via a typed server action for the UI.

Output: New `db/queries/gap-analysis.ts`, updated `actions.ts` with `fetchGapAnalysis`, updated pipeline persistence.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-gap-analysis/08-02-SUMMARY.md
@inngest/functions/analyze-nda.ts
@app/(main)/(dashboard)/analyses/actions.ts
@db/queries/risk-scoring.ts
@db/schema/analyses.ts
@.planning/phases/08-gap-analysis/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gap analysis query and server action</name>
  <files>db/queries/gap-analysis.ts, app/(main)/(dashboard)/analyses/actions.ts</files>
  <action>
**1. Create `db/queries/gap-analysis.ts`:**

Follow the pattern from `db/queries/risk-scoring.ts` and `db/queries/classifications.ts`:

```typescript
/**
 * @fileoverview Gap Analysis Queries
 *
 * Queries for retrieving enhanced gap analysis data from the analyses table.
 *
 * @module db/queries/gap-analysis
 */

import { db } from '@/db/client'
import { analyses } from '@/db/schema'
import { eq, and } from 'drizzle-orm'
import type { EnhancedGapResult } from '@/agents/types'

/**
 * Retrieves the enhanced gap analysis data for an analysis.
 *
 * The gapAnalysis column stores JSONB data matching EnhancedGapResult.
 * Returns null if analysis not found or gap data not available.
 */
export async function getGapAnalysis(
  analysisId: string,
  tenantId: string
): Promise<EnhancedGapResult | null> {
  const result = await db.query.analyses.findFirst({
    where: and(
      eq(analyses.id, analysisId),
      eq(analyses.tenantId, tenantId)
    ),
    columns: {
      gapAnalysis: true,
      status: true,
    },
  })

  if (!result || result.status !== 'completed') return null

  return (result.gapAnalysis as EnhancedGapResult) ?? null
}
```

Do NOT add this to any barrel export (per CLAUDE.md).

**2. Update `app/(main)/(dashboard)/analyses/actions.ts`:**

a. Add import at top:
```typescript
import { getGapAnalysis } from '@/db/queries/gap-analysis'
import type { EnhancedGapResult } from '@/agents/types'
```

b. Update the existing `GapAnalysisResult` interface comment to note it's legacy, and add re-export:
```typescript
// Re-export enhanced gap types for UI consumption
export type { EnhancedGapResult }
```

c. **Replace the existing `getAnalysisGaps` function** with a new `fetchGapAnalysis` action that returns `EnhancedGapResult`:

```typescript
/**
 * Fetch enhanced gap analysis results.
 *
 * Returns the full enhanced gap analysis including two-tier gaps,
 * coverage summary, recommended language, and hypothesis coverage.
 *
 * @param analysisId - UUID of the analysis
 * @returns Enhanced gap analysis results
 */
export async function fetchGapAnalysis(
  analysisId: string
): Promise<ApiResponse<EnhancedGapResult>> {
  if (!z.string().uuid().safeParse(analysisId).success) {
    return err("VALIDATION_ERROR", "Invalid analysis ID")
  }

  const { tenantId } = await withTenant()

  const gapData = await getGapAnalysis(analysisId, tenantId)

  if (!gapData) {
    // Return empty result if gap analysis not available
    return ok({
      gaps: [],
      coverageSummary: {
        totalCategories: 0,
        presentCount: 0,
        missingCount: 0,
        incompleteCount: 0,
        coveragePercent: 0,
      },
      presentCategories: [],
      weakClauses: [],
      hypothesisCoverage: [],
      gapScore: 0,
    })
  }

  return ok(gapData)
}
```

**Keep the old `getAnalysisGaps` function** for backward compatibility but mark with a `@deprecated` JSDoc tag pointing to `fetchGapAnalysis`.

d. Add `fetchGapAnalysis` to the re-exported types section if applicable.
  </action>
  <verify>
`pnpm build` succeeds. `grep -n "fetchGapAnalysis\|getGapAnalysis" app/(main)/(dashboard)/analyses/actions.ts db/queries/gap-analysis.ts` confirms both exist.
  </verify>
  <done>
`fetchGapAnalysis` server action returns typed `EnhancedGapResult`. `getGapAnalysis` query function fetches and type-asserts from JSONB. Old `getAnalysisGaps` preserved with @deprecated tag.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update pipeline persistence for enhanced gap data</name>
  <files>inngest/functions/analyze-nda.ts</files>
  <action>
Update the gap analysis storage in `inngest/functions/analyze-nda.ts`.

The persist-final step (around line 611) already stores `gapResult.gapAnalysis` in the `gapAnalysis` column. Since Plan 02 changed `GapAnalystOutput.gapAnalysis` to be `EnhancedGapResult`, the JSONB column will now receive the richer data structure automatically.

**Verify and update if needed:**

1. Check that `gapResult.gapAnalysis` at line 624 still works with the enhanced output. The `GapAnalystOutput` interface was updated in Plan 02 — its `gapAnalysis` field is now `EnhancedGapResult` which includes `gaps`, `coverageSummary`, `presentCategories`, `weakClauses`, `hypothesisCoverage`, and `gapScore`.

2. The existing line `gapAnalysis: gapResult.gapAnalysis,` should work as-is since the column is JSONB and accepts any JSON value.

3. **If the `gapResult` destructuring needs updating** (e.g., if Plan 02 changed the return shape), update accordingly. The key is that `gapResult.gapAnalysis` should be the full `EnhancedGapResult` object that gets stored.

4. Also update the `documentSummary` variable (line 599) if the enhanced agent expects more context:
   ```typescript
   const documentSummary = `${parserResult.document.title}: ${classifierResult.clauses.length} clauses classified across ${[...new Set(classifierResult.clauses.map(c => c.category))].length} categories.`
   ```

This is a minimal change — the pipeline structure doesn't change, just the data flowing through it becomes richer.
  </action>
  <verify>
`pnpm build` succeeds. `grep -n "gapAnalysis.*gapResult" inngest/functions/analyze-nda.ts` confirms the enhanced data flows to persistence.
  </verify>
  <done>
Pipeline's persist-final step stores `EnhancedGapResult` in the `gapAnalysis` JSONB column. The enhanced gap data (two-tier gaps, coverage summary, suggested language, hypothesis coverage) is persisted correctly.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- `db/queries/gap-analysis.ts` exists with `getGapAnalysis` export
- `app/(main)/(dashboard)/analyses/actions.ts` exports `fetchGapAnalysis`
- `inngest/functions/analyze-nda.ts` persist-final step stores enhanced gap data
- Old `getAnalysisGaps` is preserved with @deprecated
- No barrel exports created (per CLAUDE.md)
</verification>

<success_criteria>
Enhanced gap analysis data flows from agent -> Inngest persistence -> JSONB column -> query function -> server action. The UI can call `fetchGapAnalysis(analysisId)` and receive typed `EnhancedGapResult`.
</success_criteria>

<output>
After completion, create `.planning/phases/08-gap-analysis/08-03-SUMMARY.md`
</output>
