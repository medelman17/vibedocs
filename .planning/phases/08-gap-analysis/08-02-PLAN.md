---
phase: 08-gap-analysis
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - agents/gap-analyst.ts
  - agents/prompts/gap-analyst.ts
autonomous: true

must_haves:
  truths:
    - "Gap analyst retrieves NDA-relevant categories from cuadCategories table with fallback to hardcoded list"
    - "Two-tier gap detection: categories with zero classifications are 'missing', weak coverage is 'incomplete'"
    - "Template baselines retrieved via findTemplateBaselines for each gap category"
    - "Single LLM call produces enhanced output with explanations, suggested language, and template attribution"
    - "Coverage summary calculated with present/missing/incomplete counts and percentage"
    - "ContractNLI hypothesis testing preserved unchanged"
  artifacts:
    - path: "agents/gap-analyst.ts"
      provides: "Enhanced runGapAnalystAgent with two-tier detection, template retrieval, coverage summary"
      exports: ["runGapAnalystAgent", "GapAnalystInput", "GapAnalystOutput"]
    - path: "agents/prompts/gap-analyst.ts"
      provides: "Enhanced system and user prompts with template context and style matching instructions"
      exports: ["GAP_ANALYST_SYSTEM_PROMPT", "createGapAnalystPrompt"]
  key_links:
    - from: "agents/gap-analyst.ts"
      to: "agents/tools/vector-search.ts"
      via: "findTemplateBaselines import"
      pattern: "findTemplateBaselines"
    - from: "agents/gap-analyst.ts"
      to: "db/schema/reference.ts"
      via: "cuadCategories table query"
      pattern: "cuadCategories"
    - from: "agents/gap-analyst.ts"
      to: "agents/types.ts"
      via: "Enhanced gap types import"
      pattern: "enhancedGapAnalysisSchema|EnhancedGapResult"
---

<objective>
Enhance the gap analyst agent to produce two-tier gap detection, retrieve Bonterms/CommonAccord template baselines, generate adapted recommended language, and compute coverage summaries.

Purpose: Transform the gap analyst from simple missing-category identification into a rich, actionable analysis with severity tiers, template-grounded language suggestions, and coverage metrics.

Output: Updated `agents/gap-analyst.ts` and `agents/prompts/gap-analyst.ts`.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-gap-analysis/08-01-SUMMARY.md
@agents/gap-analyst.ts
@agents/prompts/gap-analyst.ts
@agents/types.ts
@agents/tools/vector-search.ts
@db/schema/reference.ts
@.planning/phases/08-gap-analysis/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance gap analyst prompts with template context</name>
  <files>agents/prompts/gap-analyst.ts</files>
  <action>
Rewrite `agents/prompts/gap-analyst.ts` to support the enhanced gap analysis:

1. **Keep existing exports**: `CRITICAL_CATEGORIES`, `IMPORTANT_CATEGORIES`, `CONTRACT_NLI_HYPOTHESES` unchanged.

2. **Enhance `GAP_ANALYST_SYSTEM_PROMPT`**: Update to instruct the LLM about:
   - Two-tier gap status (Missing vs Incomplete) with definitions
   - Three severity tiers (critical, important, informational)
   - Template-grounded language suggestions: when template baselines are provided, adapt them to match the NDA's style
   - Source attribution format: always cite the template source (e.g., "Based on Bonterms NDA Section X.Y")
   - Style matching: read existing clauses to match formality, defined terms, numbering conventions
   - Coverage summary: compute total/present/missing/incomplete counts and percentage
   - Output format matching `enhancedGapAnalysisSchema` from `agents/types.ts`

3. **Enhance `createGapAnalystPrompt`**: Update the function signature and body:
   ```typescript
   export function createGapAnalystPrompt(
     documentSummary: string,
     presentCategories: string[],
     classifiedClauses: Array<{ id: string; category: string; text: string }>,
     gaps: Array<{
       category: string
       status: 'missing' | 'incomplete'
       severity: string
       templateContext: Array<{ content: string; source: string }>
     }>,
     sampleClauses: Array<{ category: string; text: string }>
   ): string
   ```

   The prompt should include:
   - Document summary
   - Categories found (present categories)
   - Pre-detected gaps with their status, severity, and template baselines (truncate template content to 300 chars)
   - Sample of existing clauses (first 5, text truncated to 200 chars) for style reference
   - Instruction to produce enhanced gap analysis output matching the schema

   **Important**: Limit to top 10 highest-severity gaps in the prompt to stay within ~12K token budget. Sort by severity (critical first, then important, then informational).

4. **Do NOT change** the hypothesis prompt logic — that stays in `gap-analyst.ts`.
  </action>
  <verify>
`pnpm build` succeeds. The enhanced prompt function accepts the new parameters. `grep -n "createGapAnalystPrompt\|GAP_ANALYST_SYSTEM_PROMPT" agents/prompts/gap-analyst.ts` confirms both exports exist.
  </verify>
  <done>
Enhanced system prompt covers two-tier status, severity tiers, template-grounded suggestions, style matching. Enhanced user prompt includes gap data with template context and sample clauses.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance gap analyst agent with template retrieval and two-tier detection</name>
  <files>agents/gap-analyst.ts</files>
  <action>
Enhance `agents/gap-analyst.ts` with the following changes. Preserve existing structure where possible.

1. **Add imports**:
   ```typescript
   import { findTemplateBaselines } from './tools/vector-search'
   import { db } from '@/db/client'
   import { cuadCategories } from '@/db/schema/reference'
   import { eq } from 'drizzle-orm'
   import {
     type GapSeverity,
     type EnhancedGapResult,
     type EnhancedGapItem,
     type CoverageSummary,
     enhancedGapAnalysisSchema,
     CLASSIFICATION_THRESHOLDS,
   } from './types'
   ```

2. **Add `getNdaRelevantCategories()` function**:
   - Query `cuadCategories` table for `isNdaRelevant = true`
   - Map `riskWeight` to severity: `>= 1.5` -> critical, `>= 1.0` -> important, `< 1.0` -> informational
   - **Fallback**: If table is empty (bootstrap not run), use `CRITICAL_CATEGORIES` (severity=critical) + `IMPORTANT_CATEGORIES` (severity=important) from prompts, returning a hardcoded list. Log a warning via `console.warn('[GapAnalyst] cuadCategories table empty, using fallback list')`.

3. **Add `detectGapStatus()` function**:
   ```typescript
   function detectGapStatus(
     categoryName: string,
     clauses: ClassifiedClause[],
     assessments: RiskAssessmentResult[]
   ): 'present' | 'incomplete' | 'missing'
   ```
   Logic:
   - Filter `clauses` where `c.category === categoryName` (primary match)
   - If zero matches, return `'missing'`
   - Check if any match has confidence >= `CLASSIFICATION_THRESHOLDS.LOW_CONFIDENCE` (0.7)
   - If no match meets threshold, return `'incomplete'`
   - Check risk assessments for this category — if all are 'aggressive' or 'unknown', return `'incomplete'`
   - Otherwise return `'present'`

4. **Update `GapAnalystOutput` interface**:
   Change `gapAnalysis` field type to use `EnhancedGapResult` (imported from types.ts). Keep `hypothesisCoverage` and `tokenUsage` as-is.

5. **Rewrite `runGapAnalystAgent` core logic** (preserve hypothesis testing loop unchanged):

   a. **Get NDA-relevant categories**: Call `getNdaRelevantCategories()`
   b. **Detect gaps**: For each NDA-relevant category, call `detectGapStatus()`. Collect missing and incomplete categories.
   c. **Retrieve template baselines**: For each gap (missing/incomplete), call `findTemplateBaselines(category, { limit: 2 })`. Wrap in try/catch — if template retrieval fails, continue with empty templates.
   d. **Build enhanced prompt**: Call `createGapAnalystPrompt(documentSummary, presentCategories, classifiedClauses, gaps, sampleClauses)` with the gaps and sample clauses (first 5 clauses by text, for style matching).
   e. **LLM call**: Use `enhancedGapAnalysisSchema` instead of the old `gapAnalysisSchema`.
   f. **Compute coverage summary** (if LLM doesn't provide it accurately, compute it from detected data):
      ```typescript
      const coverageSummary: CoverageSummary = {
        totalCategories: ndaCategories.length,
        presentCount: ndaCategories.length - gaps.length,
        missingCount: gaps.filter(g => g.status === 'missing').length,
        incompleteCount: gaps.filter(g => g.status === 'incomplete').length,
        coveragePercent: Math.round(((ndaCategories.length - gaps.filter(g => g.status === 'missing').length) / ndaCategories.length) * 100),
      }
      ```
   g. **Calculate gap score**: Update `calculateGapScore` to use `severity` instead of `importance` (critical/important/informational mapping to same weights as critical/important/optional).
   h. **Return enhanced output**: Merge LLM-generated explanations/language with pre-computed severity and status.

6. **Update `GAP_SCORE_WEIGHTS`**: Rename `MISSING_OPTIONAL` to `MISSING_INFORMATIONAL` (value stays 3). Add comment noting the mapping.

7. **Update `calculateGapScore`**: Accept the new gap structure. Map severity 'informational' to the `MISSING_INFORMATIONAL` weight. Keep hypothesis scoring unchanged.

**Important constraints**:
- Keep ContractNLI hypothesis loop identical (lines 191-226 in current file).
- Do NOT create a barrel export for this file.
- Use `try/catch` around `findTemplateBaselines` calls — template retrieval is best-effort, not required.
- Do NOT make gap severity perspective-aware (per RESEARCH.md recommendation).
  </action>
  <verify>
`pnpm build` succeeds. `grep -n "getNdaRelevantCategories\|detectGapStatus\|findTemplateBaselines\|enhancedGapAnalysisSchema" agents/gap-analyst.ts` confirms all new functions and imports exist. `pnpm test agents/gap-analyst` runs (tests may need updating in Plan 03 but should at least not crash).
  </verify>
  <done>
`runGapAnalystAgent` produces `EnhancedGapResult` with two-tier gaps, severity tiers, template-grounded suggested language, coverage summary, and hypothesis coverage. Template retrieval is best-effort with graceful fallback.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- `agents/gap-analyst.ts` imports and uses `findTemplateBaselines`, `cuadCategories`, `enhancedGapAnalysisSchema`
- `agents/prompts/gap-analyst.ts` exports enhanced prompt with template context support
- `getNdaRelevantCategories()` queries DB with fallback
- `detectGapStatus()` implements two-tier detection logic
- ContractNLI hypothesis testing is unchanged
</verification>

<success_criteria>
Enhanced gap analyst agent produces `EnhancedGapResult` with two-tier gap detection, Bonterms-grounded suggested language, coverage summary, and severity tiers. Template retrieval is graceful (fallback on failure). Output matches `enhancedGapAnalysisSchema` from types.ts.
</success_criteria>

<output>
After completion, create `.planning/phases/08-gap-analysis/08-02-SUMMARY.md`
</output>
