---
phase: 08-gap-analysis
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - agents/gap-analyst.ts
  - agents/prompts/gap-analyst.ts
autonomous: true

must_haves:
  truths:
    - "Gap analyst retrieves NDA-relevant categories from cuadCategories table with fallback to hardcoded list"
    - "Two-tier gap detection: categories with zero classifications are 'missing', weak coverage is 'incomplete'"
    - "Severity determined by Bonterms template presence: categories covered in Bonterms baselines are critical/important, categories absent from Bonterms are informational"
    - "Template baselines retrieved via findTemplateBaselines using category description text as the search query"
    - "Single LLM call produces enhanced output with explanations, suggested language, and template attribution"
    - "Coverage summary calculated with present/missing/incomplete counts and percentage"
    - "ContractNLI hypothesis testing preserved unchanged"
  artifacts:
    - path: "agents/gap-analyst.ts"
      provides: "Enhanced runGapAnalystAgent with two-tier detection, Bonterms-presence severity, template retrieval, coverage summary"
      exports: ["runGapAnalystAgent", "GapAnalystInput", "GapAnalystOutput"]
    - path: "agents/prompts/gap-analyst.ts"
      provides: "Enhanced system and user prompts with template context and style matching instructions"
      exports: ["GAP_ANALYST_SYSTEM_PROMPT", "createGapAnalystPrompt"]
  key_links:
    - from: "agents/gap-analyst.ts"
      to: "agents/tools/vector-search.ts"
      via: "findTemplateBaselines import, called with category description text"
      pattern: "findTemplateBaselines"
    - from: "agents/gap-analyst.ts"
      to: "db/schema/reference.ts"
      via: "cuadCategories table query for NDA-relevant categories with descriptions"
      pattern: "cuadCategories"
    - from: "agents/gap-analyst.ts"
      to: "agents/types.ts"
      via: "Enhanced gap types import"
      pattern: "enhancedGapAnalysisSchema|EnhancedGapResult"
    - from: "agents/gap-analyst.ts"
      to: "agents/prompts/gap-analyst.ts"
      via: "createGapAnalystPrompt called with new signature including gaps and sampleClauses"
      pattern: "createGapAnalystPrompt"
---

<objective>
Enhance the gap analyst agent to produce two-tier gap detection, retrieve Bonterms/CommonAccord template baselines, generate adapted recommended language, and compute coverage summaries. Severity is determined by Bonterms template presence (locked decision #3): categories covered in Bonterms baselines are critical/important, categories absent are informational.

Purpose: Transform the gap analyst from simple missing-category identification into a rich, actionable analysis with severity tiers, template-grounded language suggestions, and coverage metrics.

Output: Updated `agents/gap-analyst.ts` and `agents/prompts/gap-analyst.ts`.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-gap-analysis/08-01-SUMMARY.md
@agents/gap-analyst.ts
@agents/prompts/gap-analyst.ts
@agents/types.ts
@agents/tools/vector-search.ts
@db/schema/reference.ts
@.planning/phases/08-gap-analysis/08-RESEARCH.md
@.planning/phases/08-gap-analysis/08-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance gap analyst prompts with template context</name>
  <files>agents/prompts/gap-analyst.ts</files>
  <action>
Rewrite `agents/prompts/gap-analyst.ts` to support the enhanced gap analysis:

1. **Keep existing exports**: `CRITICAL_CATEGORIES`, `IMPORTANT_CATEGORIES`, `CONTRACT_NLI_HYPOTHESES` unchanged.

2. **Enhance `GAP_ANALYST_SYSTEM_PROMPT`**: Update to instruct the LLM about:
   - Two-tier gap status (Missing vs Incomplete) with definitions
   - Three severity tiers (critical, important, informational)
   - Template-grounded language suggestions: when template baselines are provided, adapt them to match the NDA's style
   - Source attribution format: always cite the template source (e.g., "Based on Bonterms NDA Section X.Y")
   - Style matching: read existing clauses to match formality, defined terms, numbering conventions
   - Coverage summary: compute total/present/missing/incomplete counts and percentage
   - Output format matching `enhancedGapAnalysisSchema` from `agents/types.ts`

3. **Enhance `createGapAnalystPrompt`**: Update the function signature and body:
   ```typescript
   export function createGapAnalystPrompt(
     documentSummary: string,
     presentCategories: string[],
     classifiedClauses: Array<{ id: string; category: string; text: string }>,
     gaps: Array<{
       category: string
       status: 'missing' | 'incomplete'
       severity: string
       templateContext: Array<{ content: string; source: string }>
     }>,
     sampleClauses: Array<{ category: string; text: string }>
   ): string
   ```

   The prompt should include:
   - Document summary
   - Categories found (present categories)
   - Pre-detected gaps with their status, severity, and template baselines (truncate template content to 300 chars)
   - Sample of existing clauses (first 5, text truncated to 200 chars) for style reference
   - Instruction to produce enhanced gap analysis output matching the schema

   **Important**: Limit to top 10 highest-severity gaps in the prompt to stay within ~12K token budget. Sort by severity (critical first, then important, then informational).

4. **Do NOT change** the hypothesis prompt logic -- that stays in `gap-analyst.ts`.
  </action>
  <verify>
`pnpm build` succeeds. The enhanced prompt function accepts the new parameters:

1. `grep -n "createGapAnalystPrompt\|GAP_ANALYST_SYSTEM_PROMPT" agents/prompts/gap-analyst.ts` confirms both exports exist.
2. `grep -n "templateContext\|sampleClauses\|gaps:" agents/prompts/gap-analyst.ts` confirms the new parameters appear in the function signature and body.
3. `grep -n "createGapAnalystPrompt" agents/gap-analyst.ts` confirms the enhanced prompt function is called from the agent (this verifies the wiring exists -- if the agent file hasn't been updated yet, this is expected to show the old call, which Task 2 will update).
  </verify>
  <done>
Enhanced system prompt covers two-tier status, severity tiers, template-grounded suggestions, style matching. Enhanced user prompt function accepts gap data with template context and sample clauses via the new signature.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add gap detection, Bonterms-presence severity, and helper functions</name>
  <files>agents/gap-analyst.ts</files>
  <action>
Add the detection and severity infrastructure to `agents/gap-analyst.ts`. This task adds the helper functions; Task 3 wires them into `runGapAnalystAgent`.

1. **Add imports**:
   ```typescript
   import { findTemplateBaselines } from './tools/vector-search'
   import { db } from '@/db/client'
   import { cuadCategories } from '@/db/schema/reference'
   import { eq } from 'drizzle-orm'
   import {
     type GapSeverity,
     type EnhancedGapResult,
     type EnhancedGapItem,
     type CoverageSummary,
     enhancedGapAnalysisSchema,
     CLASSIFICATION_THRESHOLDS,
   } from './types'
   ```

2. **Add `getNdaRelevantCategories()` function**:
   - Query `cuadCategories` table for `isNdaRelevant = true`, selecting `name`, `description`, and `riskWeight`
   - **Do NOT map riskWeight to severity here** -- severity is determined in a separate step using Bonterms presence (see step 3)
   - Return `Array<{ name: string; description: string | null; riskWeight: number }>`
   - **Fallback**: If table is empty (bootstrap not run), use `CRITICAL_CATEGORIES` (with `riskWeight: 1.5`) + `IMPORTANT_CATEGORIES` (with `riskWeight: 1.0`) from prompts, returning a hardcoded list with `description: null`. Log a warning via `console.warn('[GapAnalyst] cuadCategories table empty, using fallback list')`.

3. **Add `determineSeverity()` function** (implements locked decision #3):
   ```typescript
   /**
    * Determines gap severity based on Bonterms template presence.
    * Locked decision: "Bonterms presence sets the severity tier,
    * LLM provides the explanation for why it matters."
    *
    * - Category has Bonterms template baselines AND riskWeight >= 1.5 -> critical
    * - Category has Bonterms template baselines AND riskWeight < 1.5 -> important
    * - Category has NO Bonterms template baselines -> informational
    */
   function determineSeverity(
     hasBontermsBaselines: boolean,
     riskWeight: number
   ): GapSeverity
   ```
   Logic:
   - If `hasBontermsBaselines` is true AND `riskWeight >= 1.5`: return `'critical'`
   - If `hasBontermsBaselines` is true AND `riskWeight < 1.5`: return `'important'`
   - If `hasBontermsBaselines` is false: return `'informational'`

   This honors the locked decision: Bonterms presence is the primary severity determinant. `riskWeight` only differentiates within the Bonterms-covered tier.

4. **Add `detectGapStatus()` function**:
   ```typescript
   function detectGapStatus(
     categoryName: string,
     clauses: ClassifiedClause[],
     assessments: RiskAssessmentResult[]
   ): 'present' | 'incomplete' | 'missing'
   ```
   Logic:
   - Filter `clauses` where `c.category === categoryName` (primary match)
   - If zero matches, return `'missing'`
   - Check if any match has confidence >= `CLASSIFICATION_THRESHOLDS.LOW_CONFIDENCE` (0.7)
   - If no match meets threshold, return `'incomplete'`
   - Check risk assessments for this category -- if all are 'aggressive' or 'unknown', return `'incomplete'`
   - Otherwise return `'present'`

5. **Update `GapAnalystOutput` interface**:
   Change `gapAnalysis` field type to use `EnhancedGapResult` (imported from types.ts). Keep `hypothesisCoverage` and `tokenUsage` as-is.

6. **Update `GAP_SCORE_WEIGHTS`**: Rename `MISSING_OPTIONAL` to `MISSING_INFORMATIONAL` (value stays 3). Add comment noting the mapping.

7. **Update `calculateGapScore`**: Accept the new gap structure. Map severity 'informational' to the `MISSING_INFORMATIONAL` weight. Keep hypothesis scoring unchanged.
  </action>
  <verify>
`pnpm build` succeeds. `grep -n "getNdaRelevantCategories\|detectGapStatus\|determineSeverity\|MISSING_INFORMATIONAL" agents/gap-analyst.ts` confirms all new functions and constants exist. `grep -n "hasBontermsBaselines" agents/gap-analyst.ts` confirms severity uses Bonterms presence.
  </verify>
  <done>
Helper functions `getNdaRelevantCategories()`, `detectGapStatus()`, and `determineSeverity()` are defined. Severity is determined by Bonterms template presence (locked decision #3). `GapAnalystOutput` uses `EnhancedGapResult`. `calculateGapScore` updated for new severity tiers.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire template retrieval and enhanced output into runGapAnalystAgent</name>
  <files>agents/gap-analyst.ts</files>
  <action>
Rewrite `runGapAnalystAgent` core logic to use the helper functions from Task 2. Preserve hypothesis testing loop unchanged.

1. **Get NDA-relevant categories**: Call `getNdaRelevantCategories()` to get categories with their descriptions.

2. **Detect gaps and retrieve templates**: For each NDA-relevant category, call `detectGapStatus()`. For categories that are 'missing' or 'incomplete':
   a. **Retrieve template baselines**: Call `findTemplateBaselines(searchText, { limit: 2 })` where `searchText` is:
      - The category's `description` from `cuadCategories` if available (e.g., "Does the contract contain a non-compete clause?")
      - If `description` is null (fallback mode), use the category name itself (e.g., "Non-Compete")

      **Why `description` not `name`**: `findTemplateBaselines` expects `clauseText: string` -- it embeds the text via Voyage AI and searches by vector similarity against template embeddings. A descriptive sentence produces much better embeddings than a short category name. The `cuadCategories.description` field contains descriptive text like "Does the contract contain a non-compete clause?" which is ideal for embedding.

   b. **Determine severity**: Call `determineSeverity(templates.length > 0, cat.riskWeight)` -- if `findTemplateBaselines` returned results, this category has Bonterms coverage. Wrap the `findTemplateBaselines` call in try/catch -- if it fails, treat as `hasBontermsBaselines = false` and continue with empty templates.

   c. Collect gap data: `{ category, status, severity, templateContext: templates }`

3. **Build enhanced prompt**: Call `createGapAnalystPrompt(documentSummary, presentCategories, classifiedClauses, gaps, sampleClauses)` with:
   - `classifiedClauses`: map from input clauses to `{ id, category, text }` format
   - `gaps`: the detected gaps with severity and template context
   - `sampleClauses`: first 5 classified clauses for style reference

4. **LLM call**: Use `enhancedGapAnalysisSchema` instead of the old `gapAnalysisSchema`.

5. **Compute coverage summary** (from pre-computed detection data, not LLM output):
   ```typescript
   const coverageSummary: CoverageSummary = {
     totalCategories: ndaCategories.length,
     presentCount: ndaCategories.length - gaps.length,
     missingCount: gaps.filter(g => g.status === 'missing').length,
     incompleteCount: gaps.filter(g => g.status === 'incomplete').length,
     coveragePercent: Math.round(((ndaCategories.length - gaps.filter(g => g.status === 'missing').length) / ndaCategories.length) * 100),
   }
   ```

6. **Calculate gap score**: Call updated `calculateGapScore` with the new gap structure.

7. **Return enhanced output**: Merge LLM-generated explanations/language with pre-computed severity, status, and coverage summary. The returned `gapAnalysis` field should be a full `EnhancedGapResult`.

**Important constraints**:
- Keep ContractNLI hypothesis loop identical (lines 191-226 in current file).
- Do NOT create a barrel export for this file.
- Use `try/catch` around `findTemplateBaselines` calls -- template retrieval is best-effort, not required.
- Do NOT make gap severity perspective-aware (per RESEARCH.md recommendation).
  </action>
  <verify>
`pnpm build` succeeds. Verify the full wiring:
1. `grep -n "findTemplateBaselines" agents/gap-analyst.ts` confirms template retrieval calls exist.
2. `grep -n "createGapAnalystPrompt" agents/gap-analyst.ts` confirms the enhanced prompt function is called with the new signature.
3. `grep -n "enhancedGapAnalysisSchema" agents/gap-analyst.ts` confirms the new schema is used in the LLM call.
4. `grep -n "determineSeverity" agents/gap-analyst.ts` confirms severity uses Bonterms presence in the main flow.
5. `grep -n "description" agents/gap-analyst.ts` confirms category description is used as search text for findTemplateBaselines.
6. `pnpm test agents/gap-analyst` runs (tests may need updating in Plan 03 but should at least not crash).
  </verify>
  <done>
`runGapAnalystAgent` produces `EnhancedGapResult` with two-tier gaps, Bonterms-presence severity, template-grounded suggested language (using category description as search text), coverage summary, and hypothesis coverage. Template retrieval is best-effort with graceful fallback.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- `agents/gap-analyst.ts` imports and uses `findTemplateBaselines`, `cuadCategories`, `enhancedGapAnalysisSchema`
- `agents/gap-analyst.ts` calls `findTemplateBaselines` with category `description` text (not raw category name)
- `agents/gap-analyst.ts` determines severity via `determineSeverity(hasBontermsBaselines, riskWeight)` -- Bonterms presence is the primary input
- `agents/gap-analyst.ts` calls `createGapAnalystPrompt` with the enhanced signature (gaps, sampleClauses, templateContext)
- `agents/prompts/gap-analyst.ts` exports enhanced prompt with template context support
- `getNdaRelevantCategories()` queries DB with fallback
- `detectGapStatus()` implements two-tier detection logic
- ContractNLI hypothesis testing is unchanged
</verification>

<success_criteria>
Enhanced gap analyst agent produces `EnhancedGapResult` with two-tier gap detection, Bonterms-presence severity (locked decision #3), template-grounded suggested language, coverage summary, and severity tiers. Template retrieval uses category description as search text for better vector similarity. Output matches `enhancedGapAnalysisSchema` from types.ts.
</success_criteria>

<output>
After completion, create `.planning/phases/08-gap-analysis/08-02-SUMMARY.md`
</output>
