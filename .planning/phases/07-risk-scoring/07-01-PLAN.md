---
phase: 07-risk-scoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - agents/types.ts
  - agents/risk-scorer.ts
autonomous: true

must_haves:
  truths:
    - "Risk assessment schema includes structured citations with sourceId and source label"
    - "Risk assessment schema supports perspective parameter (receiving/disclosing/balanced)"
    - "Risk assessment schema includes atypicalLanguage flag and negotiation suggestion"
    - "RiskScorerInput accepts perspective parameter"
  artifacts:
    - path: "agents/types.ts"
      provides: "Enhanced riskAssessmentSchema with structured evidence"
      contains: "enhancedRiskAssessmentSchema"
    - path: "agents/risk-scorer.ts"
      provides: "Updated input/output types with perspective and enhanced evidence"
      contains: "perspective"
  key_links:
    - from: "agents/risk-scorer.ts"
      to: "agents/types.ts"
      via: "import enhancedRiskAssessmentSchema"
      pattern: "enhancedRiskAssessmentSchema"
---

<objective>
Define enhanced risk assessment schemas and update agent types to support perspective-aware scoring with structured citations.

Purpose: All downstream work (prompt, pipeline, UI) depends on these type definitions. Getting the schema right first prevents rework.
Output: Updated `agents/types.ts` with enhanced Zod schema and updated `agents/risk-scorer.ts` with new input/output types.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-risk-scoring/07-CONTEXT.md
@.planning/phases/07-risk-scoring/07-RESEARCH.md
@agents/types.ts
@agents/risk-scorer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add enhanced risk assessment schema to agents/types.ts</name>
  <files>agents/types.ts</files>
  <action>
Add the following to `agents/types.ts` AFTER the existing `riskAssessmentSchema`:

1. Define `perspectiveSchema`:
```typescript
export const PERSPECTIVES = ['receiving', 'disclosing', 'balanced'] as const
export type Perspective = (typeof PERSPECTIVES)[number]
export const perspectiveSchema = z.enum(PERSPECTIVES)
```

2. Define `enhancedRiskAssessmentSchema` -- the new output schema for the risk scorer LLM call:
```typescript
export const enhancedRiskAssessmentSchema = z.object({
  riskLevel: riskLevelSchema,
  confidence: z.number().min(0).max(1),
  explanation: z.string().max(500).describe('Risk-first plain-language explanation (2-3 sentences)'),
  negotiationSuggestion: z.string().max(200).optional().describe('Concrete negotiation suggestion for non-standard clauses'),
  atypicalLanguage: z.boolean().describe('True if wording is unusual even when substance is standard'),
  atypicalLanguageNote: z.string().max(200).optional().describe('Note about unusual wording'),
  evidence: z.object({
    citations: z.array(z.object({
      text: z.string().max(300).describe('Quoted text from the clause'),
      sourceType: z.enum(['clause', 'reference', 'template']),
    })).min(1).max(5),
    references: z.array(z.object({
      sourceId: z.string().describe('ID from reference corpus'),
      source: z.enum(['cuad', 'contract_nli', 'bonterms', 'commonaccord']),
      section: z.string().optional(),
      similarity: z.number().min(0).max(1),
      summary: z.string().max(200).describe('Brief summary of the reference'),
    })).max(5),
    baselineComparison: z.string().max(300).optional().describe('Comparison to Bonterms/standard baseline when template match available'),
  }),
})
```

3. Define corresponding TypeScript interface:
```typescript
export type EnhancedRiskAssessment = z.infer<typeof enhancedRiskAssessmentSchema>
```

Keep the existing `riskAssessmentSchema` and `RiskAssessment` interface for backward compatibility -- they are still used by tests and the gap analyst.

4. Update the schema comments on `clauseExtractions` risk-related fields in the docblocks to note the correct PRD risk levels (standard/cautious/aggressive/unknown) instead of the stale low/medium/high/critical. Do NOT change the actual schema columns -- they are text type and work fine. Only update the JSDoc comments in the existing `RiskAssessment` interface if the comments reference old risk levels.
  </action>
  <verify>Run `pnpm build` -- TypeScript compilation succeeds with no errors related to the new types.</verify>
  <done>
    - `enhancedRiskAssessmentSchema` exists in agents/types.ts with structured citations, perspective, atypical language, and negotiation suggestion fields
    - `perspectiveSchema` and `Perspective` type exported
    - Existing `riskAssessmentSchema` preserved for backward compatibility
  </done>
</task>

<task type="auto">
  <name>Task 2: Update risk scorer input/output types</name>
  <files>agents/risk-scorer.ts</files>
  <action>
Update `agents/risk-scorer.ts` type definitions (NOT the implementation logic -- that comes in Plan 02):

1. Update `RiskScorerInput` to accept perspective:
```typescript
export interface RiskScorerInput {
  clauses: ClassifiedClause[]
  budgetTracker: BudgetTracker
  perspective?: Perspective  // Default: 'balanced'
}
```

2. Update `RiskAssessmentResult` to use enhanced evidence structure:
```typescript
export interface RiskAssessmentResult {
  clauseId: string
  clause: ClassifiedClause
  riskLevel: RiskLevel
  confidence: number
  explanation: string
  negotiationSuggestion?: string
  atypicalLanguage: boolean
  atypicalLanguageNote?: string
  evidence: {
    citations: Array<{ text: string; sourceType: 'clause' | 'reference' | 'template' }>
    references: Array<{
      sourceId: string
      source: 'cuad' | 'contract_nli' | 'bonterms' | 'commonaccord'
      section?: string
      similarity: number
      summary: string
    }>
    baselineComparison?: string
  }
  startPosition: number
  endPosition: number
}
```

3. Update `RiskScorerOutput` to include perspective and summary:
```typescript
export interface RiskScorerOutput {
  assessments: RiskAssessmentResult[]
  overallRiskScore: number
  overallRiskLevel: RiskLevel
  perspective: Perspective
  executiveSummary: string
  riskDistribution: Record<RiskLevel, number>
  tokenUsage: { inputTokens: number; outputTokens: number }
}
```

4. Add the `Perspective` import from types.ts:
```typescript
import type { Perspective } from './types'
```

5. Update the function signature to use the new input type, but keep the implementation temporarily returning stubbed values for the new fields so the file still compiles. Specifically:
   - In the `assessments.push()` call, add `atypicalLanguage: false` and restructure evidence to match the new shape (wrap existing `citations` as `[{ text: c, sourceType: 'clause' as const }]` etc.)
   - After `calculateOverallRisk`, compute `riskDistribution` by counting assessments per risk level
   - Set `perspective: input.perspective ?? 'balanced'`
   - Set `executiveSummary: ''` (placeholder, will be filled in Plan 03)

This ensures the codebase compiles at every step while the real implementation comes in Plan 02.
  </action>
  <verify>Run `pnpm build` -- TypeScript compilation succeeds. The risk scorer function signature matches the new types.</verify>
  <done>
    - `RiskScorerInput` accepts optional `perspective` parameter
    - `RiskAssessmentResult` has structured citation evidence with sourceId/source/similarity fields
    - `RiskAssessmentResult` has atypicalLanguage, negotiationSuggestion fields
    - `RiskScorerOutput` includes perspective, executiveSummary, riskDistribution
    - File compiles with stub values for new fields
  </done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds with zero TypeScript errors
- `pnpm lint` passes
- `agents/types.ts` exports `enhancedRiskAssessmentSchema`, `Perspective`, `perspectiveSchema`
- `agents/risk-scorer.ts` exports updated `RiskScorerInput`, `RiskAssessmentResult`, `RiskScorerOutput`
- Existing tests still pass (`pnpm test -- --run agents/`)
</verification>

<success_criteria>
- Enhanced risk assessment schema defined with structured citations, perspective, atypical language, and negotiation suggestion
- Risk scorer input accepts perspective parameter
- Risk scorer output includes perspective, executive summary, and risk distribution
- All existing code compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-risk-scoring/07-01-SUMMARY.md`
</output>
