name: Claude Code Review

on:
  workflow_run:
    workflows: ["Test"]
    types: [completed]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

jobs:
  claude-review:
    # Only run if tests passed and this was a PR
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 1

      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pulls = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`,
              state: 'open'
            });
            if (pulls.data.length > 0) {
              return pulls.data[0].number;
            }
            return null;
          result-encoding: string

      - name: Check for TypeScript changes
        id: changes
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr.outputs.result }}
            });
            const patterns = [
              /^src\/.*\.tsx?$/,
              /^app\/.*\.tsx?$/,
              /^components\/.*\.tsx?$/
            ];
            const hasChanges = files.data.some(f =>
              patterns.some(p => p.test(f.filename))
            );
            return hasChanges;
          result-encoding: string

      - name: Run Claude Code Review
        if: steps.pr.outputs.result != 'null' && steps.changes.outputs.result == 'true'
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          plugin_marketplaces: 'https://github.com/anthropics/claude-code.git'
          plugins: 'code-review@claude-code-plugins'
          prompt: '/code-review:code-review ${{ github.repository }}/pull/${{ steps.pr.outputs.result }}'
